# T230: Integrate URL Loader into Sync Pipeline

> **Priority**: P2 | **Wave**: 9 | **Track**: A (Remote Content)
> **Depends on**: T060-T069 âœ… (URL loader implementation exists)
> **Estimated complexity**: Medium

## 1. Objective

Integrate the existing URL loader into the sync pipeline so users can declaratively fetch rules, personas, commands, and hooks from remote URLs via `config.yaml`. While the URL loader implementation exists (`src/loaders/url.ts`), it's not connected to the sync commandâ€”users can't actually use `type: url` loaders. This task adds:

1. URL loader invocation in the sync command
2. Schema support for URL-specific options (headers, timeout, cache TTL)
3. Configuration validation for URL sources

This enables teams to share AI rules across projects via HTTP endpoints, private registries with authentication, or public GitHub raw URLs.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:

- `src/cli/commands/sync.ts` - **Lines 265-288**: `loadContent()` with loader type dispatch (add URL case here)
- `src/loaders/url.ts` - **Lines 76-113**: `UrlLoaderOptions` interface with all available options
- `src/loaders/url.ts` - **Lines 123-192**: `UrlLoader.load()` method signature and usage
- `src/loaders/local.ts` - **Lines 30-95**: Pattern for loader invocation in sync
- `src/config/types.ts` - **Lines 58-64**: `LoaderConfig` type to extend
- `src/schemas/config.schema.json` - **Lines 157-179**: Loader schema definition to extend
- `tests/unit/loaders/url.test.ts` - Test patterns for URL loader

## 3. File Structure

```
src/
â”œâ”€â”€ cli/
â”‚   â””â”€â”€ commands/
â”‚       â””â”€â”€ sync.ts               # Add URL loader invocation
â”œâ”€â”€ config/
â”‚   â””â”€â”€ types.ts                  # Extend LoaderConfig with URL options
â””â”€â”€ schemas/
    â””â”€â”€ config.schema.json        # Add URL-specific loader properties
tests/
â””â”€â”€ unit/
    â””â”€â”€ cli/
        â””â”€â”€ commands/
            â””â”€â”€ sync.test.ts      # Add URL loader integration tests
    â””â”€â”€ integration/
        â””â”€â”€ url-loader.test.ts    # End-to-end URL loading tests
```

## 4. Interfaces & Types

### 4.1 Extend LoaderConfig (in `src/config/types.ts`)

```typescript
/**
 * Loader configuration
 */
export interface LoaderConfig {
  type: 'ai-tool-sync' | 'local' | 'npm' | 'pip' | 'claude-plugin' | 'url';
  source?: string;
  package?: string;
  version?: string;
  
  // URL-specific options (only used when type: 'url')
  /** Request timeout in milliseconds (default: 30000) */
  timeout?: number;
  /** Cache TTL in milliseconds (default: 3600000 = 1 hour, 0 to disable) */
  cacheTtl?: number;
  /** Authentication headers for protected endpoints */
  headers?: Record<string, string>;
  /** Whether to use cached content (default: true) */
  useCache?: boolean;
}
```

### 4.2 Config.yaml Example Usage

```yaml
version: 1.0.0
project_name: my-project

loaders:
  # Load from public GitHub raw URL
  - type: url
    source: https://raw.githubusercontent.com/company/ai-rules/main/
  
  # Load from private registry with auth
  - type: url
    source: https://rules.internal.company.com/ai-config/
    headers:
      Authorization: "Bearer ${AI_RULES_TOKEN}"
    timeout: 10000
    cacheTtl: 3600000
  
  # Load single rule file
  - type: url
    source: https://example.com/shared-rules/typescript.md
    useCache: false  # Always fetch fresh
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use `Result<T, E>` for errors (see `src/utils/result.ts`)
- [x] Use existing `UrlLoader` class from `src/loaders/url.ts`
- [x] Validate URL-specific config options with JSON schema
- [x] Export new types from `src/config/types.ts` barrel
- [x] No `any` types
- [x] Run `npm run lint --fix` after implementation
- [x] Run `npm run typecheck` after implementation

### 5.2 Critical Logic (Pitfall Prevention)

#### 5.2.1 Add URL Loader to Sync Command

```typescript
// In src/cli/commands/sync.ts - loadContent() function

import { createUrlLoader } from '../../loaders/url.js';

// Inside the loader config loop (around line 279):
} else if (loaderConfig.type === 'url' && loaderConfig.source) {
  const urlLoader = createUrlLoader();
  logger.debug(`Loading from URL: ${loaderConfig.source}`);
  
  const urlResult = await urlLoader.load(loaderConfig.source, {
    basePath: config.projectRoot,
    targets: config.targets as Array<'cursor' | 'claude' | 'factory'>,
    // Pass URL-specific options
    ...(loaderConfig.timeout !== undefined && { timeout: loaderConfig.timeout }),
    ...(loaderConfig.cacheTtl !== undefined && { cacheTtl: loaderConfig.cacheTtl }),
    ...(loaderConfig.headers !== undefined && { headers: loaderConfig.headers }),
    ...(loaderConfig.useCache !== undefined && { useCache: loaderConfig.useCache }),
  });
  results.push(urlResult);
}
```

#### 5.2.2 Expand Environment Variables in Headers

```typescript
// âŒ WRONG - Headers with env vars not expanded
headers: {
  Authorization: "Bearer ${AI_RULES_TOKEN}"  // Literal string
}

// âœ… CORRECT - Expand environment variables before passing to loader
function expandEnvVars(value: string): string {
  return value.replace(/\$\{([^}]+)\}/g, (_, name) => process.env[name] ?? '');
}

// When building options:
const expandedHeaders = loaderConfig.headers 
  ? Object.fromEntries(
      Object.entries(loaderConfig.headers).map(([k, v]) => [k, expandEnvVars(v)])
    )
  : undefined;
```

#### 5.2.3 Update JSON Schema for URL Loader Options

```json
// In src/schemas/config.schema.json - extend #/$defs/loader
{
  "type": "object",
  "required": ["type"],
  "properties": {
    "type": { ... },
    "source": { ... },
    "package": { ... },
    "version": { ... },
    "timeout": {
      "type": "integer",
      "minimum": 1000,
      "maximum": 300000,
      "description": "Request timeout in milliseconds (default: 30000)"
    },
    "cacheTtl": {
      "type": "integer",
      "minimum": 0,
      "description": "Cache TTL in milliseconds (default: 3600000, 0 to disable)"
    },
    "headers": {
      "type": "object",
      "description": "Authentication headers for protected endpoints",
      "additionalProperties": { "type": "string" }
    },
    "useCache": {
      "type": "boolean",
      "description": "Whether to use cached content (default: true)"
    }
  }
}
```

### 5.3 Edge Cases to Handle

- [ ] Empty URL source â†’ Return error with descriptive message
- [ ] Invalid URL format â†’ Return `LoadError` with URL validation message  
- [ ] Network timeout â†’ Return `LoadError` with timeout message
- [ ] 401/403 response â†’ Return `LoadError` suggesting auth header needed
- [ ] 404 response â†’ Return `LoadError` (URL not found)
- [ ] Empty response body â†’ Return empty `LoadResult` (no content)
- [ ] Headers with unexpanded env vars â†’ Log warning, pass empty string
- [ ] Cache disabled (`cacheTtl: 0`) â†’ Always fetch fresh
- [ ] Mixed content (directory URL with index.json) â†’ Load all content types

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/cli/commands/sync.test.ts - ADD to existing tests

describe('sync with URL loaders', () => {
  describe('URL loader configuration', () => { /* ... */ });
  describe('authentication headers', () => { /* ... */ });
  describe('error handling', () => { /* ... */ });
});
```

### 6.2 Required Test Cases

```typescript
// Test: URL loader invoked with correct options
it('should invoke URL loader with config options', async () => {
  const mockUrlLoader = vi.fn().mockResolvedValue(emptyLoadResult());
  vi.mock('../../loaders/url.js', () => ({
    createUrlLoader: () => ({ load: mockUrlLoader, canLoad: () => true, name: 'url' }),
  }));

  await sync({
    projectRoot: testDir,
    // config.yaml has: type: url, source: https://example.com/, timeout: 5000
  });

  expect(mockUrlLoader).toHaveBeenCalledWith(
    'https://example.com/',
    expect.objectContaining({
      timeout: 5000,
      targets: ['cursor', 'claude', 'factory'],
    })
  );
});

// Test: Environment variable expansion in headers
it('should expand environment variables in headers', async () => {
  process.env.TEST_TOKEN = 'secret123';
  
  // config.yaml has: headers: { Authorization: "Bearer ${TEST_TOKEN}" }
  await sync({ projectRoot: testDir });

  expect(mockUrlLoader).toHaveBeenCalledWith(
    expect.any(String),
    expect.objectContaining({
      headers: { Authorization: 'Bearer secret123' },
    })
  );
  
  delete process.env.TEST_TOKEN;
});

// Test: URL loader errors are surfaced
it('should surface URL loader errors as warnings', async () => {
  mockFetch.mockRejectedValueOnce(new Error('Network error'));

  const result = await sync({ projectRoot: testDir });

  expect(result.warnings.some(w => w.includes('Network error'))).toBe(true);
});

// Test: Cache disabled when cacheTtl is 0
it('should disable caching when cacheTtl is 0', async () => {
  // config.yaml has: cacheTtl: 0
  await sync({ projectRoot: testDir });

  expect(mockUrlLoader).toHaveBeenCalledWith(
    expect.any(String),
    expect.objectContaining({
      cacheTtl: 0,
    })
  );
});

// Test: Schema validation rejects invalid timeout
it('should reject invalid timeout values', async () => {
  // config.yaml has: timeout: 100 (below minimum of 1000)
  const result = await loadConfig({ projectRoot: testDir });
  
  expect(result.ok).toBe(false);
  expect(result.error.message).toContain('timeout');
});
```

## 7. Integration Points

- **Imports from**:
  - `src/loaders/url.ts` - `createUrlLoader()`, `UrlLoaderOptions`
  - `src/config/types.ts` - `LoaderConfig` (extended)
  
- **Modifies**:
  - `src/cli/commands/sync.ts` - Add URL loader case in `loadContent()`
  - `src/config/types.ts` - Add URL-specific fields to `LoaderConfig`
  - `src/schemas/config.schema.json` - Add URL loader properties to schema

- **Exports to**: Used directly by users via config.yaml

- **Config**: Updates `src/schemas/config.schema.json` loader definition

## 8. Acceptance Criteria

- [ ] `type: url` loaders in config.yaml actually fetch content during sync
- [ ] URL-specific options (`timeout`, `cacheTtl`, `headers`, `useCache`) work correctly
- [ ] Environment variables in headers are expanded before requests
- [ ] URL errors are reported as warnings (non-fatal), sync continues
- [ ] Schema validates URL loader options (rejects invalid timeout, etc.)
- [ ] All tests pass (`npm test -- sync.test.ts url.test.ts`)
- [ ] No lint errors (`npm run lint`)
- [ ] Types are strict (no `any`)
- [ ] plan.md is updated with completion status

## 9. Out of Scope

- npm/pip loader integration (separate tasks)
- Rate limiting for URL requests (future enhancement)
- Retry logic for transient failures (future enhancement)
- Proxy configuration support (future enhancement)
- Cache directory configuration via config.yaml (uses default)

## 10. Implementation Checklist

1. [ ] Extend `LoaderConfig` in `src/config/types.ts` with URL options
2. [ ] Update `#/$defs/loader` in `src/schemas/config.schema.json`
3. [ ] Add `expandEnvVars()` helper in `src/cli/commands/sync.ts`
4. [ ] Add URL loader case in `loadContent()` function
5. [ ] Add import for `createUrlLoader` in sync.ts
6. [ ] Write unit tests for URL loader integration
7. [ ] Write integration test with mocked fetch
8. [ ] Run `npm test -- sync.test.ts url.test.ts`
9. [ ] Run `npm run lint --fix`
10. [ ] Run `npm run typecheck`
11. [ ] Update plan.md with T230 completion status

## 11. Example Config and Output

### Input: `.ai-tool-sync/config.yaml`

```yaml
version: 1.0.0
project_name: my-project

loaders:
  - type: ai-tool-sync
  - type: url
    source: https://raw.githubusercontent.com/company/shared-rules/main/
    headers:
      Authorization: "Bearer ${GITHUB_TOKEN}"
    timeout: 15000
    cacheTtl: 7200000  # 2 hours

targets:
  - cursor
  - claude
```

### Expected Behavior

```
$ ai-sync

ğŸ”§ AI Tool Sync
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Project: my-project

ğŸ“‚ Loading content
Loading from project: .ai-tool-sync
Loading defaults from: /path/to/defaults
Loading from URL: https://raw.githubusercontent.com/company/shared-rules/main/
  â³ Fetching with timeout: 15000ms
  âœ“ Loaded 3 rules, 2 personas from URL

ğŸ“Š Loaded
  Rules: 5  Personas: 4  Commands: 2  Hooks: 1

ğŸ¯ Generating outputs
âœ“ cursor: 8 files
âœ“ claude: 7 files

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ“ Synced 15 files (1.2s)
```

