# T255: Fix Windows `npm test` `NODE_OPTIONS` Usage

> **Priority**: P0 | **Wave**: 1 | **Track**: G (Windows Compatibility)  
> **Depends on**: None  
> **Estimated complexity**: Low

## 1. Objective

Make `npm test` succeed on Windows by eliminating the POSIX-only inline `NODE_OPTIONS` usage in the test script. Ensure the Vitest run still uses the 4GB memory limit on all platforms, and keep CI/prepublish flows intact.

## 2. Prior Art (IMPORTANT)

- `package.json` scripts — current `test` script uses inline `NODE_OPTIONS` and `prepublishOnly` depends on it.  
- `.github/workflows/test.yml` — matrix includes `windows-latest`; reuse/align commands here.  
- `package.json` `test:coverage` / `test:e2e` — follow the existing script naming and reuse patterns rather than adding ad-hoc commands.

## 3. File Structure
```
package.json                 # Update test script to be cross-platform
scripts/run-tests.ts|js      # (If needed) helper to wrap Vitest with NODE_OPTIONS
.github/workflows/test.yml   # Ensure Windows matrix uses the updated script
```

## 4. Interfaces & Types
```typescript
// If adding a helper script, keep the contract minimal and typed.
interface TestRunnerOptions {
  /** Max old space size in MB applied to Vitest process */
  maxOldSpaceMb: number; // default 4096
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- Use typed helpers (no `any`); prefer `unknown` + guards if inputs are dynamic.  
- Respect `import/order` and path aliases (`@/`); run `npm run lint` if adding TS.  
- Keep `exactOptionalPropertyTypes` happy: only include optional keys when defined.  
- Only throw at the CLI boundary; otherwise use `Result`/typed errors if new code is added.  
- Keep generic formats/tool mappings untouched (no target-specific leakage).

### 5.2 Critical Logic (Pitfall Prevention)
```bash
# ❌ WRONG (breaks on Windows CMD/PowerShell)
NODE_OPTIONS='--max-old-space-size=4096' vitest run

# ✅ CORRECT (works on Windows/macOS/Linux)
cross-env NODE_OPTIONS=--max-old-space-size=4096 vitest run
# or move the flag into a small JS/TS runner that spawns Vitest with Node args
```
- If creating a wrapper script, ensure it forwards args (`process.argv.slice(2)`) and preserves existing `NODE_OPTIONS` rather than clobbering them.  
- Keep `prepublishOnly` working (it calls `npm test`).  
- Do not change other scripts (`test:watch`, `test:coverage`, `test:e2e`) unless they need the same flag; avoid unintended slowdown on watch mode.

### 5.3 Edge Cases to Handle
- Windows (CMD and PowerShell) must run `npm test` without `'NODE_OPTIONS' is not recognized`.  
- Existing user `NODE_OPTIONS` should not be lost; append/merge the memory flag if wrapping.  
- CI matrix (windows-latest) should pick up the new command automatically.  
- Local shells without `cross-env` installed globally must still work (add devDependency or self-contained wrapper).

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('npm test (cross-platform)', () => {
  it('runs on Windows shell', () => {/* verified in CI matrix */});
  it('runs on Unix shells', () => {/* sanity */});
});
```

### 6.2 Required Test Cases
- [ ] CI `windows-latest` matrix job completes `npm test` without command-not-found errors.  
- [ ] `npm test` succeeds locally on macOS/Linux (no regression).  
- [ ] `prepublishOnly` still runs tests with the memory limit applied.  
- [ ] (If wrapper added) Passing extra Vitest args (e.g., `npm test -- tests/foo.test.ts`) still works.

## 7. Integration Points
- `package.json` scripts: `test`, `prepublishOnly` (invokes `npm test`).  
- `.github/workflows/test.yml`: uses `npm test` in the matrix; no per-OS overrides should be needed after the fix.  
- Optional helper script lives under `scripts/` if used; ensure it’s invoked from `package.json`.

## 8. Acceptance Criteria
- [ ] `package.json` `test` script is cross-platform (Windows-compatible) and still applies `--max-old-space-size=4096`.  
- [ ] Windows CI matrix job passes without `NODE_OPTIONS` command errors.  
- [ ] `prepublishOnly` continues to run tests successfully.  
- [ ] No lint/type errors introduced.

## 9. Out of Scope
- Changing Vitest configuration, coverage thresholds, or test suite content.  
- Adjusting memory settings for other scripts (`test:watch`, `test:e2e`, `test:coverage`) unless strictly required for Windows.

## 10. Guidelines for Writing Specs
- Include exact script updates and how to preserve `NODE_OPTIONS` on all shells.  
- Call out pitfalls (Windows CMD vs Bash quoting) and how the chosen approach avoids them.  
- Keep instructions minimal so a junior can implement without guessing; prefer explicit commands over vague guidance.

