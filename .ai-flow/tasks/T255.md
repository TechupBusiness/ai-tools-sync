# T255: Fix Windows `npm test` `NODE_OPTIONS` Usage

> **Priority**: P0 | **Wave**: 1 | **Track**: G (Windows Compatibility)  
> **Depends on**: None  
> **Estimated complexity**: Low

## 1. Objective
Make `npm test` work on Windows (CMD/PowerShell) by replacing the POSIX-only inline `NODE_OPTIONS` usage while still applying the 4GB memory flag to Vitest on all platforms. Keep `prepublishOnly` and CI behavior unchanged.

## 2. Prior Art (IMPORTANT)
- `package.json` scripts — current `test` script sets `NODE_OPTIONS` inline; `prepublishOnly` calls it.  
- `.github/workflows/test.yml` — CI matrix already runs `npm test` on `windows-latest`; ensure no per-OS hacks are needed.  
- `tests/.tmp/demo-content/scripts/sync-cursor-config.ts` — reference for Node spawn/arg forwarding patterns used elsewhere.  
- `package.json` `test:coverage` / `test:e2e` — mirror naming/structure; avoid ad-hoc script proliferation.

## 3. File Structure
```
package.json                   # Update test script to be cross-platform
scripts/run-tests.ts           # Minimal wrapper to apply NODE_OPTIONS portably (preferred)
.github/workflows/test.yml     # Verify matrix still uses plain `npm test`
```

## 4. Interfaces & Types
```typescript
interface TestRunnerOptions {
  /** Max old space size in MB applied to the Vitest process */
  maxOldSpaceMb: number; // default 4096
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- Use typed helpers; no `any`. Prefer `unknown` + guards for dynamic inputs.
- Respect `import/order` and `@/` aliases (see learnings T206/T228); run lint if new TS is added.
- Honor `exactOptionalPropertyTypes`: only include optional keys when defined (T159/T160).
- Keep errors typed; if throwing in a script, do it at the CLI boundary only.
- Do not alter generic format/tool mappings.

### 5.2 Critical Logic (Pitfall Prevention)
```bash
# ❌ WRONG (POSIX-only, fails on Windows)
NODE_OPTIONS='--max-old-space-size=4096' vitest run

# ✅ CORRECT (portable, no global deps)
node --max-old-space-size=4096 ./node_modules/vitest/vitest.mjs run

# ✅ ALSO OK (if wrapper used)
node scripts/run-tests.js -- run               # wrapper merges NODE_OPTIONS and forwards args
```
- Preferred: tiny wrapper `scripts/run-tests.ts` that:
  - Merges existing `NODE_OPTIONS` with `--max-old-space-size=4096` when not already present.
  - Forwards all extra args (`process.argv.slice(2)`) to Vitest.
  - Spawns via Node (e.g., `node --max-old-space-size=... node_modules/vitest/vitest.mjs run ...`) to avoid `cross-env`.
- Keep `prepublishOnly` working (it calls `npm test`).
- Do not change other scripts (`test:watch`, `test:coverage`, `test:e2e`) unless they also break on Windows.

### 5.3 Edge Cases to Handle
- Windows CMD/PowerShell must run `npm test` without `'NODE_OPTIONS' is not recognized`.
- Preserve user-provided `NODE_OPTIONS`; append the memory flag only if missing.
- CI matrix (`windows-latest`) picks up the fixed script without OS conditionals.
- No reliance on globally installed `cross-env`; either add it as devDependency or avoid it via Node runner.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('npm test (cross-platform)', () => {
  it('runs on Windows shell'); // verified via CI matrix
  it('runs on Unix shells');   // sanity
});
```

### 6.2 Required Test Cases
- [ ] CI `windows-latest` job completes `npm test` without command-not-found or env assignment errors.  
- [x] `npm test` succeeds locally on macOS/Linux (no regression).  
- [x] `prepublishOnly` still runs tests with the memory flag applied.  
- [x] Passing extra Vitest args (e.g., `npm test -- tests/foo.test.ts`) still works.

## 7. Integration Points
- `package.json` scripts: update `test`; ensure `prepublishOnly` remains valid.  
- `.github/workflows/test.yml`: continues to invoke `npm test` in the matrix; no OS-specific overrides.  
- Optional helper script under `scripts/` if implemented; ensure it is referenced from `package.json`.

## 8. Acceptance Criteria
- [x] `package.json` `test` script is Windows-compatible and applies `--max-old-space-size=4096`.  
- [ ] Windows CI matrix job passes without `NODE_OPTIONS` errors.  
- [x] `prepublishOnly` continues to work.  
- [x] No lint/type errors introduced; new code respects project patterns.  
- [x] `plan.md` entry for T255 reflects the change if status updates are needed.

## 9. Out of Scope
- Changing Vitest config, coverage thresholds, or suite contents.  
- Altering memory settings for other scripts unless they fail on Windows.

## 10. Guidelines for Writing Specs
- Specify exact script updates and how NODE_OPTIONS is applied cross-platform.  
- Call out Windows CMD vs Bash quoting pitfalls and how the chosen approach avoids them.  
- Be explicit so a junior can implement without guessing; reference patterns above rather than re-inventing helpers.

