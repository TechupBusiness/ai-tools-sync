# T203: Add Claude Code Hooks Support

> **Priority**: P1 | **Wave**: 2 | **Track**: C (Claude Code)
> **Depends on**: T202 (Claude Code settings.json generation) ✅
> **Estimated complexity**: Low (most work already done in T202)

## 1. Objective

Enhance Claude Code hooks support to ensure full parity with Claude Code's hook system, including all event types, matcher patterns, and hook configuration from both hook files and `config.yaml`. This task validates and potentially extends the existing implementation from T202.

**Current State**: Claude generator (`src/generators/claude.ts`) already has substantial hooks support:
- Event mapping via `mapEventToClaude()`
- Hook building via `buildClaudeHooks()` and `buildHookOutput()`
- Support for combining hooks from files and `config.yaml`
- Tests covering most scenarios

**Remaining Work**: Verify completeness and add any missing edge cases.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/generators/claude.ts` - Already has hooks implementation (lines 113-672)
- `src/generators/cursor.ts` - Cursor hooks pattern for reference (lines 548-627)
- `tests/unit/generators/claude.test.ts` - Existing hooks tests (lines 288-497)
- `src/parsers/hook.ts` - Hook parser with all event types

## 3. File Structure

No new files needed. Verify/extend existing:
```
src/
├── generators/
│   └── claude.ts          # Already has hooks support
├── config/
│   └── types.ts           # ClaudeHookConfig, ClaudeSettingsConfig
tests/
└── unit/
    └── generators/
        └── claude.test.ts # Add missing test cases
```

## 4. Interfaces & Types

Already defined in `src/config/types.ts`:

```typescript
// ClaudeHookConfig - Hook configuration from config.yaml
interface ClaudeHookConfig {
  name?: string;              // Hook identifier for logging/debugging
  matcher?: string;           // Tool/pattern match (e.g., 'Bash(*rm*)', 'Write|Edit')
  command: string;            // Shell command to execute
  type?: 'command' | 'validation' | 'notification';
  action?: 'warn' | 'block';  // For PreToolUse hooks
  message?: string;           // User-facing message
}
```

Already defined in `src/generators/claude.ts`:

```typescript
// Supported events (line 79-88)
type ClaudeHookEvent =
  | 'UserPromptSubmit'
  | 'PreToolUse'
  | 'PostToolUse'
  | 'Notification'
  | 'Stop'
  | 'SubagentStop'
  | 'SessionStart'
  | 'SessionEnd'
  | 'PreCompact';
```

## 5. Implementation Requirements

### 5.1 Verification Checklist (Already Implemented)

Verify these are working correctly:

- [x] Event mapping from generic to Claude events (`mapEventToClaude`)
  - `PreToolUse` → `PreToolUse`
  - `PostToolUse` → `PostToolUse`
  - `UserPromptSubmit` → `UserPromptSubmit`
  - `PreMessage` → `UserPromptSubmit` (legacy)
  - `PostMessage` → `PostToolUse` (legacy)
  - `PreCommit` → `PreToolUse` with `Bash(git commit*)` matcher (legacy)

- [x] Hook output format:
  ```json
  {
    "type": "command",
    "command": "npm run lint",
    "matcher": "Bash(git commit*)",
    "action": "warn",
    "message": "Running lint check"
  }
  ```

- [x] Combining hooks from:
  - Parsed hook files (`ParsedHook[]`)
  - `config.yaml` claude settings (`claudeSettings.hooks`)

- [x] `matcher` field handling:
  - Omit when undefined or `*` (match all)
  - Include when specific pattern

### 5.2 Gaps to Address (If Any)

Review and ensure these edge cases are covered:

1. **Hook type from claude extension**
   ```typescript
   // Verify claude.type is respected
   hook.frontmatter.claude?.type ?? 'command'
   ```

2. **All 9 Claude events supported** in config.yaml hooks:
   - UserPromptSubmit, PreToolUse, PostToolUse
   - Notification, Stop, SubagentStop
   - SessionStart, SessionEnd, PreCompact

3. **Hook ordering** - Should be deterministic (sorted by event name)

### 5.3 Edge Cases to Handle

- [x] Empty hooks array → No `hooks` key in settings.json
- [x] Hook with no `execute` → Should still work (use default echo)
- [x] `tool_match: "*"` → Omit `matcher` field (match all)
- [x] Legacy `PreCommit` event → Map to `PreToolUse` with default `Bash(git commit*)` matcher
- [x] Multiple hooks for same event → Array of hooks under that event (test added)

## 6. Test Requirements

### 6.1 Existing Tests (Verify Pass)

In `tests/unit/generators/claude.test.ts`:
- `describe('generate() - hooks (Claude format)')`
  - ✅ should generate settings.json with correct Claude hook format
  - ✅ should group hooks by event type
  - ✅ should map PreMessage to UserPromptSubmit
  - ✅ should map PreCommit to PreToolUse with default matcher
  - ✅ should support claude extension for action and message
  - ✅ should combine hooks from files and config.yaml
  - ✅ should support all Claude hook events
  - ✅ should not include matcher when it is "*"
  - ✅ should not include matcher when tool_match is undefined

### 6.2 Additional Test Cases (If Missing)

```typescript
describe('Claude hooks edge cases', () => {
  it('should preserve hook type from claude extension', async () => {
    // Test that claude.type='validation' is preserved
  });

  it('should handle hook with only command (no matcher, no action)', async () => {
    // Minimal hook config
  });

  it('should sort hooks deterministically within each event', async () => {
    // Multiple hooks for same event should have consistent order
  });
});
```

## 7. Integration Points

- **Imports from**: 
  - `src/parsers/hook.ts` - `ParsedHook`, `HookEvent`
  - `src/config/types.ts` - `ClaudeHookConfig`, `ClaudeSettingsConfig`
  
- **Exports to**: 
  - Generated `.claude/settings.json`
  
- **Config**: Uses `claude.settings.hooks` from `config.yaml`

## 8. Acceptance Criteria

- [x] All existing hooks tests pass (`npm test -- claude.test.ts`) - 45 tests passing
- [x] Hook format matches Claude Code specification exactly
- [x] All 9 Claude hook events can be configured via config.yaml
- [x] Hooks from files and config.yaml are properly merged
- [x] No regression in existing functionality
- [x] No lint errors (`npm run lint`)

## 9. Out of Scope

- Factory hooks support (T207)
- Plugin hooks.json parsing (T156)
- Cursor hooks (T211 - already done)

## 10. Implementation Notes

**This task is primarily a verification task.** The core hooks functionality was implemented as part of T202. The main work is:

1. **Run existing tests** - Verify all pass
2. **Review code coverage** - Ensure edge cases are tested
3. **Add any missing tests** - Focus on the gaps identified above
4. **Document any findings** - Update learnings.md if issues found

If all tests pass and coverage is complete, this task can be marked done quickly.
