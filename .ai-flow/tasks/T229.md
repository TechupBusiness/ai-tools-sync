# T229: Implement Template Variable Substitution

> **Priority**: P2 | **Wave**: 8 | **Track**: A (Variable Substitution)
> **Depends on**: T228 ✅ (Conditional Content)
> **Estimated complexity**: Low

## 1. Objective

Implement a template variable substitution system that replaces `{{variable_name}}` placeholders with dynamic values from project metadata (package.json), git info, config.yaml, and environment variables. This enables content authors to include project-specific values (name, version, author) and runtime info (date, year) in their markdown content without hardcoding, keeping generated output up-to-date across syncs.

## 1.1 Syntax Design: Why `{{...}}` (Mustache-style)

**Our generic template syntax uses `{{...}}` for ALL ai-tool-sync templating:**

| Syntax | Purpose | Example |
|--------|---------|---------|
| `{{#platform}}...{{/platform}}` | Conditional blocks (T228) | `{{#claude}}Claude only{{/claude}}` |
| `{{variable}}` | Variable substitution (T229) | `{{project_name}}` |

**This is intentionally different from external tool syntaxes we do NOT control:**

| External Syntax | Used By | Purpose | We Process? |
|-----------------|---------|---------|-------------|
| `${VAR}` | MCP protocol, shell | Environment variables | ❌ No - passed through |
| `${CLAUDE_PLUGIN_ROOT}` | Claude plugins | Plugin path | ❌ No - passed through |
| `$ARGUMENTS` | Claude, Factory | Runtime user input | ❌ No - passed through |
| `$FACTORY_PROJECT_DIR` | Factory | Project directory | ❌ No - passed through |

**Design principles:**
1. **No collision**: `{{...}}` never conflicts with `${...}` or `$VAR` syntaxes
2. **Consistent**: Both conditionals (T228) and variables (T229) use Mustache-style `{{...}}`
3. **Pass-through**: External tool variables (`$ARGUMENTS`, `${HOME}`) are left untouched
4. **Clear semantics**: `{{...}}` = build-time template processing by ai-tool-sync

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/transformers/conditional-content.ts` - **Exact pattern to follow**: Similar regex-based substitution, same file structure
- `src/transformers/index.ts` - **Export pattern**: Add new exports here
- `src/utils/fs.ts` - **Line 233-246**: `readJson<T>()` for reading package.json
- `src/config/loader.ts` - **Line 51-74**: Pattern for reading package.json fields
- `src/loaders/git.ts` - **Line 779-789**: Pattern for executing git commands with `execSync`
- `tests/unit/transformers/conditional-content.test.ts` - **Test structure**: `describe/it` patterns

## 3. File Structure

```
src/
├── transformers/
│   ├── template-variables.ts    # Main implementation
│   └── index.ts                 # Add export
tests/
└── unit/
    └── transformers/
        └── template-variables.test.ts  # Tests
```

## 4. Interfaces & Types

### 4.1 Main Types

```typescript
// In src/transformers/template-variables.ts

/**
 * Context for template variable resolution
 * All values are optional - missing sources are gracefully skipped
 */
export interface TemplateVariableContext {
  /** Path to project root (for reading package.json, git info) */
  projectRoot?: string;
  /** Config from config.yaml (pre-loaded) */
  config?: {
    project_name?: string;
    version?: string;
    [key: string]: unknown;
  };
  /** Override or add custom variables */
  variables?: Record<string, string>;
}

/**
 * Options for template variable substitution
 */
export interface TemplateVariableOptions {
  /**
   * Whether to leave unknown variables as-is or replace with empty string
   * @default 'preserve' - Unknown {{var}} are left unchanged
   */
  unknownVariables?: 'preserve' | 'remove';
}

/**
 * Resolved variables ready for substitution
 * Cached to avoid repeated file/git operations
 */
interface ResolvedVariables {
  // From package.json
  project_name?: string;
  version?: string;
  author?: string;
  description?: string;
  license?: string;
  repository?: string;
  
  // From git
  git_author?: string;
  git_email?: string;
  git_branch?: string;
  git_commit?: string;
  
  // Runtime/date
  date?: string;        // YYYY-MM-DD
  year?: string;        // YYYY
  timestamp?: string;   // ISO 8601
  
  // Custom overrides (from context.variables)
  [key: string]: string | undefined;
}

// NOTE: Environment variables are NOT processed with {{env_VAR}} syntax.
// Use standard ${VAR} syntax for env vars - these are passed through untouched
// to the target platform which handles them at runtime.
```

### 4.2 Syntax Specification

```
Variable syntax: {{variable_name}}

Variable names:
- Lowercase letters, numbers, underscores only
- No spaces around variable name: {{project_name}} ✓, {{ project_name }} ✗
- No # prefix (that's for conditional blocks): {{project_name}} ✓, {{#project_name}} ✗

Built-in variables:
| Variable        | Source              | Example                              |
|-----------------|---------------------|--------------------------------------|
| project_name    | package.json.name OR config.project_name | "ai-tools-sync" |
| version         | package.json.version OR config.version   | "1.0.0"         |
| author          | package.json.author  | "John Doe"                           |
| description     | package.json.description | "A sync tool"                    |
| license         | package.json.license | "MIT"                                |
| repository      | package.json.repository.url | "https://github.com/..." |
| git_author      | git config user.name | "John Doe"                           |
| git_email       | git config user.email| "john@example.com"                   |
| git_branch      | git branch --show-current | "main"                          |
| git_commit      | git rev-parse --short HEAD | "abc1234"                       |
| date            | Current date         | "2025-12-08"                         |
| year            | Current year         | "2025"                               |
| timestamp       | ISO timestamp        | "2025-12-08T10:30:00Z"               |

**NOT supported (use standard syntax instead):**
| Want this?           | Use this (passed through) | Handled by        |
|----------------------|---------------------------|-------------------|
| Environment variable | `${HOME}`, `${NODE_ENV}`  | Target platform   |
| User input           | `$ARGUMENTS`              | Claude/Factory    |
| Project dir          | `$FACTORY_PROJECT_DIR`    | Factory           |
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Import utilities from `../utils/fs.js` (`readJson`)
- [x] Export function from `src/transformers/index.ts`
- [x] No `any` types - use strict TypeScript
- [x] Synchronous execution for git commands (like `src/loaders/git.ts`)
- [x] Graceful handling when sources unavailable (no git, no package.json)
- [x] Run `npm run lint --fix` after implementation
- [x] Run `npm run typecheck` after implementation

### 5.2 Critical Logic (Pitfall Prevention)

#### 5.2.1 Variable Pattern - Avoid Matching Conditional Blocks

```typescript
// ✅ CORRECT - Negative lookahead to skip {{#...}} conditional blocks
// Matches {{var}} but NOT {{#var}} or {{/var}}
const VARIABLE_PATTERN = /\{\{(?!#|\/|!)([a-z][a-z0-9_]*)\}\}/g;

// ❌ WRONG - Would also match conditional block syntax
const VARIABLE_PATTERN_BAD = /\{\{([^}]+)\}\}/g;
```

#### 5.2.2 Resolving Variables - Lazy Loading with Caching

```typescript
/**
 * Resolve all template variables from sources
 * Caches results to avoid repeated I/O operations
 */
async function resolveVariables(context: TemplateVariableContext): Promise<ResolvedVariables> {
  const variables: ResolvedVariables = {};
  const projectRoot = context.projectRoot ?? process.cwd();

  // 1. Custom variables (highest priority - override everything)
  if (context.variables) {
    Object.assign(variables, context.variables);
  }

  // 2. Config values (second priority)
  if (context.config?.project_name) {
    variables.project_name ??= context.config.project_name;
  }
  if (context.config?.version) {
    variables.version ??= context.config.version;
  }

  // 3. package.json values (third priority)
  const pkg = await loadPackageJson(projectRoot);
  if (pkg) {
    variables.project_name ??= pkg.name;
    variables.version ??= pkg.version;
    variables.author ??= normalizeAuthor(pkg.author);
    variables.description ??= pkg.description;
    variables.license ??= pkg.license;
    variables.repository ??= normalizeRepository(pkg.repository);
  }

  // 4. Git values (sync - fast operations)
  variables.git_author ??= getGitConfig('user.name', projectRoot);
  variables.git_email ??= getGitConfig('user.email', projectRoot);
  variables.git_branch ??= getGitBranch(projectRoot);
  variables.git_commit ??= getGitCommit(projectRoot);

  // 5. Date values (always available)
  const now = new Date();
  variables.date = now.toISOString().split('T')[0];
  variables.year = String(now.getFullYear());
  variables.timestamp = now.toISOString();

  return variables;
}
```

#### 5.2.3 Git Commands - Silent Failure

```typescript
import { execSync } from 'node:child_process';

/**
 * Get a git config value, returning undefined on failure
 */
function getGitConfig(key: string, cwd: string): string | undefined {
  try {
    const result = execSync(`git config --get ${key}`, {
      cwd,
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'ignore'], // Suppress stderr
    });
    return result.trim() || undefined;
  } catch {
    return undefined;
  }
}

/**
 * Get current git branch
 */
function getGitBranch(cwd: string): string | undefined {
  try {
    const result = execSync('git branch --show-current', {
      cwd,
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'ignore'],
    });
    return result.trim() || undefined;
  } catch {
    return undefined;
  }
}

/**
 * Get short commit hash
 */
function getGitCommit(cwd: string): string | undefined {
  try {
    const result = execSync('git rev-parse --short HEAD', {
      cwd,
      encoding: 'utf-8',
      stdio: ['pipe', 'pipe', 'ignore'],
    });
    return result.trim() || undefined;
  } catch {
    return undefined;
  }
}
```

#### 5.2.4 Pass-Through External Syntaxes

```typescript
// IMPORTANT: We do NOT process ${VAR} or $ARGUMENTS syntaxes
// These are passed through unchanged for the target platform to handle

// ✅ CORRECT - Only match our {{variable}} syntax
const VARIABLE_PATTERN = /\{\{(?!#|\/|!)([a-z][a-z0-9_]*)\}\}/g;

// These are left untouched in output:
// - ${HOME} → ${HOME}           (env var for MCP/platform)
// - $ARGUMENTS → $ARGUMENTS     (user input for Claude/Factory)
// - $FACTORY_PROJECT_DIR → $FACTORY_PROJECT_DIR (Factory path)
```

#### 5.2.5 Main Transform Function

```typescript
/**
 * Transform template variables in content
 * 
 * Replaces {{variable}} placeholders with resolved values.
 * Variables can come from package.json, git, config, or environment.
 * 
 * @param content - Content with {{variable}} placeholders
 * @param context - Sources for variable resolution
 * @param options - Substitution options
 * @returns Content with variables substituted
 * 
 * @example
 * const content = `
 * # {{project_name}} v{{version}}
 * 
 * Author: {{author}}
 * Last updated: {{date}}
 * `;
 * 
 * await transformTemplateVariables(content, { projectRoot: '/path/to/project' });
 * // Result:
 * // # ai-tools-sync v1.0.0
 * // 
 * // Author: John Doe
 * // Last updated: 2025-12-08
 */
export async function transformTemplateVariables(
  content: string,
  context: TemplateVariableContext = {},
  options: TemplateVariableOptions = {}
): Promise<string> {
  const { unknownVariables = 'preserve' } = options;
  
  // Skip if no variables in content (optimization)
  if (!content.includes('{{')) {
    return content;
  }
  
  // Resolve all variables from sources
  const resolved = await resolveVariables(context);
  
  // Pattern: {{variable_name}} but NOT {{#...}}, {{/...}}, {{!...}}
  const VARIABLE_PATTERN = /\{\{(?!#|\/|!)([a-z][a-z0-9_]*)\}\}/g;
  
  return content.replace(VARIABLE_PATTERN, (match, varName: string) => {
    // Check resolved variables (from package.json, git, config, custom)
    const value = resolved[varName];
    if (value !== undefined) {
      return value;
    }
    
    // Handle unknown variables
    return unknownVariables === 'remove' ? '' : match;
  });
}

// NOTE: ${VAR} and $ARGUMENTS syntaxes are NOT processed here.
// They pass through unchanged for target platforms to handle at runtime.
```

### 5.3 Edge Cases to Handle

- [ ] No variables in content → Return content unchanged (fast path)
- [ ] Unknown variable `{{unknown}}` → Preserve as-is by default (or remove with option)
- [ ] No package.json → Skip package.json variables gracefully
- [ ] Not a git repository → Skip git variables gracefully
- [ ] Empty variable value → Replace with empty string (not placeholder)
- [ ] Nested/escaped braces `{{{{var}}}}` → Only inner match processed
- [ ] Conditional block syntax `{{#claude}}` → NOT matched (negative lookahead)
- [ ] Mixed case `{{Project_Name}}` → NOT matched (lowercase only)
- [ ] Variable at start/end of content → Works correctly
- [ ] Multiple occurrences of same variable → All replaced

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/transformers/template-variables.test.ts

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import * as path from 'node:path';

import {
  transformTemplateVariables,
  type TemplateVariableContext,
} from '../../../src/transformers/template-variables.js';

describe('Template Variables Transformer', () => {
  describe('transformTemplateVariables()', () => {
    describe('basic functionality', () => { /* ... */ });
    describe('package.json variables', () => { /* ... */ });
    describe('git variables', () => { /* ... */ });
    describe('date variables', () => { /* ... */ });
    describe('environment variables', () => { /* ... */ });
    describe('custom variables', () => { /* ... */ });
    describe('priority/override', () => { /* ... */ });
    describe('edge cases', () => { /* ... */ });
  });
});
```

### 6.2 Required Test Cases

```typescript
describe('basic functionality', () => {
  it('should return content unchanged when no variables', async () => {
    const content = '# Hello\n\nSome content here.';
    const result = await transformTemplateVariables(content, {});
    expect(result).toBe(content);
  });

  it('should skip conditional block syntax', async () => {
    const content = '{{#claude}}Claude only{{/claude}}';
    const result = await transformTemplateVariables(content, {});
    // Conditional blocks are NOT processed by this transformer
    expect(result).toBe(content);
  });

  it('should preserve unknown variables by default', async () => {
    const content = 'Hello {{unknown_var}}!';
    const result = await transformTemplateVariables(content, {});
    expect(result).toBe('Hello {{unknown_var}}!');
  });

  it('should remove unknown variables when option set', async () => {
    const content = 'Hello {{unknown_var}}!';
    const result = await transformTemplateVariables(content, {}, { unknownVariables: 'remove' });
    expect(result).toBe('Hello !');
  });
});

describe('custom variables', () => {
  it('should substitute custom variables', async () => {
    const content = '{{greeting}}, {{name}}!';
    const result = await transformTemplateVariables(content, {
      variables: { greeting: 'Hello', name: 'World' },
    });
    expect(result).toBe('Hello, World!');
  });

  it('should give custom variables highest priority', async () => {
    const content = '{{project_name}}';
    const result = await transformTemplateVariables(content, {
      variables: { project_name: 'custom-name' },
      config: { project_name: 'config-name' },
    });
    expect(result).toBe('custom-name');
  });
});

describe('config variables', () => {
  it('should substitute from config.project_name', async () => {
    const content = 'Project: {{project_name}}';
    const result = await transformTemplateVariables(content, {
      config: { project_name: 'my-project' },
    });
    expect(result).toBe('Project: my-project');
  });

  it('should substitute from config.version', async () => {
    const content = 'Version: {{version}}';
    const result = await transformTemplateVariables(content, {
      config: { version: '2.0.0' },
    });
    expect(result).toBe('Version: 2.0.0');
  });
});

describe('date variables', () => {
  it('should substitute date variables', async () => {
    const content = 'Date: {{date}}, Year: {{year}}';
    const result = await transformTemplateVariables(content, {});
    // Just check format, not exact value
    expect(result).toMatch(/Date: \d{4}-\d{2}-\d{2}, Year: \d{4}/);
  });

  it('should substitute timestamp', async () => {
    const content = 'Generated: {{timestamp}}';
    const result = await transformTemplateVariables(content, {});
    expect(result).toMatch(/Generated: \d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/);
  });
});

describe('pass-through external syntaxes', () => {
  it('should NOT process ${VAR} env var syntax', async () => {
    const content = 'Home: ${HOME}, Node: ${NODE_ENV}';
    const result = await transformTemplateVariables(content, {});
    // ${...} is passed through untouched for target platform
    expect(result).toBe('Home: ${HOME}, Node: ${NODE_ENV}');
  });

  it('should NOT process $ARGUMENTS platform variable', async () => {
    const content = 'Input: $ARGUMENTS';
    const result = await transformTemplateVariables(content, {});
    // $ARGUMENTS is passed through for Claude/Factory
    expect(result).toBe('Input: $ARGUMENTS');
  });

  it('should NOT process $FACTORY_PROJECT_DIR', async () => {
    const content = 'Dir: $FACTORY_PROJECT_DIR';
    const result = await transformTemplateVariables(content, {});
    expect(result).toBe('Dir: $FACTORY_PROJECT_DIR');
  });
});

describe('package.json variables', () => {
  it('should substitute from package.json', async () => {
    // Use fixtures or mock
    const content = '{{project_name}} v{{version}}';
    const result = await transformTemplateVariables(content, {
      projectRoot: path.join(__dirname, '../../fixtures/minimal-project'),
    });
    expect(result).toContain('v');
  });
});

describe('edge cases', () => {
  it('should handle empty content', async () => {
    const result = await transformTemplateVariables('', {});
    expect(result).toBe('');
  });

  it('should handle multiple occurrences of same variable', async () => {
    const content = '{{name}} and {{name}} again';
    const result = await transformTemplateVariables(content, {
      variables: { name: 'test' },
    });
    expect(result).toBe('test and test again');
  });

  it('should not match variables with spaces', async () => {
    const content = '{{ project_name }}';
    const result = await transformTemplateVariables(content, {
      config: { project_name: 'test' },
    });
    // Should not match - strict syntax
    expect(result).toBe('{{ project_name }}');
  });

  it('should not match uppercase variables', async () => {
    const content = '{{PROJECT_NAME}}';
    const result = await transformTemplateVariables(content, {
      config: { project_name: 'test' },
    });
    // Should not match - lowercase only
    expect(result).toBe('{{PROJECT_NAME}}');
  });

  it('should handle variable at start and end', async () => {
    const content = '{{start}}middle{{end}}';
    const result = await transformTemplateVariables(content, {
      variables: { start: 'A', end: 'Z' },
    });
    expect(result).toBe('AmiddleZ');
  });

  it('should handle empty resolved value', async () => {
    const content = 'Value: {{empty}}';
    const result = await transformTemplateVariables(content, {
      variables: { empty: '' },
    });
    expect(result).toBe('Value: ');
  });
});
```

## 7. Integration Points

- **Imports from**:
  - `../utils/fs.js` - `readJson<T>()`
  - `node:child_process` - `execSync` for git commands

- **Exports to**:
  - `src/transformers/index.ts` - Add `export * from './template-variables.js';`

- **Will be used by** (future integration):
  - Generator base class alongside `transformConditionalContent()`
  - Content pipeline: parse → transform conditionals → transform variables → generate

- **Integration order with conditionals**:
  ```typescript
  // In generator pipeline (future task)
  let output = content;
  output = transformConditionalContent(output, target);  // T228 - first
  output = await transformTemplateVariables(output, context);  // T229 - second
  // Variables are resolved after conditionals to allow platform-specific vars
  ```

## 8. Acceptance Criteria

- [ ] `transformTemplateVariables()` correctly substitutes all variable types
- [ ] Package.json variables work (project_name, version, author, etc.)
- [ ] Git variables work (git_author, git_email, git_branch, git_commit)
- [ ] Date variables work (date, year, timestamp)
- [ ] Custom variables work and have highest priority
- [ ] External syntaxes pass through (`${VAR}`, `$ARGUMENTS`)
- [ ] Config variables work and override package.json
- [ ] Conditional block syntax (`{{#...}}`) is NOT matched
- [ ] Unknown variables preserved by default
- [ ] Graceful handling when git/package.json unavailable
- [ ] All tests pass (`npm test -- template-variables.test.ts`)
- [ ] No lint errors (`npm run lint`)
- [ ] Types are strict (no `any`)
- [ ] Exported from `src/transformers/index.ts`
- [ ] plan.md is updated with completion status

## 9. Out of Scope

- **Environment variables via `{{env_VAR}}`** - Use `${VAR}` instead (passed through to platform)
- **Platform variables via `{{arguments}}`** - Use `$ARGUMENTS` (passed through to Claude/Factory)
- Complex expressions in variables (e.g., `{{date | format}}`)
- Nested variable resolution (e.g., `{{{{var}}}}`)
- Async variable resolution from remote sources
- Variable definition in frontmatter (only substitution)
- Conditional variables (use T228 conditional blocks instead)
- Case-insensitive variable names (lowercase only by design)

## 10. Implementation Checklist

1. [ ] Create `src/transformers/template-variables.ts`
2. [ ] Implement `resolveVariables()` helper for loading sources
3. [ ] Implement `getGitConfig()`, `getGitBranch()`, `getGitCommit()` helpers
4. [ ] Implement `loadPackageJson()` helper
5. [ ] Implement `normalizeAuthor()` and `normalizeRepository()` helpers
6. [ ] Implement main `transformTemplateVariables()` function
7. [ ] Export types: `TemplateVariableContext`, `TemplateVariableOptions`
8. [ ] Export from `src/transformers/index.ts`
9. [ ] Create `tests/unit/transformers/template-variables.test.ts`
10. [ ] Add tests for all variable sources
11. [ ] Add tests for priority/override behavior
12. [ ] Add tests for edge cases
13. [ ] Add test fixture with minimal package.json
14. [ ] Run `npm test -- template-variables.test.ts`
15. [ ] Run `npm run lint --fix`
16. [ ] Run `npm run typecheck`
17. [ ] Update plan.md with T229 completion status

## 11. Example Transformations

### Input Content

```markdown
# {{project_name}} v{{version}}

> {{description}}

**Author:** {{author}}  
**License:** {{license}}  
**Repository:** {{repository}}

## Generated Info

- **Branch:** {{git_branch}}
- **Commit:** {{git_commit}}
- **Date:** {{date}}
- **Environment:** ${NODE_ENV} (passed through)

---

© {{year}} {{git_author}}
```

### Context

```typescript
{
  projectRoot: '/path/to/project',
  config: {
    project_name: 'My Awesome Project',  // Overrides package.json
  },
  variables: {
    custom_footer: 'Custom content here',
  },
}
```

### Output (for a typical project)

```markdown
# My Awesome Project v1.0.0

> A sync tool for AI coding assistants

**Author:** John Doe  
**License:** MIT  
**Repository:** https://github.com/user/project

## Generated Info

- **Branch:** main
- **Commit:** abc1234
- **Date:** 2025-12-08
- **Environment:** ${NODE_ENV} (passed through)

---

© 2025 John Doe
```

### Priority Demo

When multiple sources provide the same variable:

| Variable | Custom | Config | package.json | Used Value |
|----------|--------|--------|--------------|------------|
| project_name | - | "Config Name" | "Package Name" | "Config Name" |
| project_name | "Custom" | "Config Name" | "Package Name" | "Custom" |
| version | - | - | "1.0.0" | "1.0.0" |
| author | - | - | "Package Author" | "Package Author" |

