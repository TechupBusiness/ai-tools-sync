# T267: Preserve Subfolder Structure in Rules/Content Deployment

> **Priority**: P2 | **Wave**: 3 | **Track**: F (Content Organization)
> **Depends on**: None
> **Estimated complexity**: Medium

## 1. Objective

When source content is organized in subfolders (e.g., `policies/frontend/react.md`, `skills/testing/unit.md`), preserve that organization in deployed outputs where the target supports it, or encode into filenames otherwise.

## 2. Current Behavior

- `findMarkdownFiles` (src/utils/fs.ts:146) uses `**/*.md` - recursively finds files in subfolders
- `ParsedRule.sourcePath` stores full path but generators only extract basename
- All generators output flat structure regardless of source organization

## 3. Prior Art

- `src/loaders/local.ts:210` - Uses findMarkdownFiles which supports subfolders
- `src/parsers/rule.ts` - ParsedRule has sourcePath field
- `src/generators/cursor.ts` - Generates `.cursor/rules/<name>.mdc`
- `src/generators/claude.ts` - Generates `.claude/skills/<name>/SKILL.md`

## 4. Implementation Requirements

### 4.1 Track Relative Subfolder Path

Add `relativeDir` to parsed content that captures the subfolder path relative to content directory:

    // policies/frontend/react.md → relativeDir: "frontend"
    // skills/testing/integration/api.md → relativeDir: "testing/integration"
    // rules/code-style.md → relativeDir: "" (root)

### 4.2 Target Deployment Strategy

| Target | Subfolder Support | Strategy |
|--------|------------------|----------|
| Cursor | Yes (modern) | `.cursor/rules/<relativeDir>/<name>.mdc` |
| Claude | No (folder per skill) | Name: `<relativeDir>-<name>` (dashes) |
| Factory | No (folder per skill) | Name: `<relativeDir>-<name>` (dashes) |

### 4.3 Config Option

    # config.yaml
    preserve_subfolders: true  # default for Cursor
    # or per-target:
    targets:
      cursor:
        preserve_subfolders: true
      claude:
        preserve_subfolders: false  # encode in name instead

### 4.4 Edge Cases

- Empty relativeDir (root files) → No change to current behavior
- Deeply nested (3+ levels) → Flatten to max 2 levels or full path
- Name collisions after flattening → Warn and use full path encoding
- Windows paths → Normalize to forward slashes

## 5. Test Requirements

- Source `policies/frontend/react.md` → Cursor: `.cursor/rules/frontend/react.mdc`
- Source `skills/testing/unit.md` → Claude: `.claude/skills/testing-unit/SKILL.md`
- Root files remain unchanged
- Config option respected per-target
- Path normalization on Windows

## 6. Acceptance Criteria

- [ ] Parsed content includes relativeDir field
- [ ] Cursor generator creates subdirectories when preserve_subfolders=true
- [ ] Claude/Factory generators encode subfolder in skill name
- [ ] Config option available at root and per-target level
- [ ] Manifest tracks files with correct subdirectory paths
- [ ] No regression for flat source structures

## 7. Out of Scope

- Migrating existing flat deployments to subfolder structure
- Automatic reorganization of source content
- Subfolder support for commands/personas/hooks (rules/skills only for now)