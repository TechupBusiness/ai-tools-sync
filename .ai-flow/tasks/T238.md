# T238: Platform-to-Generic Conversion Skill

> **Priority**: P2 | **Wave**: 3 | **Track**: F (Generic Format Skills)  
> **Depends on**: T231 (lint integration once available)  
> **Estimated complexity**: Medium

## 1. Objective
Automate conversion of existing platform-specific files (`.cursor/`, `.claude/`, `.factory/`, `CLAUDE.md`, `AGENTS.md`, legacy `.cursorrules`) into the generic `.ai-tool-sync/` format. This reduces manual migration, enables immediate parser validation (and rule linting when T231 lands), and produces ready-to-merge generic content for sync/generation pipelines.

## 2. Prior Art (IMPORTANT)
- `src/cli/commands/migrate.ts` – Discovery, platform detection, backup, and interactive flow for importing platform files.
- `src/cli/commands/merge.ts` – Input folder analysis, content-type detection, parser-based validation, and file move/rename decisions.
- `src/transformers/frontmatter.ts` + `targets/{cursor,claude,factory}.yaml` – Forward frontmatter transforms; invert these mappings for import.
- `src/transformers/tool-mapper.ts`, `src/transformers/model-mapper.ts` – Tool/model mapping; extend with reverse mapping for platform → generic.
- `src/parsers/{rule,persona,command,hook}.ts` – Generic schemas to validate converted output; keep snake_case fields.
- Tests: `tests/unit/cli/{migrate,merge}.test.ts` and `tests/unit/generators/{cursor,claude,factory}.test.ts` for patterns on fixtures and golden-file assertions.

## 3. File Structure
```
src/
├── converters/
│   ├── index.ts                   # Public exports
│   ├── types.ts                   # Shared types/errors/options
│   ├── platform-to-generic.ts     # Orchestrator; dispatch per platform/type
│   ├── cursor.ts                  # Cursor-specific import logic
│   ├── claude.ts                  # Claude-specific import logic
│   └── factory.ts                 # Factory-specific import logic
├── cli/
│   └── commands/
│       └── convert.ts             # New CLI command (or migrate --auto-convert) wiring
tests/
└── unit/
    └── converters/
        ├── platform-to-generic.test.ts
        ├── cursor.test.ts
        ├── claude.test.ts
        ├── factory.test.ts
        └── cli-convert.test.ts    # CLI flag/integration; reuse migrate fixtures
```

## 4. Interfaces & Types
Define the contract for conversion and issues.
```typescript
// src/converters/types.ts
export type Platform = 'cursor' | 'claude' | 'factory';
export type GenericKind = 'rule' | 'persona' | 'command' | 'hook';

export interface PlatformFileInput {
  platform: Platform;
  kind: GenericKind | 'config' | 'mixed' | 'unknown';
  sourcePath: string;           // absolute
  relativePath: string;         // from project root
  content: string;
  frontmatter?: Record<string, unknown>;
}

export interface ConversionIssue {
  level: 'error' | 'warning' | 'info';
  message: string;
  path?: string;
  value?: unknown;
  suggestion?: string;
}

export interface GenericConversion {
  kind: GenericKind;
  frontmatter: Rule | Persona | Command | Hook; // from parsers/*
  body: string;                                 // Markdown without platform-only headers
  source: { platform: Platform; path: string };
  warnings: string[];
}

export interface ConvertOptions {
  strict?: boolean;              // treat warnings as errors
  includeUnknown?: boolean;      // allow best-effort on mixed/unknown
  inferNameFromPath?: boolean;   // fallback name heuristic
  runLint?: boolean;             // invoke rule lint once T231 is available
}

export type ConvertResult = Result<GenericConversion[], ConvertError>;

export class ConvertError extends Error {
  constructor(message: string, readonly issues?: ConversionIssue[]) { super(message); }
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- [ ] Use `Result<T, E>` (`src/utils/result.ts`); prefer returning `ConvertError` instead of throwing.
- [ ] Keep generic frontmatter in snake_case; platform-only fields go under `cursor`/`claude`/`factory` extension blocks.
- [ ] Reuse tool/model mappings (add reverse mapping helpers) instead of hardcoding strings.
- [ ] Avoid `any`; respect `exactOptionalPropertyTypes` (conditionally include optional props).
- [ ] Import via `@/` aliases and keep `import/order`.
- [ ] Export only through `src/converters/index.ts`; CLI command re-exported from `src/cli/commands/index.ts`.
- [ ] Preserve unknown/extra platform fields in `...extension` objects rather than dropping silently (warn when skipped).

### 5.2 Critical Logic (Pitfall Prevention)
```typescript
// ❌ WRONG - drops platform-only fields and leaves alwaysApply camelCase in generic
const fm = parsedFm as Record<string, unknown>;
return ok({ frontmatter: { ...fm }, body });

// ✅ CORRECT - normalize and preserve platform-specific data
const normalized = {
  ...mapCursorRuleFrontmatter(fm),      // converts alwaysApply -> always_apply, globs strings -> string[]
  cursor: pickCursorExtensions(fm),     // keep allowedTools, cursor.globs overrides, etc.
  targets: DEFAULT_TARGETS,
};
const issues = collectIssues(normalized); // warnings for unknown tools/models
return ok({ frontmatter: normalized, body, warnings: issues.warnings });
```
- For Cursor rules/commands: split comma-separated globs, coerce `alwaysApply` → boolean `always_apply`, lift `allowedTools` into `cursor.allowedTools` while keeping top-level `allowedTools` when valid for generic commands.
- For Claude/Factory personas: reverse-map tool/model names using existing mappings; keep `reasoningEffort` under `factory.reasoningEffort`; map factory `allowed-tools` → `factory['allowed-tools']`.
- For CLAUDE.md/AGENTS.md mixed files: detect sections; if multiple topics, emit one `ConversionIssue` and place in `input/` untouched.
- Do not assume frontmatter exists; when absent, derive `name` from filename (slugified) and emit warning.
- Before returning success, run parser (`parseRule/parsePersona/...`) to guarantee output is valid generic format; include parse errors as `ConversionIssue` and err if `strict` or `runLint` + lint errors.

### 5.3 Edge Cases to Handle
- [ ] No frontmatter → generate minimal frontmatter with `name`, `targets`, warn.
- [ ] Comma- or newline-separated globs in Cursor files → normalize to string[].
- [ ] `alwaysApply` camelCase in Cursor → map to `always_apply` boolean.
- [ ] Mixed/ambiguous files (multiple H1/H2) → flag `shouldSplit`, copy to `input/` with warning.
- [ ] Unknown or unmapped tools/models → preserve raw value under extension, warn.
- [ ] Duplicate `name` across converted files → warn and suffix filenames, but keep original in frontmatter.
- [ ] Factory droid `reasoningEffort` not in generic schema → move to `factory.reasoningEffort`.
- [ ] Hook/command variable blocks (`variables`, `env`) → keep under extension if not in generic schema.
- [ ] Already-generic files in `.ai-tool-sync/` passed in by mistake → detect and skip with info message.
- [ ] Invalid YAML/frontmatter → surface parse errors with line info; do not drop content.
- [ ] `targets` missing or platform-specific → default to `DEFAULT_TARGETS`.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('platform-to-generic', () => {
  describe('cursor', () => { /* rule/command/persona cases */ });
  describe('claude', () => { /* skill/agent/settings cases */ });
  describe('factory', () => { /* skill/droid/command cases */ });
});

describe('cli convert', () => {
  it('converts simple files directly into .ai-tool-sync/rules', () => { /* ... */ });
  it('copies mixed files to input/ with warning', () => { /* ... */ });
});
```

### 6.2 Required Test Cases
- [ ] Cursor rule with `alwaysApply: true` + comma globs → outputs `always_apply: true` + string[] globs.
- [ ] Cursor command with `allowedTools` → preserved in `cursor.allowedTools`; generic parse passes.
- [ ] Claude agent with `tools/model` → tools/model reverse-mapped to generic; extras kept in `claude` extension.
- [ ] Factory droid with `reasoningEffort` + `allowed-tools` → mapped to generic persona + `factory` extension.
- [ ] CLAUDE.md / AGENTS.md with multiple sections → flagged `mixed`, copied to `input/`, warning emitted.
- [ ] Unknown tool/model values → warning, still converted with raw value under extension.
- [ ] Missing frontmatter → name inferred from filename, description empty, parse succeeds.
- [ ] Duplicate names across converted files → warning + filename suffix to avoid overwrite.
- [ ] CLI flag `--auto-convert` (or `convert` command) writes to `rules/` etc. and exits non-zero on errors in strict mode.
- [ ] Conversion respects `runLint` (mock lint result) when T231 is present.

## 7. Integration Points
- **Imports from**: `src/parsers/{rule,persona,command,hook}.ts`, `src/transformers/{frontmatter,tool-mapper,model-mapper}.ts`, `src/config/loader.ts` (paths), `src/utils/fs.ts` for file IO, `src/utils/result.ts`.
- **Exports to**:
  - `src/cli/commands/convert.ts` (new command) and/or `migrate.ts` flag `--auto-convert` to run conversion instead of raw copy for simple files.
  - `merge.ts` may reuse `GenericConversion` results to drop already-converted files straight into `rules/`/`personas/`/`commands/`/`hooks/`.
- **Config**: Reuse target mappings in `targets/*.yaml` for reverse transforms (avoid hardcoding).

## 8. Acceptance Criteria
- [ ] Conversion API returns `Result` with normalized generic frontmatter and passes parsers.
- [ ] Reverse tool/model mapping implemented and covered by tests.
- [ ] CLI (`ai-sync convert` or `migrate --auto-convert`) writes converted files into `.ai-tool-sync/{rules,personas,commands,hooks}` with warnings for skipped/mixed files.
- [ ] Strict mode exits non-zero on errors (or lint failures when enabled).
- [ ] No `any`, imports use `@/` alias, optional props gated.
- [ ] Tests added under `tests/unit/converters/` and CLI coverage updated.
- [ ] `npm run format:check`, `npm run lint`, and `npm test -- converters` pass.
- [ ] plan.md updated with T238 status once implemented.

## 9. Out of Scope
- Auto-splitting mixed files into multiple generic files (only detect and warn).
- Auto-fix of lint issues (depends on T231 implementation).
- Template variables/file includes (handled by other tasks).
- Importing MCP/entrypoint files (mcp/entrypoints stay unchanged).

## 10. Guidelines for Writing Specs

DO Include:
- Exact interface and conversion contract for platform → generic.
- Mapping notes per platform (globs/always_apply/tools/models) with extension preservation.
- Specific pitfalls from learnings: snake_case in generic, guard undefined optional props, reuse mappings.
- Edge-case checklist and required tests for each platform.

DO NOT Include:
- Full implementation of converters or CLI wiring code.
- Basic TypeScript explanations or obvious parser usage.
- Unrelated optimizations or future template/variable work.

