# T208: Add Factory MCP Generation

> **Priority**: P1 | **Wave**: 1 | **Track**: D (Factory Platform)
> **Depends on**: None
> **Estimated complexity**: Low

## 1. Objective

Enhance Factory MCP generation to produce properly typed MCP server configurations matching Factory's expected format. The current implementation is marked "experimental" and lacks the explicit `type` field that Factory uses to distinguish between `stdio` and `http` transport types.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/generators/factory.ts` lines 629-682 - Current MCP generation (update this)
- `src/generators/claude.ts` lines 843-892 - Claude MCP pattern with typed servers
- `src/parsers/mcp.ts` - MCP server type guards and interfaces
- `tests/unit/generators/factory.test.ts` lines 658-755 - Existing MCP tests (extend these)

## 3. File Structure

```
src/
├── generators/
│   └── factory.ts          # Update generateMcpConfig method
tests/
└── unit/
    └── generators/
        └── factory.test.ts  # Add type field tests
```

## 4. Interfaces & Types

Update the Factory MCP server interfaces in `factory.ts`:

```typescript
/**
 * Factory MCP server (command-based / stdio transport)
 */
interface FactoryMcpServerCommand {
  type: 'stdio';  // ADD: Explicit type field
  command: string;
  args?: string[];
  env?: Record<string, string>;
  cwd?: string;
}

/**
 * Factory MCP server (URL-based / http transport)
 */
interface FactoryMcpServerUrl {
  type: 'http';  // ADD: Explicit type field
  url: string;
  headers?: Record<string, string>;
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [ ] Keep `isCommandServer()` type guard usage from `src/parsers/mcp.ts`
- [ ] Maintain consistency with Claude/Cursor MCP output structure
- [ ] Add `DO_NOT_EDIT_COMMENT_JSON` marker when `addHeaders` is true
- [ ] Filter servers by target using `filterContentByTarget()` (already done)

### 5.2 Critical Logic (Pitfall Prevention)

```typescript
// ❌ WRONG - Current implementation (missing type field)
const factoryServer: FactoryMcpServerCommand = {
  command: server.command,
};

// ✅ CORRECT - Add explicit type field
const factoryServer: FactoryMcpServerCommand = {
  type: 'stdio',
  command: server.command,
};

// For URL servers:
const factoryServer: FactoryMcpServerUrl = {
  type: 'http',
  url: server.url,
};
```

### 5.3 Edge Cases to Handle

- [ ] Command server → Output `type: 'stdio'`
- [ ] URL server → Output `type: 'http'`
- [ ] Empty MCP config → Don't generate file (already handled)
- [ ] No factory-targeted servers → Don't generate file (already handled)
- [ ] Server with env vars → Include `env` object with type field
- [ ] Server with cwd → Include `cwd` with type field

### 5.4 Remove Experimental Warning

The current implementation adds this warning:
```typescript
result.warnings.push(
  'Factory MCP support is experimental. Generated mcp.json may need manual adjustment.'
);
```

Remove this warning after implementing the proper type fields, as the output will match Factory's expected format.

## 6. Test Requirements

### 6.1 Test File Structure

Extend `tests/unit/generators/factory.test.ts`:

```typescript
describe('MCP generation', () => {
  // Existing tests...
  
  describe('type field', () => {
    it('should include type: "stdio" for command servers');
    it('should include type: "http" for URL servers');
    it('should not include experimental warning');
  });
});
```

### 6.2 Required Test Cases

- [ ] Command server generates `type: 'stdio'`
- [ ] URL server generates `type: 'http'`  
- [ ] Mixed servers (both types) generate correct types
- [ ] No experimental warning in result.warnings for valid config
- [ ] Generated JSON structure matches Factory format:
  ```json
  {
    "mcpServers": {
      "server-name": {
        "type": "stdio",
        "command": "...",
        "args": [...]
      }
    }
  }
  ```

### 6.3 Reference Similar Tests

Copy test patterns from:
- `tests/unit/generators/factory.test.ts` lines 675-715 (existing MCP tests)
- `tests/unit/generators/claude.test.ts` lines 938-1040 (Claude MCP tests for structure patterns)

## 7. Integration Points

- **Imports from**: `src/parsers/mcp.ts` (`isCommandServer`, `McpConfig`)
- **Exports to**: Used by sync pipeline via `FactoryGenerator.generate()`
- **Config**: Uses `mcpConfig` from `ResolvedContent`

## 8. Acceptance Criteria

- [ ] Command servers include `type: 'stdio'` in output
- [ ] URL servers include `type: 'http'` in output
- [ ] Experimental warning removed from MCP generation
- [ ] All existing MCP tests still pass
- [ ] New type field tests pass
- [ ] No lint errors (`npm run lint`)
- [ ] Types are strict (no `any`)

## 9. Out of Scope

- Adding new MCP transport types (SSE, WebSocket)
- Factory hooks support (T207)
- MCP server validation changes (handled in parser)

## 10. Implementation Checklist

1. [x] Update `FactoryMcpServerCommand` interface to include `type: 'stdio'`
2. [x] Update `FactoryMcpServerUrl` interface to include `type: 'http'`
3. [x] Update `generateMcpConfig()` to add type field to each server
4. [x] Remove experimental warning from MCP generation
5. [x] Add tests for type field presence
6. [x] Verify existing tests still pass
7. [ ] Run lint and fix any issues

### Completed 2025-12-08
- All 51 factory tests pass
- Type field added to both stdio and http servers
- Experimental warning removed

