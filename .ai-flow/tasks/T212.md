# T212 - Remove Pre-Release Backward Compatibility Code

**Priority:** P1
**Status:** In Progress
**Wave:** 1 (Track E: Pre-Release Cleanup)

## Overview

Before shipping v1.0, we need to remove backward compatibility code that was added prematurely during development. Since the project hasn't been released yet, we can make breaking changes freely. Once v1.0 ships, we must preserve backward compatibility or provide migrations.

## Rationale

The codebase contains several backward compatibility patterns that:
1. Add unnecessary complexity
2. Support formats/events that were never publicly documented
3. Create maintenance burden for code paths that have zero users

Cleaning these up before release results in a simpler, cleaner v1.0 API surface.

## Scope

### 1. Remove Legacy Hook Events

**Files:**
- `src/parsers/hook.ts`
- `src/generators/claude.ts`
- `src/generators/factory.ts`
- `src/loaders/claude-plugin.ts`

**Current State:**
The hook system supports three legacy event names that map to modern equivalents:

| Legacy Event | Maps To | Default Behavior |
|--------------|---------|------------------|
| `PreMessage` | `UserPromptSubmit` | Direct mapping |
| `PostMessage` | `PostToolUse` | Direct mapping |
| `PreCommit` | `PreToolUse` | Adds `matcher: 'Bash(git commit*)'` |

**Changes Required:**

#### 1.1 `src/parsers/hook.ts`

Remove legacy events from `VALID_EVENTS` array (lines ~33-53):

```typescript
// BEFORE
const VALID_EVENTS: HookEvent[] = [
  'UserPromptSubmit',
  'PreToolUse',
  'PostToolUse',
  'Notification',
  'Stop',
  'SubagentStop',
  'SessionStart',
  'SessionEnd',
  'PreCompact',
  // Legacy (backwards compat)
  'PreMessage',
  'PostMessage',
  'PreCommit',
];

// AFTER
const VALID_EVENTS: HookEvent[] = [
  'UserPromptSubmit',
  'PreToolUse',
  'PostToolUse',
  'Notification',
  'Stop',
  'SubagentStop',
  'SessionStart',
  'SessionEnd',
  'PreCompact',
];
```

Update the `HookEvent` type definition to remove legacy events.

#### 1.2 `src/generators/claude.ts`

Remove legacy mappings from `mapEventToClaude()` (lines ~114-133):

```typescript
// BEFORE
const eventMap: Record<string, ClaudeHookEvent> = {
  'UserPromptSubmit': 'UserPromptSubmit',
  'PreToolUse': 'PreToolUse',
  'PostToolUse': 'PostToolUse',
  // ... other events ...
  // Legacy event mappings
  'PreMessage': 'UserPromptSubmit',
  'PostMessage': 'PostToolUse',
  'PreCommit': 'PreToolUse',
};

// AFTER
const eventMap: Record<string, ClaudeHookEvent> = {
  'UserPromptSubmit': 'UserPromptSubmit',
  'PreToolUse': 'PreToolUse',
  'PostToolUse': 'PostToolUse',
  // ... other events (no legacy mappings) ...
};
```

Remove the PreCommit default matcher logic (lines ~657-660):

```typescript
// DELETE THIS BLOCK
// Handle legacy PreCommit event - add default matcher if not specified
if (hook.frontmatter.event === 'PreCommit' && !output.matcher) {
  output.matcher = 'Bash(git commit*)';
}
```

#### 1.3 `src/generators/factory.ts`

Same changes as claude.ts:
- Remove legacy mappings from event map (lines ~121-140)
- Remove PreCommit default matcher logic (lines ~654-659)

#### 1.4 `src/loaders/claude-plugin.ts`

Remove legacy event mappings from the event map (lines ~928-942):

```typescript
// BEFORE
const eventMap: Record<string, HookEvent> = {
  UserPromptSubmit: 'UserPromptSubmit',
  // ... other events ...
  // Legacy mappings
  PreMessage: 'PreMessage',
  PostMessage: 'PostMessage',
  PreCommit: 'PreCommit',
};

// AFTER
const eventMap: Record<string, HookEvent> = {
  UserPromptSubmit: 'UserPromptSubmit',
  PreToolUse: 'PreToolUse',
  PostToolUse: 'PostToolUse',
  // ... only modern events ...
};
```

---

### 2. Remove Legacy settings.json Hook Loading

**Files:**
- `src/loaders/claude-plugin.ts`

**Current State:**
The plugin loader checks for hooks in two locations:
1. `<pluginPath>/hooks/hooks.json` (modern)
2. `<pluginPath>/settings.json` (legacy fallback)

**Changes Required:**

Remove `settings.json` from the candidates list in `findHooksFile()` (lines ~635-657):

```typescript
// BEFORE
private findHooksFile(pluginPath: string): string | undefined {
  const candidates = [
    path.join(pluginPath, 'hooks', 'hooks.json'),
    path.join(pluginPath, 'settings.json'),  // legacy
  ];
  // ...
}

// AFTER
private findHooksFile(pluginPath: string): string | undefined {
  const candidates = [
    path.join(pluginPath, 'hooks', 'hooks.json'),
  ];
  // ...
}
```

Remove any special handling in `extractHooksObject()` for the settings.json format (lines ~902-916).

---

### ~~3. Remove `always_apply` Field Mapping~~ (CANCELLED)

**Decision:** This section should NOT be implemented.

**Rationale:**
The `always_apply` → `alwaysApply` mapping is **not** backward compatibility code. It's the correct transformer behavior because:

1. The generic format (`.ai-tools-sync/`) should be **tool-agnostic** and use snake_case naming conventions (`always_apply`)
2. The transformers exist precisely to convert from the generic format to each tool's expected format
3. Cursor expects `alwaysApply` (camelCase), so the transformer correctly maps `always_apply` → `alwaysApply`

**Keep the existing transformer mapping in `src/transformers/frontmatter.ts`.**

---

### 4. Update Tests

**Files:**
- `tests/unit/parsers/hook.test.ts`
- `tests/unit/generators/claude.test.ts`
- `tests/unit/generators/factory.test.ts`
- `tests/unit/loaders/claude-plugin.test.ts`

**Changes Required:**

#### 4.1 `tests/unit/parsers/hook.test.ts`

- Remove test cases that validate legacy events are accepted
- Add test cases that verify legacy events are **rejected** as invalid

#### 4.2 `tests/unit/generators/claude.test.ts`

Remove tests (lines ~345-379):
- "should map PreMessage to UserPromptSubmit"
- "should map PreCommit to PreToolUse with default matcher"

#### 4.3 `tests/unit/generators/factory.test.ts`

Remove tests (lines ~493-529):
- "should map legacy events"
- "should add default matcher for PreCommit"

#### 4.4 `tests/unit/loaders/claude-plugin.test.ts`

Remove test (lines ~257-263):
- "should prefer hooks/hooks.json over settings.json when both exist"

---

## What NOT to Remove

The following should be **preserved** as they serve different purposes:

### 1. `.cursorrules` Detection in Migrate Command
- **Location:** `src/cli/commands/migrate.ts`
- **Reason:** This migrates **external** legacy files that users may have from before they adopted ai-tools-sync. It's a user-facing migration tool, not internal backward compat.

### 2. Version Compatibility Checking
- **Location:** `src/config/defaults.ts`, `src/config/validator.ts`
- **Reason:** This is forward-looking infrastructure for maintaining compatibility between config file versions and tool versions after v1.0 ships.

### 3. Target-Specific Frontmatter Transformers
- **Location:** `src/transformers/frontmatter.ts`
- **Reason:** `transformForCursor()`, `transformForClaude()`, `transformForFactory()` are current architecture, not legacy code.

---

## Implementation Order

1. **Update type definitions** - Remove legacy events from `HookEvent` type
2. **Update parser** - Remove legacy events from `VALID_EVENTS`
3. **Update generators** - Remove legacy mappings from claude.ts and factory.ts
4. **Update loader** - Remove settings.json fallback and legacy event maps
5. ~~**Update transformer** - Remove always_apply mapping~~ (CANCELLED - see Section 3)
6. **Update tests** - Remove legacy test cases, add rejection tests
7. **Run full test suite** - Ensure no regressions

---

## Estimated Impact

- **Lines removed:** ~100-150 lines across 5 source files
- **Tests modified:** 4 test files
- **Risk:** Low (removing unused code paths)

---

## Acceptance Criteria

- [x] Legacy hook events (`PreMessage`, `PostMessage`, `PreCommit`) are rejected by parser
- [x] Plugin loader only checks `hooks/hooks.json`, not `settings.json`
- ~~[ ] Frontmatter transformer only accepts `alwaysApply`, not `always_apply`~~ (CANCELLED)
- [x] All tests pass
- [x] No TypeScript errors
- [ ] Code review completed

---

## Post-1.0 Note

After v1.0 is released, any changes to the hook event names, file formats, or field names will require:
1. Deprecation warnings for at least one minor version
2. Migration documentation
3. Backward compatibility support or automatic migration tooling
