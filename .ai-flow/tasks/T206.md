# T206: Add Factory Droids Support

> **Priority**: P1 | **Wave**: 1 | **Track**: D (Factory Platform)
> **Depends on**: None
> **Estimated complexity**: Medium

## 1. Objective

Enhance the Factory generator to support Factory-specific droid configuration. Currently, droids are generated with basic tool and model mapping but don't support Factory's unique features: platform-specific tool overrides (`factory.tools`), model overrides (`factory.model`), and reasoning effort control (`factory.reasoningEffort`). This task brings Factory droids to feature parity with Claude agents.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/generators/claude.ts` lines 377-436 - **Copy the agent file generation pattern** with platform-specific overrides (`claude.tools`, `claude.model`)
- `src/parsers/types.ts` lines 46-61 - **FactoryExtension interface** already has `tools`, `model`, and `reasoningEffort` fields
- `src/generators/factory.ts` lines 314-371 - **Current droid generation** to enhance (doesn't use factory extensions)
- `tests/unit/generators/claude.test.ts` lines 243-269 - **Test pattern for platform-specific overrides**

## 3. File Structure

```
src/
├── generators/
│   └── factory.ts        # Modify generateDroidFile method
tests/
└── unit/
    └── generators/
        └── factory.test.ts   # Add new test cases for droid features
```

No new files needed - this is an enhancement to existing code.

## 4. Interfaces & Types

The `FactoryExtension` interface already exists in `src/parsers/types.ts`:

```typescript
// Already defined - NO CHANGES NEEDED
export interface FactoryExtension {
  'allowed-tools'?: string[];  // Reserved for skills
  tools?: string[];            // Tool restrictions for droids
  model?: string;              // Model override for droids
  reasoningEffort?: 'low' | 'medium' | 'high';  // Reasoning control
  variables?: Array<{          // For commands
    name: string;
    description?: string;
    default?: string;
  }>;
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [ ] Use `mapTools()` from `src/transformers/tool-mapper.ts` for tool mapping
- [ ] Use `mapModel()` from `src/transformers/model-mapper.ts` for model mapping
- [ ] Prefer `factory.*` extension values over generic values (same as Claude pattern)
- [ ] Export only from existing barrel files (no new exports needed)
- [ ] Follow existing Factory file structure conventions

### 5.2 Critical Logic (Pitfall Prevention)

Modify `generateDroidFile` to use Factory-specific overrides when present:

```typescript
// ❌ WRONG - Current implementation (doesn't use factory extension)
private generateDroidFile(persona: ParsedPersona, options: GeneratorOptions): GeneratedFile {
  const tools = persona.frontmatter.tools ?? [];
  const mappedTools = mapTools(tools, 'factory');
  const model = mapModel(persona.frontmatter.model ?? 'default', 'factory');
  // ...
}

// ✅ CORRECT - Use factory-specific overrides (copy Claude pattern)
private generateDroidFile(persona: ParsedPersona, options: GeneratorOptions): GeneratedFile {
  // Prefer factory-specific overrides when present
  const tools = persona.frontmatter.factory?.tools ?? persona.frontmatter.tools ?? [];
  const mappedTools = mapTools(tools, 'factory');
  
  // Map model with factory-specific override
  const model = mapModel(
    persona.frontmatter.factory?.model ?? persona.frontmatter.model ?? 'default',
    'factory'
  );
  
  // Get reasoning effort (Factory-specific, no generic equivalent)
  const reasoningEffort = persona.frontmatter.factory?.reasoningEffort;
  // ...
}
```

Output format for droid files should include reasoningEffort:

```typescript
// In the Configuration section of droid files:
if (model && model !== 'default') {
  parts.push(`- **Model:** ${model}`);
}

if (mappedTools.length > 0) {
  parts.push(`- **Tools:** ${mappedTools.join(', ')}`);
}

// Add reasoningEffort to output (NEW)
if (reasoningEffort) {
  parts.push(`- **Reasoning Effort:** ${reasoningEffort}`);
}
```

### 5.3 Edge Cases to Handle

- [ ] `factory.tools` is empty array `[]` → Use empty tools (explicit restriction)
- [ ] `factory.tools` is undefined → Fall back to generic `tools`
- [ ] `factory.model` is undefined → Fall back to generic `model`
- [ ] `reasoningEffort` is undefined → Don't include in output
- [ ] Both `factory.tools` and generic `tools` are undefined → Use `PERSONA_DEFAULTS.tools`
- [ ] Model is `'default'` → Don't show model line (inherits platform default)

## 6. Test Requirements

### 6.1 Test File Structure

Add to `tests/unit/generators/factory.test.ts`:

```typescript
describe('generate() - droids (personas)', () => {
  // ... existing tests ...

  describe('factory-specific overrides', () => {
    it('should prefer factory.tools over generic tools', async () => { /* ... */ });
    it('should prefer factory.model over generic model', async () => { /* ... */ });
    it('should include reasoningEffort when specified', async () => { /* ... */ });
    it('should not include reasoningEffort when not specified', async () => { /* ... */ });
    it('should handle empty factory.tools as explicit restriction', async () => { /* ... */ });
  });
});
```

### 6.2 Required Test Cases

- [ ] **Basic override**: `factory.tools` overrides generic `tools`

```typescript
it('should prefer factory.tools over generic tools', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [
      createMockPersona('dev', {
        tools: ['read', 'write'],  // Generic
        factory: {
          tools: ['execute', 'search'],  // Factory-specific
        },
      }),
    ],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/dev.md'),
    'utf-8'
  );
  
  // Should use Factory-mapped names for factory.tools
  expect(fileContent).toContain('execute');
  expect(fileContent).toContain('search');
  // Should NOT have generic tools
  expect(fileContent).not.toContain('- **Tools:** read');
});
```

- [ ] **Model override**: `factory.model` overrides generic `model`

```typescript
it('should prefer factory.model over generic model', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [
      createMockPersona('dev', {
        model: 'fast',  // Generic
        factory: {
          model: 'powerful',  // Factory-specific
        },
      }),
    ],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/dev.md'),
    'utf-8'
  );
  
  expect(fileContent).toContain('**Model:** powerful');
  expect(fileContent).not.toContain('fast');
});
```

- [ ] **Reasoning effort**: Include when specified

```typescript
it('should include reasoningEffort when specified', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [
      createMockPersona('deep-thinker', {
        factory: {
          reasoningEffort: 'high',
        },
      }),
    ],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/deep-thinker.md'),
    'utf-8'
  );
  
  expect(fileContent).toContain('**Reasoning Effort:** high');
});
```

- [ ] **Reasoning effort omitted**: Don't include when not specified

```typescript
it('should not include reasoningEffort when not specified', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [createMockPersona('basic-dev')],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/basic-dev.md'),
    'utf-8'
  );
  
  expect(fileContent).not.toContain('Reasoning Effort');
});
```

- [ ] **Empty tools override**: Empty array is explicit restriction

```typescript
it('should handle empty factory.tools as explicit restriction', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [
      createMockPersona('restricted', {
        tools: ['read', 'write', 'execute'],  // Generic
        factory: {
          tools: [],  // Explicitly no tools
        },
      }),
    ],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/restricted.md'),
    'utf-8'
  );
  
  // Should NOT show Tools line (empty tools = no tools)
  expect(fileContent).not.toContain('**Tools:**');
});
```

- [ ] **All three combined**: Test all overrides together

```typescript
it('should apply all factory-specific overrides together', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    personas: [
      createMockPersona('factory-agent', {
        tools: ['read'],
        model: 'fast',
        factory: {
          tools: ['execute', 'search', 'edit'],
          model: 'powerful',
          reasoningEffort: 'medium',
        },
      }),
    ],
  });

  await generator.generate(content);

  const fileContent = await fs.readFile(
    path.join(tempDir, '.factory/droids/factory-agent.md'),
    'utf-8'
  );
  
  expect(fileContent).toContain('**Model:** powerful');
  expect(fileContent).toContain('execute');
  expect(fileContent).toContain('search');
  expect(fileContent).toContain('edit');
  expect(fileContent).toContain('**Reasoning Effort:** medium');
});
```

## 7. Integration Points

- **Imports from**: 
  - `src/transformers/tool-mapper.ts` - use `mapTools()`
  - `src/transformers/model-mapper.ts` - use `mapModel()`
- **Exports to**: No new exports (enhancing existing generator)
- **Config**: No config schema changes needed (`FactoryExtension` already exists)

## 8. Acceptance Criteria

- [ ] All existing tests still pass (`npm test -- factory.test.ts`)
- [ ] New tests for factory-specific overrides pass
- [ ] `factory.tools` overrides generic `tools` in droid output
- [ ] `factory.model` overrides generic `model` in droid output
- [ ] `reasoningEffort` appears in droid Configuration section when specified
- [ ] No lint errors (`npm run lint`)
- [ ] Types are strict (no `any`, using existing `FactoryExtension`)

## 9. Out of Scope

- Factory hooks support (handled in T207)
- Factory MCP generation (handled in T208)
- Factory skills generation (handled in T209)
- Changes to persona parser (already supports `factory` extension)
- New CLI options

## 10. Implementation Checklist

1. [ ] Read the Claude generator pattern for agents (`src/generators/claude.ts` lines 377-436)
2. [ ] Modify `generateDroidFile` in `src/generators/factory.ts` to use `factory.*` overrides
3. [ ] Add `reasoningEffort` to droid Configuration section output
4. [ ] Write test cases in `tests/unit/generators/factory.test.ts`
5. [ ] Run `npm test -- factory.test.ts` to verify all tests pass
6. [ ] Run `npm run lint` to verify no lint errors
7. [ ] Manually test with a sample persona that has `factory` extension

