# T244: Create GitHub Release Workflow

> **Priority**: P0 | **Wave**: 1 | **Track**: B (npm Publishing)  
> **Depends on**: T243  
> **Estimated complexity**: Medium

## 1. Objective
Add an automated GitHub Actions workflow that, on version tags, builds and tests the package, publishes the npm package with the correct dist + tag, and creates a GitHub release with generated notes and attached artifacts. This removes manual release risk and is a prerequisite for first publish (T245).

## 2. Prior Art (IMPORTANT)
- `.github/workflows/release.yml` - Existing release flow; reuse naming/permissions but replace/upgrade logic.  
- `.github/workflows/publish.yml` - Current publish-on-release job; decide to fold into the new release workflow or deprecate to avoid double publishes.  
- `.github/workflows/test.yml` - Patterns for Node setup, caching, matrix, and build/test steps.  
- `plan.md` (Publishing Instructions Reference, Release snippet) - Baseline for tag trigger and softprops release notes.  
- `package.json` - Source of package name/version; must match tag.  
- `docs/CONFIGURATION.md` (if referenced in README) - For documenting any required secrets/env.

## 3. File Structure
```
.github/workflows/
├── release.yml            # New/updated release + publish workflow (this task)
├── publish.yml            # Remove or simplify if superseded to prevent double publish
├── test.yml               # Reused patterns for cache/setup
scripts/
└── changelog.sh|ts (opt)  # If needed to generate changelog content
dist/                      # Built artifacts to optionally attach (npm pack tarball)
```

## 4. Interfaces & Types
```typescript
interface ReleaseJobOutputs {
  version: string;           // e.g., 0.1.0 pulled from tag v0.1.0
  npmTag: 'latest' | 'next'; // latest for stable, next for prerelease (contains '-')
  tarballPath: string;       // path from `npm pack --json`
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- Trigger on pushed tags `v*.*.*` (semver) and support `workflow_dispatch` for dry runs.  
- Use Node `22` with `actions/setup-node@v4`, `cache: npm`, `registry-url: https://registry.npmjs.org`.  
- `permissions`: `contents: write`, `packages: write` (if needed), `id-token: write` for provenance; default read-only elsewhere.  
- `checkout` with `fetch-depth: 0` so changelog can diff previous tag.  
- Steps order: `npm ci` → `npm run build` → `npm test` → `npm pack --json` → `npm publish`.  
- Source of truth for npm auth: `${{ secrets.NPM_TOKEN }}` as `NODE_AUTH_TOKEN`; never echo secrets.  
- Keep naming/comments consistent with existing workflows (section banners, job names).  
- If publish.yml remains, guard it (`if: false` or remove) to avoid double publish once new release.yml is active.

### 5.2 Critical Logic (Pitfall Prevention)
```bash
# Derive version/tag safely
TAG="${GITHUB_REF#refs/tags/v}"
if [[ -z "$TAG" || "$TAG" != *.*.* ]]; then
  echo "Tag must be semver vX.Y.Z"; exit 1;
fi

# Enforce package.json version matches tag
PKG_VERSION=$(node -p "require('./package.json').version")
test "$PKG_VERSION" = "$TAG" || { echo "package.json ($PKG_VERSION) != tag ($TAG)"; exit 1; }

# Choose npm dist-tag
if [[ "$TAG" == *"-"* ]]; then NPM_TAG=next; else NPM_TAG=latest; fi
```
- Fail early if `NPM_TOKEN` missing; add a secret check step.  
- Use `npm publish --provenance --access public --tag $NPM_TAG` (Node 20+ needs `id-token: write`).  
- Generate release notes via `softprops/action-gh-release@v2` with changelog from git log between previous tag and current tag; include install snippets using the scoped package name.  
- Attach the `npm pack` tarball (and optional zipped `dist/`) to the GitHub release.  
- Add concurrency guard to prevent duplicate publishes on the same tag (`concurrency: release-${{ github.ref }}`).

### 5.3 Edge Cases to Handle
- [x] Pre-release tags containing `-` publish with `next` dist-tag and mark GitHub prerelease.  
- [x] Missing or malformed tag (non-semver) → fail with clear message, skip publish.  
- [x] Tag/package version mismatch → fail before publish/release creation.  
- [x] Rerun-on-failure should not republish if the version already exists on npm; add `npm view $PKG_VERSION` check and short-circuit if published.  
- [x] Secrets absent (`NPM_TOKEN`) → fail fast with actionable error.  
- [x] Preserve changelog generation when no previous tag (first release).  
- [x] Do not leak secrets/logs; mask token, avoid verbose npm output flags that print auth.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('release workflow', () => {
  it('validates tag vs package.json');    // script step
  it('computes npm dist-tag correctly');  // latest vs next
  it('attaches npm pack artifact');       // workflow outputs
});
```

### 6.2 Required Test Cases
- [ ] `npm pack --dry-run` (or `npm pack --json`) produces artifact path and is uploaded.  
- [ ] `workflow_dispatch` dry run passes build/tests without calling `npm publish` (guard by input).  
- [ ] Tag `v1.2.3` → `npmTag=latest`, prerelease flag false, release created.  
- [ ] Tag `v1.2.3-beta.1` → `npmTag=next`, prerelease flag true.  
- [ ] Tag/package version mismatch causes early failure.  
- [ ] Rerun on same tag skips publish if already on npm (idempotent).  
- [ ] Optional: `act` or `gh workflow run` dry run documented for local verification.

## 7. Integration Points
- **Secrets**: `NPM_TOKEN` (required), optional `CODECOV_TOKEN` not used here.  
- **Artifacts**: Tarball from `npm pack` (attach to GitHub release).  
- **Upstream**: Depends on T243 for correct package metadata.  
- **Downstream**: Enables T245 (first publish) and Homebrew/Docker tracks that rely on GitHub releases.  
- **CI Alignment**: Reuse Node version/cache from `test.yml`; ensure release job doesn’t conflict with existing `publish.yml` triggers.

## 8. Acceptance Criteria
- [x] `.github/workflows/release.yml` triggers on `v*` tags and optional manual runs.  
- [x] Workflow runs build + tests before any publish/release steps.  
- [x] npm publish uses correct dist-tag (`latest` stable, `next` prerelease) and provenance.  
- [x] GitHub release created with generated notes and attached `npm pack` artifact.  
- [x] Tag/package version validation enforced; fail-fast on mismatch or missing secrets.  
- [x] No duplicate publish when rerun on the same tag; idempotency guard present.  
- [x] plan.md updated to reflect T244 spec/implementation status.

## 11. Implementation Notes
- `release.yml` now handles tag + workflow_dispatch releases, validates semver tag vs `package.json`, and selects dist-tag (`latest`/`next`) with prerelease flag.  
- Publishes via `npm publish --provenance --access public --tag ${{ npm_tag }}` when `NPM_TOKEN` is present and version not already on npm (`npm view` guard).  
- Attaches `npm pack` tarball to the GitHub release; changelog is derived from previous tag (or full history when none).  
- Concurrency is scoped per tag; `publish.yml` is disabled (`if: false`) to prevent double publishes.  

## 9. Out of Scope
- Homebrew/Docker/binary packaging (T246-T248).  
- First live publish execution (T245).  
- Changelog formatting tooling overhaul beyond basic git log generation.  
- Version bumping workflow (`npm version`) automation.

## 10. Guidelines for Writing Specs
- Include explicit tag/semver validation and dist-tag selection logic.  
- Reference concrete files/actions to copy (release.yml, publish.yml, test.yml).  
- Keep steps minimal and deterministic; avoid bespoke scripts unless necessary.  
- Call out secret requirements and failure modes so a junior can implement without guesswork.

