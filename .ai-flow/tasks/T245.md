# T245: First npm publish

> **Priority**: P0 | **Wave**: 1 | **Track**: B (npm Publishing)  
> **Depends on**: T244  
> **Estimated complexity**: Medium

## 1. Objective
Perform the first public npm publish of `ai-tool-sync` with a clean build, validated package contents, and verified installation so downstream tracks (Homebrew, Docker, examples) have a trusted artifact to build on.

## 2. Prior Art (IMPORTANT)
- `package.json` — Current name (`@techupbusiness/ai-tool-sync`), scripts (`build`, `prepublishOnly`, `prepare`), files whitelist (`dist`, `bin`, `defaults`, `targets`), bin mapping.
- `.ai-flow/plan.md` — Wave 1 Track B steps and **Publishing Instructions Reference** (npm login, build/test, `npm pack --dry-run`, publish, verify install).
- `.github/workflows/test.yml` — CI matrix (includes `windows-latest`); mirror its setup for prepublish checks to avoid parity issues.
- `README.md` — Installation/usage text that must match the published package name and version once live.
- `CHANGELOG.md` (T241) — Release notes for the version being published; keep date/version aligned with the published tag.
- `bin/ai-sync.js` — CLI entry shipped in the package; ensure built outputs stay in sync with this entry point.

## 3. File Structure
```
package.json                   # Metadata, scripts, files list, bin mapping
dist/**                        # Built artifacts generated by tsup
bin/ai-sync.js                 # CLI entry (published)
defaults/**, targets/**        # Published assets referenced by generators
.github/workflows/release.yml  # From T244; executes the publish step
README.md, CHANGELOG.md        # User-facing docs that must match the release
```

## 4. Interfaces & Types
```typescript
// No new runtime APIs expected. If a publish helper script is added,
// keep its options minimal and typed; prefer Result<T, E> over throws.
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- [ ] Use `Result<T, E>` and `BaseError` if adding any publish helper code; only throw at the CLI boundary.
- [ ] Keep generic formats tool-agnostic (T212); no target-specific field names in package metadata.
- [ ] Avoid `any`; prefer `unknown` + guards, and include optional keys only when defined (T004, T159, T160).
- [ ] Respect `@/` aliases and `import/order` if adding TS; run lint/typecheck outside sandbox (T002, T206, T228, T005, T210).
- [ ] Reuse existing scripts; do not bypass `prepublishOnly` (`npm run build && npm test`) unless explicitly updated in this task.

### 5.2 Critical Logic (Pitfall Prevention)
```bash
# ❌ WRONG - publishing without a clean build or package audit
npm publish

# ✅ CORRECT - verified pipeline before publish
npm whoami             # ensure npm login + 2FA/OTP ready
npm ci
npm test               # uses T255-adjusted script or cross-env on Windows
npm run build
npm pack --dry-run     # confirm dist/bin/defaults/targets are included, nothing extra
npm publish --access public [--provenance]  # provenance optional if token supports it
npm view @techupbusiness/ai-tool-sync version
npm install -g @techupbusiness/ai-tool-sync && ai-sync --version
```
- Ensure package version is unpublished; bump if npm returns "previously published".
- If publishing via GitHub Actions (T244), set `NODE_AUTH_TOKEN` with an automation token; enable OIDC/provenance only if supported by the npm org.
- `prepublishOnly` depends on `npm test`; if running on Windows prior to T255, invoke via `cross-env` or a Unix shell to avoid `NODE_OPTIONS` parsing failures.

### 5.3 Edge Cases to Handle
- [ ] NPM 2FA prompts block publish → use OTP or automation token with `--access public`.
- [ ] Stale `dist/` or missing `bin/` after clean checkout → rerun `npm run build` before packing.
- [ ] Unexpected files in tarball (e.g., `docs/`, `.ai-flow/`) → adjust `files` list or `.npmignore` before publishing.
- [ ] Global install sanity check fails (`ai-sync --version` missing) → verify `bin` path and shebang in published tarball.
- [ ] Windows CI matrix still uses POSIX `NODE_OPTIONS` → coordinate with T255 or temporarily run tests in a POSIX shell for the publish job.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('npm publish readiness', () => {
  it('builds successfully', () => {/* npm run build */});
  it('passes tests', () => {/* npm test */});
  it('packages expected files', () => {/* npm pack --dry-run inspection */});
  it('installs and runs CLI', () => {/* npm install -g && ai-sync --version */});
});
```

### 6.2 Required Test Cases
- [ ] `npm test` passes (use cross-platform command from T255 when available).
- [ ] `npm run build` succeeds from a clean checkout.
- [ ] `npm pack --dry-run` shows only `dist`, `bin`, `defaults`, `targets`, package metadata (no dev artifacts).
- [ ] `npm publish --access public` succeeds for the target version.
- [ ] `npm view @techupbusiness/ai-tool-sync version` matches the published version.
- [ ] Fresh global install works: `npm install -g @techupbusiness/ai-tool-sync` then `ai-sync --version`.

## 7. Integration Points
- **Release workflow (T244)**: Should run `npm ci`, `npm test`, `npm run build`, `npm publish --access public` with `NODE_AUTH_TOKEN`; optionally add `--provenance`.
- **prepublishOnly/prepare**: Local/manual publishes rely on existing scripts; keep them intact so `npm publish` enforces build+test.
- **Docs alignment**: Update `README.md`/`CHANGELOG.md` if package name/version changes before publishing.
- **CI parity**: `.github/workflows/test.yml` remains the authoritative test matrix; ensure publish environment matches node version there (>=18).

## 8. Acceptance Criteria
- [ ] npm publish for the target version completes successfully and the package is visible on npm (`npm view @techupbusiness/ai-tool-sync version`).
- [ ] Published tarball includes only `dist/`, `bin/`, `defaults/`, `targets/`, and required metadata; no dev/test artifacts.
- [ ] `npm test`, `npm run build`, and `npm pack --dry-run` are clean in the publish environment.
- [ ] Fresh install works (`npm install -g @techupbusiness/ai-tool-sync` → `ai-sync --version` returns the published version).
- [ ] Release workflow (T244) is configured to publish with `NODE_AUTH_TOKEN` and mirrors the verified steps.
- [ ] `plan.md` updated to reflect T245 completion status once done.

## 9. Out of Scope
- Homebrew formula/tap (T246, T247), Docker image (T248), npx/standalone packaging (T249), install script (T250), ecosystem announcements (T252).
- Changing the package scope/name or adding new features beyond publish-readiness.
- Creating the release workflow itself (T244 handles the workflow file).

## 10. Guidelines for Writing Specs
- Include explicit commands and checks (`npm pack --dry-run`, `npm view`, install test) so a junior can publish without guesswork.
- Call out 2FA/token requirements and the prepublish script dependency to avoid failed publishes.
- Keep instructions tool-agnostic and aligned with plan.md Publishing Instructions Reference.

