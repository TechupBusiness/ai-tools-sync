# T161: Write Tests for Plugin System

> **Priority**: P2 | **Wave**: 3 | **Track**: A (Plugin System)
> **Depends on**: T155, T156, T157, T158
> **Estimated complexity**: Medium

## 1. Objective

Create comprehensive test coverage for the plugin system components including plugin.json manifest parsing (T155), hooks.json transformation (T156), MCP server extraction (T157), Git-based plugin loading (T158), and version-aware caching (T150). These tests ensure the plugin ecosystem works correctly and prevent regressions.

## 2. Prior Art (IMPORTANT)

Reference existing test implementations to copy patterns from:

- `tests/unit/loaders/claude-plugin.test.ts` - Test structure for Claude plugin loader
- `tests/unit/loaders/git.test.ts` - Test patterns for Git loader with mocking
- `tests/unit/utils/plugin-cache.test.ts` - Test patterns for plugin cache (if exists)
- `tests/integration/plugin-cache.test.ts` - Integration test patterns
- `tests/fixtures/claude-plugins/` - Fixture structure for plugin tests

## 3. File Structure

```
tests/
├── unit/
│   └── loaders/
│       └── claude-plugin.test.ts  # EXTEND: Add new test cases
├── integration/
│   └── plugin-system.test.ts      # NEW: End-to-end plugin tests
└── fixtures/
    └── claude-plugins/
        ├── full-manifest-plugin/   # NEW: Complete plugin.json test fixture
        │   ├── .claude-plugin/
        │   │   └── plugin.json
        │   ├── skills/
        │   │   └── test-skill/
        │   │       └── SKILL.md
        │   ├── agents/
        │   │   └── test-agent.md
        │   ├── commands/
        │   │   └── test-command.md
        │   ├── hooks/
        │   │   └── hooks.json
        │   └── .mcp.json
        ├── minimal-manifest-plugin/ # NEW: Minimal plugin.json
        │   ├── .claude-plugin/
        │   │   └── plugin.json
        │   └── skills/
        │       └── basic/
        │           └── SKILL.md
        └── hooks-json-plugin/       # NEW: Full hooks.json test fixture
            ├── .claude-plugin/
            │   └── plugin.json
            └── hooks/
                └── hooks.json
```

## 4. Interfaces & Types

No new types needed - tests use existing interfaces from:
- `src/loaders/claude-plugin.ts` - `ClaudePluginManifest`, `ClaudeHook`
- `src/utils/plugin-cache.ts` - `PluginCacheEntry`, `PluginCacheManifest`
- `src/loaders/base.ts` - `LoadResult`, `LoadError`

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use Vitest for all tests (see existing tests for patterns)
- [x] Mock filesystem operations where appropriate
- [x] Use temp directories for integration tests (see git.test.ts)
- [x] Clean up fixtures after tests (`afterEach` hooks)
- [x] Test both success and error paths
- [x] Follow `describe` → `describe` → `it` nesting pattern

### 5.2 Test Fixtures to Create

#### Full Manifest Plugin Fixture

```
tests/fixtures/claude-plugins/full-manifest-plugin/
├── .claude-plugin/
│   └── plugin.json          # All fields populated
├── skills/
│   └── typescript/
│       └── SKILL.md
├── agents/
│   └── architect.md
├── commands/
│   └── deploy.md
├── hooks/
│   └── hooks.json           # All hook event types
└── .mcp.json                # MCP servers config
```

- [x] Created `full-manifest-plugin` fixture with manifest, hooks, MCP config
- [x] Created `minimal-manifest-plugin` fixture for minimal manifest coverage
- [x] Created `hooks-json-plugin` fixture for hook transformation coverage

**plugin.json contents:**

```json
{
  "name": "full-test-plugin",
  "version": "1.2.3",
  "description": "A complete plugin for testing all features",
  "author": {
    "name": "Test Author",
    "email": "test@example.com",
    "url": "https://example.com"
  },
  "homepage": "https://github.com/test/plugin",
  "repository": {
    "type": "git",
    "url": "https://github.com/test/plugin.git"
  },
  "license": "MIT",
  "keywords": ["claude-code", "testing", "typescript"],
  "skills": "skills/",
  "commands": "commands/",
  "agents": "agents/",
  "hooks": "hooks/hooks.json",
  "mcpServers": ".mcp.json"
}
```

**hooks/hooks.json contents:**

```json
{
  "hooks": {
    "UserPromptSubmit": [
      {
        "name": "prompt-logger",
        "type": "command",
        "command": "echo 'Prompt submitted'",
        "action": "allow"
      }
    ],
    "PreToolUse": [
      {
        "name": "security-check",
        "match": "Bash(*rm*)",
        "type": "command",
        "command": "sh -c './hooks/security.sh'",
        "action": "warn",
        "message": "Destructive command detected"
      },
      {
        "name": "format-check",
        "match": "Write|Edit",
        "type": "command",
        "command": "sh -c './hooks/format.sh'"
      }
    ],
    "PostToolUse": [
      {
        "name": "log-changes",
        "match": "Edit|Write",
        "type": "command",
        "command": "sh -c './hooks/log.sh'"
      }
    ],
    "Notification": [
      {
        "name": "notify-complete",
        "type": "notification",
        "message": "Task completed"
      }
    ],
    "Stop": [
      {
        "name": "cleanup",
        "type": "command",
        "command": "sh -c './hooks/cleanup.sh'"
      }
    ]
  }
}
```

**.mcp.json contents:**

```json
{
  "mcpServers": {
    "filesystem": {
      "command": "node",
      "args": ["${CLAUDE_PLUGIN_ROOT}/mcp/fs-server.js"],
      "env": {
        "DEBUG": "true"
      }
    },
    "remote-api": {
      "type": "http",
      "url": "https://api.example.com/mcp",
      "headers": {
        "Authorization": "Bearer ${API_KEY}"
      }
    }
  }
}
```

### 5.3 Test Cases by Component

#### A. Plugin Manifest Tests (T155)

```typescript
describe('plugin.json manifest parsing', () => {
  describe('required fields', () => {
    it('should require name field');
    it('should reject manifest without name');
  });

  describe('optional metadata fields', () => {
    it('should parse version field');
    it('should parse description field');
    it('should parse author as string');
    it('should parse author as object with name, email, url');
    it('should parse homepage URL');
    it('should parse repository as string');
    it('should parse repository as object');
    it('should parse license identifier');
    it('should parse keywords array');
  });

  describe('component paths', () => {
    it('should use skills path from manifest');
    it('should use commands path from manifest');
    it('should use agents path from manifest');
    it('should use hooks path from manifest');
    it('should use mcpServers path from manifest');
    it('should fall back to convention paths when not in manifest');
  });

  describe('path resolution', () => {
    it('should resolve relative paths from plugin root');
    it('should support ${CLAUDE_PLUGIN_ROOT} variable');
    it('should handle absolute paths');
  });

  describe('manifest locations', () => {
    it('should find manifest at <root>/plugin.json');
    it('should find manifest at <root>/.claude-plugin/plugin.json');
    it('should prefer .claude-plugin/plugin.json over root');
  });
});
```

#### B. Hooks.json Tests (T156)

```typescript
describe('hooks.json transformation', () => {
  describe('event types', () => {
    it('should transform UserPromptSubmit hooks');
    it('should transform PreToolUse hooks');
    it('should transform PostToolUse hooks');
    it('should transform Notification hooks');
    it('should transform Stop hooks');
    it('should transform SubagentStop hooks');
    it('should transform SessionStart hooks');
    it('should transform SessionEnd hooks');
    it('should transform PreCompact hooks');
  });

  describe('hook properties', () => {
    it('should preserve hook name');
    it('should transform match pattern to tool_match');
    it('should transform command to execute');
    it('should preserve action (warn/block/allow)');
    it('should preserve message');
  });

  describe('match patterns', () => {
    it('should handle glob patterns like "Bash(*rm*)"');
    it('should handle OR patterns like "Write|Edit"');
    it('should handle simple tool names');
  });

  describe('hook types', () => {
    it('should handle command type hooks');
    it('should handle validation type hooks');
    it('should handle notification type hooks');
  });

  describe('edge cases', () => {
    it('should handle empty hooks object');
    it('should handle hooks with only some event types');
    it('should handle hooks without optional fields');
  });
});
```

#### C. MCP Server Extraction Tests (T157)

```typescript
describe('MCP server extraction', () => {
  describe('stdio servers', () => {
    it('should extract command');
    it('should extract args array');
    it('should extract env variables');
    it('should resolve ${CLAUDE_PLUGIN_ROOT} in command path');
    it('should resolve ${CLAUDE_PLUGIN_ROOT} in args');
  });

  describe('HTTP servers', () => {
    it('should extract url');
    it('should extract headers');
    it('should preserve env variable references in headers');
  });

  describe('SSE servers', () => {
    it('should extract url');
    it('should extract headers');
  });

  describe('path resolution', () => {
    it('should resolve relative paths to absolute');
    it('should handle ${CLAUDE_PLUGIN_ROOT} substitution');
  });

  describe('merge behavior', () => {
    it('should not conflict with project MCP servers');
    it('should prefix server names with plugin name');
  });
});
```

#### D. Git-based Loading Tests (T158)

```typescript
describe('Git-based plugin loading', () => {
  describe('source parsing', () => {
    it('should parse github:owner/repo format');
    it('should parse github:owner/repo@version format');
    it('should parse gitlab:owner/repo format');
    it('should parse bitbucket:owner/repo format');
    it('should parse full git URLs');
    it('should extract version from @tag suffix');
  });

  describe('caching', () => {
    it('should cache cloned repositories');
    it('should use cache when version matches');
    it('should invalidate cache when version changes');
    it('should respect cache TTL');
    it('should support force refresh option');
  });

  describe('version pinning', () => {
    it('should checkout exact version tag');
    it('should checkout branch when specified');
    it('should use latest when no version specified');
  });

  describe('content loading', () => {
    it('should load plugin content after clone');
    it('should apply ClaudePluginLoader transformation');
    it('should preserve plugin metadata');
  });
});
```

#### E. Version Caching Tests (T150)

```typescript
describe('Plugin version caching', () => {
  describe('cache manifest', () => {
    it('should create manifest on first cache');
    it('should update manifest on new plugin');
    it('should track plugin versions');
    it('should track cache timestamps');
  });

  describe('plugin ID generation', () => {
    it('should generate deterministic IDs');
    it('should include version in ID');
    it('should handle scoped packages');
    it('should handle special characters');
  });

  describe('cache operations', () => {
    it('should check if plugin is cached');
    it('should get cached plugin path');
    it('should invalidate specific plugin');
    it('should clear entire cache');
    it('should list all cached plugins');
  });

  describe('${CLAUDE_PLUGIN_ROOT} resolution', () => {
    it('should resolve variable in file content');
    it('should resolve variable in JSON configs');
    it('should use correct absolute path');
  });
});
```

### 5.4 Integration Tests

```typescript
// tests/integration/plugin-system.test.ts
describe('Plugin System Integration', () => {
  describe('full plugin loading flow', () => {
    it('should load plugin with manifest, skills, agents, commands, hooks');
    it('should resolve ${CLAUDE_PLUGIN_ROOT} throughout');
    it('should cache for subsequent loads');
    it('should include plugin metadata in result');
  });

  describe('plugin filtering', () => {
    it('should apply include filter');
    it('should apply exclude filter');
    it('should skip disabled plugins');
  });

  describe('error scenarios', () => {
    it('should handle missing plugin gracefully');
    it('should handle invalid manifest gracefully');
    it('should continue loading on partial failures');
  });
});
```

### 5.5 Critical Test Patterns

```typescript
// ❌ WRONG - Test doesn't clean up temp directories
it('should cache plugins', async () => {
  const tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'test-'));
  // ... test code
});

// ✅ CORRECT - Use beforeEach/afterEach for cleanup
let tempDir: string;

beforeEach(() => {
  tempDir = fs.mkdtempSync(path.join(os.tmpdir(), 'plugin-test-'));
});

afterEach(() => {
  try {
    fs.rmSync(tempDir, { recursive: true, force: true });
  } catch {
    // Ignore cleanup errors
  }
});
```

```typescript
// ❌ WRONG - Mock doesn't reset between tests
vi.mock('node:child_process');

// ✅ CORRECT - Clear mocks in beforeEach
beforeEach(() => {
  vi.clearAllMocks();
});
```

## 6. Test Requirements

### 6.1 Coverage Targets

- [x] Plugin manifest parsing: 100% of fields
- [x] Hooks transformation: All 9 event types
- [x] MCP extraction: stdio, HTTP, SSE types
- [x] Git loading: All supported URL formats
- [x] Caching: All cache operations

### 6.2 Test Count Estimates

| Component | Unit Tests | Integration |
|-----------|------------|-------------|
| Manifest parsing | ~25 tests | - |
| Hooks transformation | ~20 tests | - |
| MCP extraction | ~15 tests | - |
| Git loading | ~20 tests | - |
| Version caching | ~15 tests | - |
| Integration | - | ~10 tests |
| **Total** | **~95 tests** | **~10 tests** |

## 7. Integration Points

- **Test fixtures**: `tests/fixtures/claude-plugins/`
- **Existing tests**: Extend `tests/unit/loaders/claude-plugin.test.ts`
- **Integration tests**: Add to `tests/integration/`

## 8. Acceptance Criteria

- [ ] All new tests pass (`npm test`) *(plugin tests pass; full suite currently has unrelated generator/test sandbox issues)*
- [ ] No lint errors in test files (`npm run lint`) *(lint blocked by sandbox permission error)*
- [x] Test fixtures created and valid
- [x] Coverage for all plugin system features
- [x] Tests are isolated (no cross-test pollution)
- [x] Tests clean up temp files/directories
- [x] Mocks are properly scoped and reset

## 9. Out of Scope

- Performance benchmarks
- Load testing with many plugins
- Network-dependent Git clone tests (mock Git operations)
- Tests for T159 (marketplace config) - separate task
- Tests for T160 (plugin CLI) - separate task

## 10. Test Execution Commands

```bash
# Run all plugin-related tests
npm test -- --grep "plugin"

# Run specific test file
npm test -- tests/unit/loaders/claude-plugin.test.ts

# Run integration tests
npm test -- tests/integration/plugin-system.test.ts

# Run with coverage
npm test -- --coverage --grep "plugin"
```

