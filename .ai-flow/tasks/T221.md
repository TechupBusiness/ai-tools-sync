# T221: Implement Manifest Schema v2

> **Priority**: P2 | **Wave**: 4 | **Track**: A (Manifest Infrastructure)  
> **Depends on**: T220 (per-run manifest with hashes)  
> **Estimated complexity**: Low

## 1. Objective

Formalize the V2 manifest schema as the only supported format. Add JSON schema validation, remove legacy V1 text format support, and ensure all manifest operations use the V2 JSON structure with hashed file entries. This enables hash-based safety for generated file cleanup.

**Note**: No migration from V1 needed—V1 was never released. Breaking changes are acceptable; update all existing code and tests.

## 2. Prior Art (IMPORTANT)

- `src/utils/manifest.ts` - V2 types already exist (`ManifestV2`, `ManifestFileEntry`, `computeFileHash`, `createManifestV2`, `isManifestV2`)
- `src/schemas/rule.schema.json` - JSON schema pattern to copy
- `src/config/validator.ts` - Schema validation pattern using Ajv
- `tests/unit/utils/manifest.test.ts` - Existing test patterns (update for V2-only)

## 3. File Structure

```
src/
├── schemas/
│   └── manifest.schema.json  # NEW: JSON schema for V2 manifest
├── utils/
│   └── manifest.ts           # Simplify to V2-only, add validation
tests/
└── unit/
    └── utils/
        └── manifest.test.ts  # Update for V2-only format
```

## 4. Interfaces & Types

```typescript
// In src/utils/manifest.ts - Already exists, just tighten version type

export interface ManifestFileEntry {
  path: string;          // Relative path to generated file
  hash: string;          // Format: "sha256:<64-char-hex>"
}

export interface ManifestV2 {
  version: '2.0.0';      // Literal type (was string)
  timestamp: string;     // ISO 8601 format
  files: ManifestFileEntry[];
  directories: string[]; // Trailing slash required
}

// NEW: Validation function
export function validateManifest(data: unknown): Result<ManifestV2>;
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use `Result<T, E>` for validation errors (see `src/utils/result.ts`)
- [x] Follow JSON schema pattern from `src/schemas/rule.schema.json`
- [x] Honor `exactOptionalPropertyTypes` (see learnings [T159]/[T160])
- [x] Export validation function from `src/utils/manifest.ts`

### 5.2 Critical Logic (Pitfall Prevention)

#### Remove V1 Support Entirely

```typescript
// ❌ REMOVE - V1 text format parsing
export function parseManifest(content: string): Manifest { ... }
export function formatManifest(manifest: Manifest): string { ... }

// ✅ KEEP/UPDATE - V2 JSON only
export async function readManifest(projectRoot: string): Promise<Result<ManifestV2 | null>> {
  // Read file, JSON.parse, validate with schema
}

export async function writeManifest(projectRoot: string, manifest: ManifestV2): Promise<Result<void>> {
  // JSON.stringify with 2-space indent + trailing newline
}
```

#### JSON Schema Validation

```typescript
// Use Ajv for validation (already a dependency)
import Ajv from 'ajv';
import manifestSchema from '../schemas/manifest.schema.json';

const ajv = new Ajv();
const validateSchema = ajv.compile(manifestSchema);

export function validateManifest(data: unknown): Result<ManifestV2> {
  if (!validateSchema(data)) {
    const errors = validateSchema.errors?.map(e => e.message).join(', ');
    return err(new Error(`Invalid manifest: ${errors}`));
  }
  return ok(data as ManifestV2);
}
```

### 5.3 Edge Cases to Handle

- [x] Manifest file missing → `ok(null)` (not an error)
- [x] Empty JSON file → validation error
- [x] Missing required fields → validation error with field name
- [x] Invalid hash format (not `sha256:<hex>`) → validation error
- [x] Invalid version (not `"2.0.0"`) → validation error
- [x] Directories without trailing slash → validation error
- [x] Extra unknown fields → allow (forward compatibility)

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/utils/manifest.test.ts

describe('Manifest V2', () => {
  describe('validateManifest', () => {
    it('should accept valid V2 manifest', () => { /* ... */ });
    it('should reject missing version', () => { /* ... */ });
    it('should reject invalid hash format', () => { /* ... */ });
    it('should reject directories without trailing slash', () => { /* ... */ });
  });

  describe('readManifest', () => {
    it('should return null when file missing', async () => { /* ... */ });
    it('should parse valid V2 JSON', async () => { /* ... */ });
    it('should reject invalid JSON', async () => { /* ... */ });
  });

  describe('writeManifest', () => {
    it('should write valid JSON with formatting', async () => { /* ... */ });
    it('should round-trip correctly', async () => { /* ... */ });
  });
});
```

### 6.2 Required Test Cases

- [x] Valid V2 manifest round-trip (write → read)
- [x] Hash format validation (`sha256:` prefix + 64 hex chars)
- [x] Version must be exactly `"2.0.0"`
- [x] Directories must have trailing `/`
- [x] Missing manifest file returns `ok(null)`
- [x] Corrupted JSON returns error Result
- [x] Missing required fields return descriptive errors

## 7. Integration Points

- **Imports from**: `src/utils/fs.ts` (`fileExists`, `readFile`, `writeFile`), `src/utils/result.ts`
- **Exports to**: `src/cli/commands/sync.ts` (T220), `src/cli/commands/clean.ts` (T222), `src/cli/commands/status.ts` (T222)
- **Schema**: Add `src/schemas/manifest.schema.json`

## 8. Acceptance Criteria

- [x] `src/schemas/manifest.schema.json` created with full V2 validation
- [x] `validateManifest()` function added and exported
- [x] V1 text format functions removed (`parseManifest`, `formatManifest`)
- [x] `readManifest()` validates JSON against schema
- [x] All existing tests updated for V2-only format
- [x] All tests pass (`npm test -- manifest`)
- [x] No lint errors (`npm run lint`)
- [x] Types are strict (no `any`)

## 9. Out of Scope

- V1 migration (not released, not needed)
- History snapshots (T220)
- CLI commands (T222)
- Distributed gitignore (T223/T224)

## 10. JSON Schema Reference

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "required": ["version", "timestamp", "files", "directories"],
  "properties": {
    "version": { "const": "2.0.0" },
    "timestamp": { "type": "string", "format": "date-time" },
    "files": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["path", "hash"],
        "properties": {
          "path": { "type": "string", "minLength": 1 },
          "hash": { "type": "string", "pattern": "^sha256:[a-f0-9]{64}$" }
        },
        "additionalProperties": false
      }
    },
    "directories": {
      "type": "array",
      "items": { "type": "string", "pattern": "/$" }
    }
  },
  "additionalProperties": false
}
```
