# T270: Refactor Rules Configuration - Per-Loader `rules` Overrides with Regex Support

> **Priority**: P1 | **Wave**: 1 | **Track**: A (Core Infrastructure)
> **Depends on**: T269
> **Estimated complexity**: Medium

## 1. Objective

Move the `rules:` configuration section from global config into each loader's configuration, enabling per-source rule overrides. Add optional regex pattern support alongside existing glob patterns for file matching. This aligns with T269's per-loader `use` refactor.

## 2. Prior Art

- `src/config/types.ts:68-75` - Current RuleConfig interface
- `src/config/validator.ts` - Rules validation
- `src/cli/commands/sync.ts` - Rule processing
- `docs/CONFIGURATION.md:235-266` - Current rules documentation
- `.ai-flow/tasks/T269.md` - Per-loader `use` pattern to follow

## 3. File Structure

```
src/
├── config/
│   ├── types.ts          # Move RuleConfig into LoaderConfig
│   ├── defaults.ts       # Update default config
│   └── validator.ts      # Update validation for nested rules
├── cli/commands/
│   └── sync.ts           # Apply per-loader rule overrides
├── transformers/
│   └── glob-matcher.ts   # Add regex pattern support
└── schemas/
    └── config.schema.json # Update JSON schema
```

## 4. Interfaces & Types

```typescript
// Extended LoaderConfig with per-loader rules
export interface LoaderConfig {
  type: 'local' | 'npm' | 'pip' | 'git' | 'url' | 'claude-plugin';
  source?: string;
  package?: string;
  version?: string;
  use?: LoaderUseConfig;      // From T269
  rules?: LoaderRulesConfig;  // NEW: per-loader rule overrides
}

// Per-loader rules configuration
export interface LoaderRulesConfig {
  [ruleName: string]: RuleOverrideConfig;
}

// Rule override with regex support
export interface RuleOverrideConfig {
  always_apply?: boolean;
  globs?: string[];
  patterns?: string[];  // NEW: regex patterns (optional alternative to globs)
  targets?: string[];
  description?: string;
}
```

## 5. Implementation Requirements

### 5.1 Move `rules` Into LoaderConfig

- Add optional `rules?: LoaderRulesConfig` to LoaderConfig interface
- Remove global `rules?: Record<string, RuleConfig>` from Config interface
- Update schema validation for nested structure

### 5.2 Add Regex Pattern Support

- Add `patterns?: string[]` field to RuleOverrideConfig
- Patterns are JavaScript regex strings (without delimiters)
- Implement pattern matching in glob-matcher.ts:

```typescript
export function matchesPattern(filePath: string, patterns: string[]): boolean {
  return patterns.some(pattern => new RegExp(pattern).test(filePath));
}

export function matchesRule(filePath: string, rule: RuleOverrideConfig): boolean {
  const globMatch = rule.globs ? matchesGlob(filePath, rule.globs) : false;
  const patternMatch = rule.patterns ? matchesPattern(filePath, rule.patterns) : false;
  return globMatch || patternMatch;
}
```

### 5.3 Apply Per-Loader Rule Overrides

After loading rules from each source, merge overrides:

```typescript
// In sync.ts after loading
const result = await loader.load(source, options);
if (loaderConfig.rules) {
  result.rules = applyRuleOverrides(result.rules, loaderConfig.rules);
}
```

### 5.4 Config Migration Path

Old format (deprecated):
```yaml
loaders:
  - type: local
rules:
  _core:
    always_apply: true
  database:
    globs: ["**/*.sql"]
```

New format:
```yaml
loaders:
  - type: local
    rules:
      _core:
        always_apply: true
      database:
        globs: ["**/*.sql"]
        patterns: ["migrations/\\d{4}_.*\\.sql$"]  # regex alternative
```

## 6. Test Requirements

### 6.1 Required Test Cases

- [ ] Loader without `rules` uses original rule frontmatter
- [ ] Loader with `rules._core.always_apply: true` overrides frontmatter
- [ ] Loader with `rules.x.globs` overrides globs
- [ ] Loader with `rules.x.patterns` matches regex patterns
- [ ] Combined globs + patterns uses OR logic
- [ ] Multiple loaders with different rule overrides work independently
- [ ] Invalid regex pattern produces validation error
- [ ] Global `rules` config rejected with deprecation warning

### 6.2 Test Files

- `tests/unit/config/validator.test.ts` - Schema validation
- `tests/unit/transformers/glob-matcher.test.ts` - Pattern matching
- `tests/unit/cli/sync.test.ts` - Override application

## 7. Acceptance Criteria

- [ ] Global `rules` config removed from Config type
- [ ] `rules` field available on each loader config
- [ ] `patterns` regex field supported alongside `globs`
- [ ] Rule overrides merge correctly with frontmatter
- [ ] Schema validation updated
- [ ] docs/CONFIGURATION.md updated
- [ ] docs/LOADERS.md updated with rules section
- [ ] All tests pass
- [ ] Format check pass

## 8. Out of Scope

- Backwards compatibility shim for global `rules` (breaking change)
- Regex flags support (use JS default)
- Pattern negation (use separate rule)
