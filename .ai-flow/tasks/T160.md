# T160: Add Plugin CLI Commands

> **Priority**: P2 | **Wave**: 3 | **Track**: A (Plugin Management)
> **Depends on**: T158 (Git-based plugin loader), T159 (Plugin configuration support)
> **Estimated complexity**: Medium

## 1. Objective

Extend the existing `ai-sync plugins` CLI command with `list`, `add`, and `remove` subcommands to enable users to manage Git-based plugins from the command line. The `update` subcommand already exists and handles plugin updates. This task completes the plugin management CLI interface.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:

- `src/cli/commands/plugins.ts` - **Existing plugins command** with `update` subcommand (extend this file)
- `src/cli/commands/init.ts` - Pattern for CLI option handling, error handling, output formatting
- `src/cli/output.ts` - Use `printHeader`, `printSuccess`, `printTable`, etc.
- `src/utils/plugin-cache.ts` - `PluginCache.listCached()`, `invalidate()`, `cachePlugin()`
- `src/utils/plugin-update.ts` - `fetchRemoteTags()` for version discovery
- `src/loaders/plugin.ts` - `PluginLoader` for loading plugins
- `src/loaders/git.ts` - `parseGitSource()` for parsing Git URLs
- `src/config/loader.ts` - `loadConfig()`, `resolveConfigDir()` for config access

## 3. File Structure

```
src/
├── cli/
│   └── commands/
│       └── plugins.ts       # MODIFY: Add list, add, remove subcommands
tests/
└── unit/
    └── cli/
        └── plugins.test.ts  # NEW: Tests for plugins CLI commands
```

## 4. Interfaces & Types

```typescript
// In src/cli/commands/plugins.ts

/**
 * Result of plugins list command
 */
interface PluginsListResult {
  plugins: Array<{
    name: string;
    source: string;
    version?: string;
    cachedAt: string;
    enabled: boolean;
    inConfig: boolean;
  }>;
  total: number;
}

/**
 * Options for plugins list command
 */
interface PluginsListOptions {
  project?: string;
  configDir?: string;
  json?: boolean;       // Output as JSON
  verbose?: boolean;    // Show detailed info
}

/**
 * Options for plugins add command
 */
interface PluginsAddOptions {
  project?: string;
  configDir?: string;
  name?: string;        // Custom name (default: derived from repo)
  version?: string;     // Pin to specific version
  force?: boolean;      // Overwrite if exists
  include?: string[];   // Content types to include
  exclude?: string[];   // Content types to exclude
  timeout?: string;     // Git timeout in ms
}

/**
 * Options for plugins remove command
 */
interface PluginsRemoveOptions {
  project?: string;
  configDir?: string;
  force?: boolean;      // Remove even if in config.yaml
  keepCache?: boolean;  // Keep cached files
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use `Command` from `commander` (existing pattern in plugins.ts)
- [x] Use `loadConfig()`, `resolveConfigDir()` for config access
- [x] Use `createPluginCache()` for cache operations
- [x] Use output helpers: `printHeader`, `printSuccess`, `printError`, `printTable`, `printInfo`
- [x] Handle `--project` and `--config-dir` options consistently
- [x] Set appropriate exit codes (0 success, 1 error)
- [x] Support `--json` flag for scriptable output

### 5.2 Subcommand: `plugins list`

```typescript
plugins
  .command('list')
  .description('List installed plugins')
  .option('-p, --project <path>', 'Project root directory')
  .option('-c, --config-dir <path>', 'Configuration directory name')
  .option('--json', 'Output as JSON')
  .option('-v, --verbose', 'Show detailed information')
  .action(async (options: PluginsListOptions) => {
    const projectRoot = path.resolve(options.project ?? process.cwd());
    const configDirName = await resolveConfigDir({ projectRoot, configDir: options.configDir });
    const baseDir = path.join(projectRoot, configDirName);

    // Initialize cache
    const cacheResult = await createPluginCache(baseDir);
    if (!cacheResult.ok) {
      printError(cacheResult.error.message);
      process.exit(1);
      return;
    }
    const cache = cacheResult.value;

    // Load config to check which plugins are in config.yaml
    const configResult = await loadConfig({ projectRoot, configDir: options.configDir });
    const configPlugins = configResult.ok ? configResult.value.use?.plugins ?? [] : [];
    const configPluginNames = new Set(configPlugins.map(p => p.name));

    // Get cached plugins
    const cachedPlugins = cache.listCached();

    // Build combined list (cached + configured)
    const plugins = buildPluginList(cachedPlugins, configPlugins);

    if (options.json) {
      console.log(JSON.stringify({ plugins, total: plugins.length }, null, 2));
      return;
    }

    printHeader('AI Tool Sync - Installed Plugins');

    if (plugins.length === 0) {
      printInfo('No plugins installed.');
      printInfo('Use "ai-sync plugins add <source>" to add a plugin.');
      return;
    }

    // Print table
    const headers = ['Name', 'Source', 'Version', 'Status'];
    const rows = plugins.map(p => [
      p.name,
      truncateSource(p.source, 40),
      p.version ?? 'latest',
      getStatusText(p.enabled, p.inConfig),
    ]);

    printTable(headers, rows);
    printNewLine();
    printInfo(`Total: ${plugins.length} plugin(s)`);
  });
```

### 5.3 Subcommand: `plugins add`

```typescript
plugins
  .command('add <source>')
  .description('Add a plugin from Git URL (e.g., github:owner/repo@v1.0.0)')
  .option('-p, --project <path>', 'Project root directory')
  .option('-c, --config-dir <path>', 'Configuration directory name')
  .option('-n, --name <name>', 'Custom plugin name')
  .option('-v, --version <version>', 'Pin to specific version')
  .option('--force', 'Overwrite if plugin already exists')
  .option('--include <types...>', 'Content types to include (rules,personas,commands,hooks)')
  .option('--exclude <types...>', 'Content types to exclude')
  .option('--timeout <ms>', 'Timeout for git operations in milliseconds')
  .action(async (source: string, options: PluginsAddOptions) => {
    const projectRoot = path.resolve(options.project ?? process.cwd());
    const configDirName = await resolveConfigDir({ projectRoot, configDir: options.configDir });
    const baseDir = path.join(projectRoot, configDirName);

    printHeader('AI Tool Sync - Add Plugin');

    // Validate source format
    const parsed = parseGitSource(source);
    if (!parsed) {
      printError(`Invalid plugin source: ${source}`);
      printInfo('Expected format: github:owner/repo[@version]');
      process.exit(1);
      return;
    }

    // Initialize cache
    const cacheResult = await createPluginCache(baseDir);
    if (!cacheResult.ok) {
      printError(cacheResult.error.message);
      process.exit(1);
      return;
    }
    const cache = cacheResult.value;

    // Determine plugin name
    const pluginName = options.name ?? `${parsed.owner}-${parsed.repo}`;
    
    // Determine version (option > source ref)
    const version = options.version ?? parsed.ref;
    const sourceWithVersion = version
      ? (source.includes('@') ? source.replace(/@.*$/, `@${version}`) : `${source}@${version}`)
      : source;

    // Check if already installed
    if (!options.force && await cache.isCached(sourceWithVersion, version)) {
      printWarning(`Plugin "${pluginName}" is already installed.`);
      printInfo('Use --force to reinstall.');
      return;
    }

    printInfo(`Adding plugin: ${pluginName}`);
    printInfo(`Source: ${sourceWithVersion}`);

    // Load the plugin (this clones and caches it)
    const loader = new PluginLoader();
    const timeoutMs = options.timeout ? parseInt(options.timeout, 10) : undefined;
    
    const loadResult = await loader.load(sourceWithVersion, {
      basePath: projectRoot,
      cacheDir: baseDir,
      forceRefresh: options.force,
      timeout: timeoutMs,
    });

    if (loadResult.errors && loadResult.errors.length > 0) {
      printError(`Failed to add plugin: ${loadResult.errors[0]?.message}`);
      process.exit(1);
      return;
    }

    // Print what was loaded
    const stats = {
      rules: loadResult.rules.length,
      personas: loadResult.personas.length,
      commands: loadResult.commands.length,
      hooks: loadResult.hooks.length,
    };

    printSuccess(`Plugin "${pluginName}" added successfully!`);
    printNewLine();
    printInfo('Loaded content:');
    if (stats.rules > 0) printListItem(`${stats.rules} rule(s)`);
    if (stats.personas > 0) printListItem(`${stats.personas} persona(s)`);
    if (stats.commands > 0) printListItem(`${stats.commands} command(s)`);
    if (stats.hooks > 0) printListItem(`${stats.hooks} hook(s)`);

    printNewLine();
    printInfo('To use this plugin, add it to your config.yaml:');
    printNewLine();
    console.log(`  use:
    plugins:
      - name: ${pluginName}
        source: ${sourceWithVersion}
        enabled: true`);
  });
```

### 5.4 Subcommand: `plugins remove`

```typescript
plugins
  .command('remove <name>')
  .description('Remove a plugin')
  .option('-p, --project <path>', 'Project root directory')
  .option('-c, --config-dir <path>', 'Configuration directory name')
  .option('--force', 'Remove even if plugin is in config.yaml')
  .option('--keep-cache', 'Keep cached files (only remove from config)')
  .action(async (name: string, options: PluginsRemoveOptions) => {
    const projectRoot = path.resolve(options.project ?? process.cwd());
    const configDirName = await resolveConfigDir({ projectRoot, configDir: options.configDir });
    const baseDir = path.join(projectRoot, configDirName);

    printHeader('AI Tool Sync - Remove Plugin');

    // Initialize cache
    const cacheResult = await createPluginCache(baseDir);
    if (!cacheResult.ok) {
      printError(cacheResult.error.message);
      process.exit(1);
      return;
    }
    const cache = cacheResult.value;

    // Load config to check if plugin is in use
    const configResult = await loadConfig({ projectRoot, configDir: options.configDir });
    const configPlugins = configResult.ok ? configResult.value.use?.plugins ?? [] : [];
    
    // Find plugin in cache or config
    const cachedPlugins = cache.listCached();
    const cachedEntry = cachedPlugins.find(p => 
      p.source.includes(name) || generatePluginId(p.source, p.version).includes(name)
    );
    const configEntry = configPlugins.find(p => 
      p.name === name || p.source.includes(name)
    );

    if (!cachedEntry && !configEntry) {
      printError(`Plugin "${name}" not found.`);
      printInfo('Use "ai-sync plugins list" to see installed plugins.');
      process.exit(1);
      return;
    }

    // Warn if in config.yaml
    if (configEntry && !options.force) {
      printWarning(`Plugin "${name}" is referenced in config.yaml.`);
      printInfo('Use --force to remove anyway, then manually update config.yaml.');
      process.exit(1);
      return;
    }

    // Remove from cache
    if (cachedEntry && !options.keepCache) {
      printInfo(`Removing cached files for "${name}"...`);
      const invalidateResult = await cache.invalidate(cachedEntry.source, cachedEntry.version);
      if (!invalidateResult.ok) {
        printError(`Failed to remove cache: ${invalidateResult.error.message}`);
        process.exit(1);
        return;
      }
      printSuccess('Cache removed.');
    }

    if (configEntry) {
      printWarning('Plugin is still in config.yaml - please remove it manually.');
    }

    printSuccess(`Plugin "${name}" removed successfully!`);
  });
```

### 5.5 Helper Functions

```typescript
/**
 * Build combined list of plugins from cache and config
 */
function buildPluginList(
  cached: PluginCacheEntry[],
  config: PluginConfig[]
): Array<{
  name: string;
  source: string;
  version?: string;
  cachedAt: string;
  enabled: boolean;
  inConfig: boolean;
}> {
  const result: Map<string, {
    name: string;
    source: string;
    version?: string;
    cachedAt: string;
    enabled: boolean;
    inConfig: boolean;
  }> = new Map();

  // Add cached plugins
  for (const entry of cached) {
    const name = extractPluginName(entry.source);
    result.set(entry.source, {
      name,
      source: entry.source,
      version: entry.version,
      cachedAt: entry.cachedAt,
      enabled: true,
      inConfig: false,
    });
  }

  // Merge config plugins
  for (const plugin of config) {
    const existing = result.get(plugin.source);
    if (existing) {
      existing.name = plugin.name;
      existing.enabled = plugin.enabled !== false;
      existing.inConfig = true;
    } else {
      result.set(plugin.source, {
        name: plugin.name,
        source: plugin.source,
        version: plugin.version,
        cachedAt: '',
        enabled: plugin.enabled !== false,
        inConfig: true,
      });
    }
  }

  return Array.from(result.values()).sort((a, b) => a.name.localeCompare(b.name));
}

/**
 * Extract plugin name from source URL
 */
function extractPluginName(source: string): string {
  const parsed = parseGitSource(source);
  if (parsed) {
    return `${parsed.owner}/${parsed.repo}`;
  }
  // Fallback: use last path segment
  return source.split('/').pop() ?? source;
}

/**
 * Get status text for display
 */
function getStatusText(enabled: boolean, inConfig: boolean): string {
  if (!inConfig) return 'cached';
  if (!enabled) return 'disabled';
  return 'enabled';
}

/**
 * Truncate source URL for display
 */
function truncateSource(source: string, maxLen: number): string {
  if (source.length <= maxLen) return source;
  return source.slice(0, maxLen - 3) + '...';
}
```

### 5.6 Edge Cases to Handle

- [x] No plugins installed → Show helpful message with `add` command hint
- [x] Plugin name not found → Suggest using `list` to see installed plugins
- [x] Invalid source format → Show expected format with examples
- [x] Plugin in config but not cached → Mark as "not installed" in list
- [x] Plugin cached but not in config → Mark as "cached only" in list
- [x] Remove plugin in config without `--force` → Require confirmation
- [x] Git clone failure → Show clear error with troubleshooting hints
- [x] `--json` flag → Output clean JSON for scripting
- [x] Private repo → Hint about token authentication

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/cli/plugins.test.ts
describe('Plugins CLI Commands', () => {
  describe('plugins list', () => {
    // List command tests
  });

  describe('plugins add', () => {
    // Add command tests
  });

  describe('plugins remove', () => {
    // Remove command tests
  });

  describe('plugins update', () => {
    // Existing update tests (verify no regression)
  });
});
```

### 6.2 Required Test Cases

**List Command:**
- [x] Empty list shows helpful message
- [x] Lists cached plugins with correct info
- [x] Merges config and cache correctly
- [x] Shows "disabled" status for `enabled: false`
- [x] Shows "cached" status for plugins not in config
- [x] `--json` outputs valid JSON
- [x] `--verbose` shows additional details

**Add Command:**
- [x] Adds plugin from GitHub URL
- [x] Adds plugin with explicit version
- [x] Adds plugin with custom name
- [x] Fails for invalid source format
- [x] Fails if already installed (without `--force`)
- [x] Overwrites with `--force`
- [x] Shows loaded content summary
- [x] Handles network/clone errors gracefully

**Remove Command:**
- [x] Removes cached plugin
- [x] Refuses to remove if in config (without `--force`)
- [x] Removes with `--force` even if in config
- [x] `--keep-cache` only removes from config reference
- [x] Fails for non-existent plugin
- [x] Handles partial matches (finds by name substring)

### 6.3 Test Fixtures

Use existing fixtures and mocks:
- Mock `createPluginCache` for cache operations
- Mock `loadConfig` for config access
- Mock `PluginLoader.load` for add operations
- Use temp directories for isolation

```typescript
// Example test setup
vi.mock('../../../src/utils/plugin-cache.js', () => ({
  createPluginCache: vi.fn().mockResolvedValue({
    ok: true,
    value: {
      listCached: vi.fn().mockReturnValue([
        { source: 'github:owner/repo', version: 'v1.0.0', cachedAt: '2025-01-01' }
      ]),
      isCached: vi.fn().mockResolvedValue(false),
      invalidate: vi.fn().mockResolvedValue({ ok: true }),
    },
  }),
  generatePluginId: vi.fn((s, v) => `${s}_${v}`),
}));
```

## 7. Integration Points

- **Imports from**:
  - `src/config/loader.ts` - `loadConfig`, `resolveConfigDir`
  - `src/utils/plugin-cache.ts` - `createPluginCache`, `generatePluginId`
  - `src/loaders/git.ts` - `parseGitSource`
  - `src/loaders/plugin.ts` - `PluginLoader`
  - `src/cli/output.ts` - All output helpers

- **Exports to**:
  - N/A (CLI commands don't export, they register with commander)

- **Config**: Reads `use.plugins` from `config.yaml` via `loadConfig()`

## 8. Acceptance Criteria

- [x] All tests pass (`npm test -- plugins.test.ts`)
- [ ] No lint errors (`npm run lint`) — blocked locally by EPERM sandbox read of node_modules
- [x] Types are strict (no `any`)
- [x] `plugins list` shows cached and configured plugins
- [x] `plugins add` clones and caches a plugin
- [x] `plugins remove` removes plugin from cache
- [x] `--json` flag produces valid JSON output
- [x] Error messages include helpful hints
- [x] Existing `plugins update` continues to work
- [x] plan.md updated to mark T160 complete

## 9. Out of Scope

- Automatic config.yaml modification (user updates manually)
- Plugin dependency resolution
- Plugin marketplace discovery/search
- Interactive plugin selection
- Plugin versioning with semver ranges (exact pins only)

## 10. CLI Usage Examples

```bash
# List installed plugins
ai-sync plugins list
ai-sync plugins list --json
ai-sync plugins list --verbose

# Add a plugin
ai-sync plugins add github:anthropics/claude-typescript@v1.0.0
ai-sync plugins add github:company/security-rules --name security
ai-sync plugins add github:user/plugin --version v2.0.0
ai-sync plugins add github:org/plugin --force  # Reinstall

# Remove a plugin
ai-sync plugins remove security
ai-sync plugins remove github:owner/repo
ai-sync plugins remove my-plugin --force  # Even if in config
ai-sync plugins remove my-plugin --keep-cache

# Update plugins (existing)
ai-sync plugins update
ai-sync plugins update my-plugin
ai-sync plugins update --apply
```

## 11. Sample Output

```
━━━ AI Tool Sync - Installed Plugins ━━━

  Name              Source                           Version  Status
  ──────────────    ─────────────────────────        ───────  ──────
  typescript-std    github:anthropics/claude-ts...   v1.2.0   enabled
  security-rules    github:company/security-rules    v2.0.0   enabled
  local-plugin      ./plugins/local                  -        cached

Total: 3 plugin(s)
```

