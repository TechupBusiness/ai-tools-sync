# T209: Add Factory Skills Support

> **Priority**: P1 | **Wave**: 1 | **Track**: D (Factory Platform)
> **Depends on**: None
> **Estimated complexity**: Medium

## 1. Objective

Enhance Factory skill generation to produce properly formatted SKILL.md files with YAML frontmatter matching Factory's specification. Add support for the `allowed-tools` frontmatter field and optional companion files (`references.md`, `schemas/`, `checklists.md`).

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/generators/factory.ts` lines 199-281 - Current skill generation (update this)
- `src/generators/claude.ts` lines 264-344 - Claude skill pattern (similar structure)
- `src/parsers/rule.ts` - Rule frontmatter interface
- `tests/unit/generators/factory.test.ts` lines 119-172 - Existing skill tests (extend these)

## 3. File Structure

```
src/
├── generators/
│   └── factory.ts           # Update generateSkillFile method
├── parsers/
│   └── rule.ts              # Add factory extension interface
tests/
└── unit/
    └── generators/
        └── factory.test.ts   # Add frontmatter and companion file tests
```

## 4. Interfaces & Types

### 4.1 Factory Extension for Rules

Add to `src/parsers/types.ts` or `src/parsers/rule.ts`:

```typescript
/**
 * Factory-specific rule/skill extensions
 */
export interface FactoryRuleExtension {
  /** Allowed tools for this skill (reserved for future use) */
  allowedTools?: string[];
  
  /** Optional references markdown file path */
  references?: string;
  
  /** Optional schemas directory path */
  schemas?: string;
  
  /** Optional checklists markdown file path */
  checklists?: string;
}
```

Add to `ParsedRuleFrontmatter` interface:

```typescript
interface ParsedRuleFrontmatter {
  // ... existing fields ...
  
  /** Factory-specific extensions */
  factory?: FactoryRuleExtension;
}
```

### 4.2 Factory SKILL.md Frontmatter

Output format for Factory skills:

```yaml
---
name: skill-name
description: Skill description
allowed-tools: []  # Reserved, include if specified
---
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use `serializeFrontmatter()` from `src/transformers/frontmatter.ts` for YAML output
- [x] Map generic tool names using `mapTools()` for `allowed-tools`
- [x] Maintain backward compatibility with existing skill generation
- [x] Follow file creation pattern from `ensureDir()` + `writeFile()`

### 5.2 Critical Logic (Pitfall Prevention)

#### 5.2.1 Frontmatter Generation

```typescript
// ❌ WRONG - Current implementation (no YAML frontmatter)
const parts: string[] = [];
parts.push(`# ${rule.frontmatter.name}`);

// ✅ CORRECT - Add YAML frontmatter block
const parts: string[] = [];

// Build frontmatter
const frontmatter: Record<string, unknown> = {
  name: rule.frontmatter.name,
};
if (rule.frontmatter.description) {
  frontmatter.description = rule.frontmatter.description;
}
// Add allowed-tools if specified in factory extension
const allowedTools = rule.frontmatter.factory?.allowedTools;
if (allowedTools && allowedTools.length > 0) {
  frontmatter['allowed-tools'] = mapTools(allowedTools, 'factory');
}

parts.push('---');
parts.push(serializeFrontmatter(frontmatter));
parts.push('---');
parts.push('');
parts.push(`# ${rule.frontmatter.name}`);
```

#### 5.2.2 Companion Files

```typescript
// Check for companion files in factory extension
const factoryExt = rule.frontmatter.factory;

// Generate references.md if specified
if (factoryExt?.references) {
  // Only generate if content is provided, otherwise skip
  // This is a placeholder for future content loading
}
```

### 5.3 Edge Cases to Handle

- [x] No factory extension → Generate basic frontmatter (name, description only)
- [x] Empty `allowed-tools` → Omit field from frontmatter
- [x] No description → Omit description from frontmatter
- [x] Special characters in name → Already handled by `toSafeFilename()`
- [x] Companion files not specified → Don't create empty files

### 5.4 Companion Files Support (Optional, Phase 2)

For now, just document the structure but don't implement file copying:

```
.factory/skills/<skill-name>/
├── SKILL.md           # Main skill file (required)
├── references.md      # Optional: Related documentation
├── checklists.md      # Optional: Implementation checklists
└── schemas/           # Optional: JSON/YAML schemas
    └── *.json
```

**Note**: Full companion file support requires:
1. Source content in the rule's directory
2. Copy logic during generation
3. This can be deferred to a future task

## 6. Test Requirements

### 6.1 Test File Structure

Extend `tests/unit/generators/factory.test.ts`:

```typescript
describe('generate() - skills (rules)', () => {
  // Existing tests...
  
  describe('frontmatter', () => {
    it('should include YAML frontmatter with name');
    it('should include description in frontmatter when present');
    it('should include allowed-tools when factory extension specifies');
    it('should omit allowed-tools when not specified');
    it('should map tool names using factory tool mapping');
  });
  
  describe('factory extension', () => {
    it('should respect factory-specific allowed-tools override');
  });
});
```

### 6.2 Required Test Cases

- [x] Basic skill generates frontmatter with `name`
- [x] Skill with description includes `description` in frontmatter
- [x] Skill with `factory.allowedTools` includes mapped `allowed-tools`
- [x] Empty `allowedTools` array omits field
- [x] Tool names are mapped via `mapTools()` for factory target
- [x] Generated file has correct structure:
  ```
  ---
  name: skill-name
  description: Skill description
  ---
  
  # skill-name
  
  > Skill description
  
  [content]
  ```

### 6.3 Reference Similar Tests

- `tests/unit/generators/claude.test.ts` lines 132-202 (Claude skill frontmatter tests)
- `tests/unit/generators/cursor.test.ts` (Cursor rule frontmatter tests)

## 7. Integration Points

- **Imports from**: 
  - `src/transformers/frontmatter.ts` (`serializeFrontmatter`)
  - `src/transformers/tool-mapper.ts` (`mapTools`)
- **Exports to**: Used by sync pipeline via `FactoryGenerator.generate()`
- **Config**: May add `factory.allowedTools` to rule frontmatter in future

## 8. Acceptance Criteria

- [x] Skills generate with YAML frontmatter block
- [x] Frontmatter includes `name` field
- [x] Frontmatter includes `description` when present
- [x] Frontmatter includes `allowed-tools` when factory extension specifies
- [x] Tool names are mapped to Factory format
- [x] All existing skill tests still pass
- [x] New frontmatter tests pass
- [x] No lint errors (`npm run lint`)
- [x] Types are strict (no `any`)

## 9. Out of Scope

- Companion file copying (future task - just add interface support)
- Factory droids tool restrictions (T206)
- Factory hooks support (T207)
- Adding `factory` extension to config.schema.json (separate schema task)

## 10. Implementation Checklist

1. [x] Add `FactoryRuleExtension` interface to rule types (already exists as `FactoryExtension` with `allowed-tools` and `tools` fields)
2. [x] Add `factory?: FactoryRuleExtension` to `ParsedRuleFrontmatter` (already exists in `Rule` interface)
3. [x] Update `generateSkillFile()` to output YAML frontmatter
4. [x] Import and use `serializeFrontmatter()` from transformers
5. [x] Add `allowed-tools` output when `factory.allowedTools` is specified
6. [x] Add tests for frontmatter generation
7. [x] Add tests for allowed-tools mapping
8. [x] Run lint and fix any issues
9. [ ] Update rule.schema.json to include factory extension (optional - out of scope)

## 11. Example Output

### Input (Rule Source)

```yaml
---
name: typescript-patterns
description: TypeScript best practices and patterns
factory:
  allowedTools: [read, edit, search]
---

# TypeScript Patterns

Follow these patterns...
```

### Output (.factory/skills/typescript-patterns/SKILL.md)

```markdown
---
name: typescript-patterns
description: TypeScript best practices and patterns
allowed-tools:
  - read
  - edit
  - search
---

# typescript-patterns

> TypeScript best practices and patterns

**Priority:** medium

# TypeScript Patterns

Follow these patterns...
```

