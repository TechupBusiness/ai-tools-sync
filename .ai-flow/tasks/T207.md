# T207: Add Factory Hooks Support

> **Priority**: P1 | **Wave**: 1 | **Track**: D (Factory Platform)
> **Depends on**: None
> **Estimated complexity**: Medium

## 1. Objective

Enable Factory hooks generation by mapping our generic hook format to Factory's hook system. Factory uses the same hook event system as Claude Code (both are Anthropic tools), writing hooks to `.factory/settings.json`. Currently, Factory hooks are skipped with a warning; this task removes that limitation and generates proper hook configuration.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:

- `src/generators/claude.ts` lines 66-132 - **Copy the entire hooks approach**: `ClaudeHookOutput`, `ClaudeHookEvent`, `mapEventToClaude()`, and `ClaudeSettings` interface
- `src/generators/claude.ts` lines 573-634 - **Copy `buildClaudeHooks()` method pattern** for combining parsed hooks with config hooks
- `src/generators/claude.ts` lines 677-729 - **Copy `generateSettings()` method** for settings.json generation
- `src/parsers/hook.ts` lines 38-53 - **Reference `HookEvent` type** with all supported events
- `src/config/types.ts` lines 91-104 - **Reference `ClaudeHookConfig`** for config.yaml hook structure

## 3. File Structure

```
src/
├── generators/
│   └── factory.ts        # Modify: add settings.json generation with hooks
├── config/
│   └── types.ts          # Modify: add FactorySettingsConfig, FactoryHookConfig
tests/
└── unit/
    └── generators/
        └── factory.test.ts   # Add: tests for hooks generation
```

## 4. Interfaces & Types

### 4.1 Add to `src/config/types.ts`

```typescript
/**
 * Factory hook configuration (for config.yaml)
 * Same structure as ClaudeHookConfig - Factory uses same event system
 */
export interface FactoryHookConfig {
  /** Hook identifier for logging/debugging */
  name?: string;
  /** Tool/pattern to match (e.g., 'Bash(*rm*)', 'Write|Edit') */
  matcher?: string;
  /** Shell command to execute */
  command: string;
  /** Hook type (defaults to 'command') */
  type?: 'command' | 'validation' | 'notification';
  /** Action for PreToolUse hooks (warn shows message, block stops) */
  action?: 'warn' | 'block';
  /** User-facing message */
  message?: string;
}

/**
 * Factory settings configuration
 */
export interface FactorySettingsConfig {
  /** Environment variables for Factory */
  env?: Record<string, string>;
  /** Hooks configuration by event type */
  hooks?: Record<string, FactoryHookConfig[]>;
}

/**
 * Factory platform-specific configuration
 */
export interface FactoryConfig {
  /** Factory settings */
  settings?: FactorySettingsConfig;
}
```

### 4.2 Update `Config` interface in `src/config/types.ts`

```typescript
export interface Config {
  // ... existing fields ...
  
  /** Factory platform-specific settings */
  factory?: FactoryConfig;
}
```

### 4.3 Add to `src/generators/factory.ts`

```typescript
/**
 * Factory hook output structure
 * Same as Claude - Factory uses identical event system
 */
interface FactoryHookOutput {
  type?: 'command' | 'validation' | 'notification';
  command?: string;
  matcher?: string;
  action?: 'warn' | 'block';
  message?: string;
}

/**
 * Supported Factory hook events (same as Claude Code)
 */
type FactoryHookEvent =
  | 'UserPromptSubmit'
  | 'PreToolUse'
  | 'PostToolUse'
  | 'Notification'
  | 'Stop'
  | 'SubagentStop'
  | 'SessionStart'
  | 'SessionEnd'
  | 'PreCompact';

/**
 * Factory settings.json structure
 */
interface FactorySettings {
  env?: Record<string, string>;
  hooks?: Partial<Record<FactoryHookEvent, FactoryHookOutput[]>>;
  __generated_by?: string;
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Copy Claude's hook event mapping approach exactly (same events: `PreToolUse`, `PostToolUse`, `UserPromptSubmit`, etc.)
- [x] Use `sortHooksByEvent()` from `base.ts` for consistent ordering
- [x] Add `__generated_by` marker when `options.addHeaders` is true
- [x] Export only from existing barrel files (no new exports needed)
- [x] Support both hook files AND config.yaml hooks (combined like Claude)

### 5.2 Critical Logic (Pitfall Prevention)

Remove the warning that skips hooks:

```typescript
// ❌ WRONG - Current implementation (lines 95-100)
// Handle hooks - warn and skip (Factory doesn't support hooks)
if (factoryContent.hooks.length > 0) {
  result.warnings.push(
    `Factory does not support hooks. ${factoryContent.hooks.length} hook(s) will be skipped.`
  );
}

// ✅ CORRECT - Generate settings.json when hooks exist
const hasSettings =
  factoryContent.hooks.length > 0 ||
  (factoryContent.factorySettings?.env && Object.keys(factoryContent.factorySettings.env).length > 0) ||
  (factoryContent.factorySettings?.hooks && Object.keys(factoryContent.factorySettings.hooks).length > 0);

if (hasSettings) {
  const settingsFile = this.generateSettings(
    factoryContent.hooks,
    factoryContent.factorySettings,
    options
  );
  generated.push(settingsFile);
}
```

Map events (copy from Claude, same events):

```typescript
/**
 * Map internal event names to Factory event names
 * Factory uses same events as Claude Code
 */
function mapEventToFactory(event: string): FactoryHookEvent | null {
  const eventMap: Record<string, FactoryHookEvent> = {
    // Direct mappings (same as Claude)
    'PreToolUse': 'PreToolUse',
    'PostToolUse': 'PostToolUse',
    'UserPromptSubmit': 'UserPromptSubmit',
    'Notification': 'Notification',
    'Stop': 'Stop',
    'SubagentStop': 'SubagentStop',
    'SessionStart': 'SessionStart',
    'SessionEnd': 'SessionEnd',
    'PreCompact': 'PreCompact',
    // Legacy event mappings
    'PreMessage': 'UserPromptSubmit',
    'PostMessage': 'PostToolUse',
    'PreCommit': 'PreToolUse',
  };
  
  return eventMap[event] ?? null;
}
```

### 5.3 Edge Cases to Handle

- [x] No hooks in input → Don't generate settings.json (unless env vars exist)
- [x] Hook with unsupported event → Skip silently (same as Claude behavior)
- [x] Hook with legacy event (PreMessage, PreCommit) → Map to correct Factory event
- [x] `PreCommit` event without matcher → Add default `Bash(git commit*)` matcher
- [x] Empty `matcher` or `*` matcher → Omit from output (matches all)
- [x] Both hook files AND config.yaml hooks → Merge them (hook files first)
- [x] `factory.settings.env` configured → Include in settings.json

## 6. Test Requirements

### 6.1 Test File Structure

Add to `tests/unit/generators/factory.test.ts`:

```typescript
describe('generate() - hooks (settings.json)', () => {
  describe('basic hook generation', () => {
    it('should generate settings.json with hooks', async () => { /* ... */ });
    it('should not generate settings.json when no hooks', async () => { /* ... */ });
  });

  describe('event mapping', () => {
    it('should map PreToolUse event correctly', async () => { /* ... */ });
    it('should map PostToolUse event correctly', async () => { /* ... */ });
    it('should map legacy PreMessage to UserPromptSubmit', async () => { /* ... */ });
    it('should map legacy PreCommit to PreToolUse with default matcher', async () => { /* ... */ });
    it('should skip unsupported events', async () => { /* ... */ });
  });

  describe('hook output format', () => {
    it('should include type, command, and matcher when present', async () => { /* ... */ });
    it('should omit matcher when not specified', async () => { /* ... */ });
    it('should include action and message for blocking hooks', async () => { /* ... */ });
  });

  describe('combined sources', () => {
    it('should merge hook files with config.yaml hooks', async () => { /* ... */ });
    it('should include env vars in settings.json', async () => { /* ... */ });
  });
});
```

### 6.2 Required Test Cases

- [x] **Basic hooks generation**:

```typescript
it('should generate settings.json with hooks', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    hooks: [
      createMockHook('pre-commit', ['factory']),
    ],
  });

  const result = await generator.generate(content);

  expect(result.files).toContain('.factory/settings.json');
  
  const settingsContent = await fs.readFile(
    path.join(tempDir, '.factory/settings.json'),
    'utf-8'
  );
  const settings = JSON.parse(settingsContent);
  expect(settings.hooks).toBeDefined();
  expect(settings.hooks.PreToolUse).toBeDefined();
});
```

- [x] **Event mapping**:

```typescript
it('should map PreToolUse event correctly', async () => {
  const hook = createMockHook('safety-check', ['factory']);
  hook.frontmatter.event = 'PreToolUse';
  hook.frontmatter.execute = 'echo "checking..."';
  hook.frontmatter.tool_match = 'Bash(*rm*)';

  const content = createMockContent({
    projectRoot: tempDir,
    hooks: [hook],
  });

  await generator.generate(content);

  const settings = JSON.parse(
    await fs.readFile(path.join(tempDir, '.factory/settings.json'), 'utf-8')
  );
  
  expect(settings.hooks.PreToolUse).toHaveLength(1);
  expect(settings.hooks.PreToolUse[0].command).toBe('echo "checking..."');
  expect(settings.hooks.PreToolUse[0].matcher).toBe('Bash(*rm*)');
});
```

- [x] **Legacy event mapping**:

```typescript
it('should map legacy PreCommit to PreToolUse with default matcher', async () => {
  const hook = createMockHook('lint-check', ['factory']);
  hook.frontmatter.event = 'PreCommit';
  hook.frontmatter.execute = './scripts/lint.sh';
  // No tool_match specified - should get default

  const content = createMockContent({
    projectRoot: tempDir,
    hooks: [hook],
  });

  await generator.generate(content);

  const settings = JSON.parse(
    await fs.readFile(path.join(tempDir, '.factory/settings.json'), 'utf-8')
  );
  
  expect(settings.hooks.PreToolUse[0].matcher).toBe('Bash(git commit*)');
});
```

- [x] **No hooks = no settings.json**:

```typescript
it('should not generate settings.json when no hooks or settings', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    rules: [createMockRule('some-rule')],
  });

  const result = await generator.generate(content);

  expect(result.files).not.toContain('.factory/settings.json');
});
```

- [x] **Remove the warning test**: Update existing test that expects warning:

```typescript
// Update this existing test in factory.test.ts
it('should NOT warn about hooks anymore (hooks now supported)', async () => {
  const content = createMockContent({
    projectRoot: tempDir,
    hooks: [createMockHook('test-hook', ['factory'])],
  });

  const result = await generator.generate(content);

  // Should NOT have warning about skipping hooks
  expect(result.warnings).not.toContain(
    expect.stringContaining('does not support hooks')
  );
  // Should have generated settings.json instead
  expect(result.files).toContain('.factory/settings.json');
});
```

## 7. Integration Points

- **Imports from**: 
  - `src/parsers/hook.ts` - use `ParsedHook`, `HookEvent`
  - `src/generators/base.ts` - use `sortHooksByEvent()`, `DO_NOT_EDIT_COMMENT_JSON`
- **Exports to**: No new exports (enhancing existing generator)
- **Config changes**: 
  - Add `FactoryConfig`, `FactorySettingsConfig`, `FactoryHookConfig` to `src/config/types.ts`
  - Add `factory?: FactoryConfig` to `Config` interface
- **ResolvedContent**: Add `factorySettings?: FactorySettingsConfig` field (similar to `claudeSettings`)

## 8. Acceptance Criteria

- [x] All existing tests still pass (`npm test -- factory.test.ts`)
- [x] New tests for hooks generation pass
- [x] `.factory/settings.json` generated when hooks exist
- [x] Hooks are correctly formatted with `type`, `command`, `matcher`, `action`, `message`
- [x] Event mapping matches Claude's implementation (same events)
- [x] Legacy events (PreMessage, PreCommit) correctly mapped
- [x] Warning about skipping hooks is removed
- [x] No lint errors (`npm run lint`)
- [x] Types are strict (no `any`)

## 9. Out of Scope

- Factory MCP generation (handled in T208)
- Factory skills generation (handled in T209)
- Factory droids enhancements beyond hooks (handled in T206)
- User-level settings (~/.factory/settings.json) - we only generate project-level
- Changes to hook parser (already supports `factory` extension)

## 10. Implementation Checklist

1. [x] Read Claude generator hooks implementation (`src/generators/claude.ts` lines 66-132, 573-729)
2. [x] Add `FactoryHookConfig`, `FactorySettingsConfig`, `FactoryConfig` to `src/config/types.ts`
3. [x] Add `factory?: FactoryConfig` to `Config` interface
4. [x] Add `factorySettings?: FactorySettingsConfig` to `ResolvedContent` in `src/generators/base.ts`
5. [x] Add Factory hook types to `src/generators/factory.ts` (copy from Claude)
6. [x] Add `mapEventToFactory()` function (copy from Claude's `mapEventToClaude`)
7. [x] Add `buildFactoryHooks()` method (copy pattern from Claude's `buildClaudeHooks`)
8. [x] Add `generateSettings()` method (copy pattern from Claude)
9. [x] Remove warning about skipping hooks in `generate()` method
10. [x] Add settings.json generation to `generate()` method
11. [x] Update `createMockHook()` in tests to support event customization
12. [x] Write test cases in `tests/unit/generators/factory.test.ts`
13. [x] Run `npm test -- factory.test.ts` to verify all tests pass
14. [x] Run `npm run lint` to verify no lint errors
15. [ ] Update docs if needed (`docs/GENERATORS.md` Factory hooks section)

