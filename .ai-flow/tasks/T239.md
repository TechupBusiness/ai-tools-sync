# T239: Generic Format File Generator Skill

> **Priority**: P2 | **Wave**: 3 | **Track**: F (Generic Format Skills)  
> **Depends on**: T231 (rule lint ready)  
> **Estimated complexity**: Medium

## 1. Objective
Add a generation “skill” that creates new generic format files (`rules/`, `personas/`, `commands/`, `hooks/` under `.ai-tool-sync/`) from scratch with platform-aware defaults. The tool should guide users (or other commands) to scaffold valid, lint-ready generic files without needing platform-specific knowledge, keeping generic schemas as the single source of truth.

## 2. Prior Art (IMPORTANT)
- `src/cli/commands/init.ts` – Pattern for scaffolding files, config dir resolution, safe overwrite prompts, gitignore updates.
- `src/cli/commands/migrate.ts` – Discovery + CLI UX patterns, prompt generation, and file collision handling.
- `src/parsers/{rule,persona,command,hook}.ts` – Canonical generic schemas; reuse to validate generated output.
- `src/transformers/frontmatter.ts`, `src/transformers/{tool-mapper,model-mapper}.ts` – Normalization helpers (snake_case, tool/model mapping) to produce platform-aware defaults.
- `src/utils/{fs.ts,logger.ts,result.ts,errors.ts}` – IO helpers, logging, `Result<T,E>`, `BaseError`.
- Tests: `tests/unit/cli/init.test.ts`, `tests/unit/cli/migrate.test.ts` – CLI patterns for prompts, stdout, file assertions.

## 3. File Structure
```
src/
├── creators/
│   ├── index.ts               # Public exports
│   ├── types.ts               # Generator types/options/errors
│   ├── templates.ts           # Default frontmatter/body templates per kind
│   ├── generator.ts           # Core generation + validation orchestration
│   └── writer.ts              # Path resolution, collision handling, writes
└── cli/
    └── commands/
        └── create.ts          # `ai-sync create <kind>` CLI entry (hooks into creators)
tests/
└── unit/
    └── creators/
        ├── generator.test.ts
        ├── templates.test.ts
        └── cli-create.test.ts
```

## 4. Interfaces & Types
```typescript
// src/creators/types.ts
export type GenericKind = 'rule' | 'persona' | 'command' | 'hook';
export type Priority = 'low' | 'medium' | 'high';

export interface GenerateOptions {
  kind: GenericKind;
  name: string;
  description?: string;
  targets?: string[];           // default to config targets or [cursor, claude, factory]
  globs?: string[];             // rules/commands
  tools?: string[];             // personas/commands; mapped via tool-mapper
  model?: string;               // personas; mapped via model-mapper
  execute?: string;             // commands
  priority?: Priority;          // rules
  template?: string;            // template ID (e.g., "rule/basic")
  body?: string;                // optional markdown body
  overwrite?: boolean;
  dryRun?: boolean;
  runLint?: boolean;            // requires T231 availability
  projectRoot?: string;
  configDir?: string;
}

export interface GeneratedFile {
  kind: GenericKind;
  path: string;                 // absolute path written (or would write on dry-run)
  frontmatter: Rule | Persona | Command | Hook;
  body: string;
  warnings: string[];
}

export interface GenerateIssue {
  level: 'error' | 'warning';
  field?: string;
  message: string;
  suggestion?: string;
}

export type GenerateResult = Result<GeneratedFile, GenerateError>;

export class GenerateError extends BaseError {
  constructor(message: string, readonly issues?: GenerateIssue[]) { super(message); }
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- [x] Use `Result<T, E>` from `src/utils/result.ts`; no thrown errors past the CLI boundary—use `GenerateError` (extends `BaseError`).
- [x] Keep generic frontmatter snake_case; platform-specific extras must live under `cursor`/`claude`/`factory` extension objects (see T212 learning).
- [x] Respect `exactOptionalPropertyTypes`: include optional keys only when defined; avoid `any`, prefer `unknown` + guards.
- [x] Imports use `@/` aliases and honor `import/order`.
- [x] Export only through `src/creators/index.ts` and add CLI export via `src/cli/index.ts`.
- [x] Use `ensureDir`/`writeFile` from `src/utils/fs.ts`; update `.gitignore` via existing helpers when new top-level paths are created.
- [x] Validate with parsers (`parseRule/parsePersona/...`) before writing; optionally run lint (T231) when `runLint` is true.

### 5.2 Critical Logic (Pitfall Prevention)
```typescript
// ❌ WRONG - leaves camelCase fields and skips parser validation
const fm = { name, description, alwaysApply: true, globs };
await writeFile(outPath, toFrontmatter(fm) + body);

// ✅ CORRECT - normalize, validate, and gate writes
const normalized = normalizeRuleFrontmatter({
  name,
  description,
  always_apply: alwaysApply ?? false,
  globs: splitGlobs(globs),
  targets: targets ?? DEFAULT_TARGETS,
});
const parsed = parseRule(normalized);
if (!parsed.ok) return err(new GenerateError('invalid rule', toIssues(parsed.error)));
if (opts.runLint) await runRuleLint(parsed.value, body);
return writeGeneratedFile(outPath, parsed.value, body, opts.dryRun);
```
- Ensure names are slugified consistently with existing content; reject/normalize whitespace and uppercase.
- Map tools/models through `tool-mapper`/`model-mapper`; warn on unknown values instead of dropping them.
- When file exists: if `overwrite` is false, emit warning and return `err`; if true, back up or log overwrite.
- Resolve config dir via `resolveConfigDir/getAiPaths` so custom `--config-dir` works; never assume `.ai-tool-sync/`.

### 5.3 Edge Cases to Handle
- [x] Missing name or invalid slug → `Result.err(GenerateError)` with suggestion.
- [x] No `targets` provided → default to config targets or `[cursor, claude, factory]`.
- [x] `globs` provided as comma/whitespace string → normalize to string[].
- [x] Duplicate filename (same kind/name) → block unless `overwrite`; ensure deterministic extension `.md`.
- [x] `runLint` requested but lint module absent (pre-T231) → warn and skip without failing.
- [x] Dry-run mode → produce preview path/content without writing.
- [x] Body omitted → use template body stub per kind; keep empty string valid.
- [x] Custom configDir/projectRoot → paths resolve correctly and directories are created lazily.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('creator/generator', () => {
  describe('rules', () => { /* normalization, lint hook */ });
  describe('personas', () => { /* tools/models mapping */ });
  describe('commands', () => { /* execute required */ });
  describe('hooks', () => { /* minimal schema */ });
});

describe('cli create', () => {
  it('writes to custom config dir and prints summary', /* ... */);
  it('blocks overwrite without --force', /* ... */);
  it('supports --dry-run', /* ... */);
});
```

### 6.2 Required Test Cases
- [x] Rule generation normalizes `always_apply`, splits comma globs, sets default `targets`, and passes `parseRule`.
- [x] Persona generation maps tools/models via mappers; warns on unknown values but keeps extensions.
- [x] Command generation requires `execute`; errors with actionable suggestion when missing.
- [x] Hook generation writes minimal valid frontmatter; validates via parser.
- [x] `--dry-run` produces no file writes but returns preview content/path.
- [x] `--force/overwrite` behavior verified (existing file vs overwrite).
- [x] `runLint` calls lint hook when available; skipped with warning when unavailable.
- [x] CLI respects custom `--config-dir` and relative `projectRoot`.
- [x] Error paths return `Result.err` with `GenerateIssue` details (field + suggestion).

## 7. Integration Points
- **Imports from**: `src/config/loader.ts` (`resolveConfigDir`, `getAiPaths`), `src/parsers/{rule,persona,command,hook}.ts`, `src/transformers/{frontmatter,tool-mapper,model-mapper}.ts`, `src/utils/{fs.ts,logger.ts,result.ts,errors.ts}`, `src/utils/gitignore.ts` (if new paths created).
- **Exports to**: CLI command `src/cli/commands/create.ts`; other commands (e.g., migrate/merge) may reuse generator to scaffold missing files.
- **Config**: Respect existing targets from config; honor `--config-dir` CLI option; update CLI help text/docs if new flags added.

## 8. Acceptance Criteria
- [x] Generator returns `Result` objects; no unhandled throws; uses `GenerateError`.
- [x] All generated files pass parsers; lint hook invoked when available; warnings surfaced.
- [x] File paths honor custom config dir; overwrite and dry-run behaviors tested.
- [x] Exports wired through `src/creators/index.ts` and CLI; imports use `@/` aliases; no `any`.
- [x] Tests added under `tests/unit/creators/` and CLI coverage added; CI commands remain green.
- [x] `npm run format:check`, `npm run lint`, and relevant `npm test -- creators` pass.
- [x] plan.md updated with T239 status once implemented.

## 9. Out of Scope
- Auto-generating rich rule/persona content (provide stubs only).
- Platform-specific output generation (handled by existing generators).
- Template variables/file includes (covered by T229-T237).

## 10. Guidelines for Writing Specs

DO Include:
- Exact generator interfaces and required options/flags.
- References to parsers/mappers to ensure schema correctness and platform-aware defaults.
- Pitfalls around snake_case frontmatter, optional prop gating, and overwrite safety.
- Edge-case checklist and CLI behaviors.

DO NOT Include:
- Full CLI implementation details beyond required flags/flow.
- Generic TypeScript basics or obvious parser usage.
- Optimizations unrelated to generation flow.

