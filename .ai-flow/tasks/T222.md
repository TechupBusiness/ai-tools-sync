# T222: Add Cleanup CLI Commands

> **Priority**: P2 | **Wave**: 4 | **Track**: B (CLI Commands)
> **Depends on**: T221 (Manifest Schema v2)
> **Estimated complexity**: Medium

## 1. Objective

Add two CLI commands for managing generated files: `ai-sync clean` to safely remove generated files (with hash-based protection for user-modified files) and `ai-sync status` to show which generated files exist and have been modified. These commands complete the generated file lifecycle by enabling users to clean up outputs and understand what has been generated vs. modified.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/cli/commands/validate.ts` - **Command structure and output patterns** (same structure for options, result, async function)
- `src/cli/commands/sync.ts` - **Manifest reading pattern** (lines 37-42: importing manifest utilities)
- `src/utils/manifest.ts` - **Manifest reading/parsing** (use `readManifest`, `parseManifest`)
- `src/utils/fs.ts` - **File operations** (use `fileExists`, `deleteFile`, `readFile`)
- `src/cli/output.ts` - **Console output formatting** (use `printHeader`, `printSuccess`, `printWarning`, etc.)
- `tests/unit/cli/validate.test.ts` - **Test patterns for CLI commands**

## 3. File Structure

```
src/
├── cli/
│   ├── commands/
│   │   ├── clean.ts          # Clean command implementation
│   │   └── status.ts         # Status command implementation
│   └── index.ts              # Add command registrations
├── utils/
│   └── manifest.ts           # Extend with hash utilities (from T221)
tests/
└── unit/
    └── cli/
        ├── clean.test.ts     # Clean command tests
        └── status.test.ts    # Status command tests
```

## 4. Interfaces & Types

### 4.1 Clean Command

```typescript
// In src/cli/commands/clean.ts

/**
 * Options for the clean command
 */
export interface CleanOptions {
  /** Enable verbose output */
  verbose?: boolean | undefined;
  /** Force removal of modified files */
  force?: boolean | undefined;
  /** Dry run mode - show what would be deleted */
  dryRun?: boolean | undefined;
  /** Project root directory */
  projectRoot?: string | undefined;
  /** Configuration directory name */
  configDir?: string | undefined;
}

/**
 * Result of the clean command
 */
export interface CleanResult {
  success: boolean;
  /** Files that were deleted */
  deleted: string[];
  /** Files skipped because they were modified by user */
  skipped: string[];
  /** Files that no longer exist (already cleaned) */
  missing: string[];
  /** Errors encountered during cleanup */
  errors: string[];
  /** Duration in milliseconds */
  duration: number;
}

/**
 * Status of a generated file for cleanup
 */
export interface FileCleanupStatus {
  path: string;
  status: 'unchanged' | 'modified' | 'missing';
  /** Hash from manifest (expected) */
  expectedHash?: string;
  /** Current file hash (if file exists) */
  currentHash?: string;
}
```

### 4.2 Status Command

```typescript
// In src/cli/commands/status.ts

/**
 * Options for the status command
 */
export interface StatusOptions {
  /** Enable verbose output (show all files, not just modified) */
  verbose?: boolean | undefined;
  /** Project root directory */
  projectRoot?: string | undefined;
  /** Configuration directory name */
  configDir?: string | undefined;
}

/**
 * Result of the status command
 */
export interface StatusResult {
  success: boolean;
  /** Total files tracked in manifest */
  totalFiles: number;
  /** Files that are unchanged since generation */
  unchangedFiles: number;
  /** Files that have been modified by user */
  modifiedFiles: number;
  /** Files that no longer exist */
  missingFiles: number;
  /** Detailed file statuses (populated when verbose) */
  files?: FileStatus[];
  /** Duration in milliseconds */
  duration: number;
}

/**
 * Status of a single generated file
 */
export interface FileStatus {
  path: string;
  status: 'unchanged' | 'modified' | 'missing';
}
```

### 4.3 Manifest V2 Extensions (from T221)

```typescript
// These types should exist in src/utils/manifest.ts after T221

/**
 * Manifest file entry with hash
 */
export interface ManifestFileEntry {
  path: string;
  hash: string; // SHA256 hash
}

/**
 * Manifest v2 structure with file hashes
 */
export interface ManifestV2 {
  version: string;
  timestamp: string;
  files: ManifestFileEntry[];
  directories: string[];
}

/**
 * Compute SHA256 hash of file contents
 */
export async function computeFileHash(filePath: string): Promise<Result<string>>;

/**
 * Check if a file has been modified since generation
 */
export async function isFileModified(
  projectRoot: string,
  entry: ManifestFileEntry
): Promise<Result<boolean>>;
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [ ] Use `Result<T, E>` for error handling (see `src/utils/result.ts`)
- [ ] Import output functions from `src/cli/output.ts` (don't use `console.log` directly)
- [ ] Mock logger and output in tests (see `tests/unit/cli/validate.test.ts`)
- [ ] Follow existing CLI command structure: options interface, result interface, async function
- [ ] Register commands in `src/cli/index.ts`
- [ ] Export types from `src/cli/index.ts` for programmatic usage

### 5.2 Critical Logic (Pitfall Prevention)

#### Clean Command Implementation

```typescript
// ❌ WRONG - Deleting without checking hash
for (const file of manifest.files) {
  await deleteFile(file.path);
}

// ✅ CORRECT - Check hash before deleting
for (const entry of manifest.files) {
  const modifiedResult = await isFileModified(projectRoot, entry);
  
  if (!modifiedResult.ok) {
    errors.push(`Failed to check ${entry.path}: ${modifiedResult.error.message}`);
    continue;
  }
  
  if (modifiedResult.value && !options.force) {
    // File was modified, skip unless --force
    skipped.push(entry.path);
    printWarning(`Skipping modified file: ${entry.path}`);
    continue;
  }
  
  // Safe to delete
  const deleteResult = await deleteFile(path.join(projectRoot, entry.path));
  if (deleteResult.ok) {
    deleted.push(entry.path);
  } else {
    errors.push(`Failed to delete ${entry.path}: ${deleteResult.error.message}`);
  }
}
```

#### Status Command File Checking

```typescript
/**
 * Get the status of all tracked files
 */
async function getFileStatuses(
  projectRoot: string,
  manifest: ManifestV2
): Promise<FileStatus[]> {
  const statuses: FileStatus[] = [];

  for (const entry of manifest.files) {
    const filePath = path.join(projectRoot, entry.path);
    
    if (!(await fileExists(filePath))) {
      statuses.push({ path: entry.path, status: 'missing' });
      continue;
    }

    const modifiedResult = await isFileModified(projectRoot, entry);
    
    if (!modifiedResult.ok) {
      // Treat errors as "missing" for status purposes
      statuses.push({ path: entry.path, status: 'missing' });
      continue;
    }

    statuses.push({
      path: entry.path,
      status: modifiedResult.value ? 'modified' : 'unchanged',
    });
  }

  return statuses;
}
```

#### CLI Registration Pattern

```typescript
// In src/cli/index.ts

import { clean } from './commands/clean.js';
import { status } from './commands/status.js';

// Add clean command
program
  .command('clean')
  .description('Remove generated files')
  .option('-v, --verbose', 'Show detailed output')
  .option('-f, --force', 'Remove even modified files (with warnings)')
  .option('-d, --dry-run', 'Show what would be deleted without deleting')
  .option('-p, --project <path>', 'Project root directory')
  .option('-c, --config-dir <path>', 'Configuration directory name')
  .action(async (options: {
    verbose?: boolean;
    force?: boolean;
    dryRun?: boolean;
    project?: string;
    configDir?: string;
  }) => {
    if (options.verbose) {
      logger.setVerbose(true);
    }

    try {
      const result = await clean({
        verbose: options.verbose,
        force: options.force,
        dryRun: options.dryRun,
        projectRoot: options.project,
        configDir: options.configDir,
      });

      if (!result.success) {
        process.exit(1);
      }
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      logger.error(`Clean failed: ${message}`);
      process.exit(1);
    }
  });

// Add status command
program
  .command('status')
  .description('Show status of generated files')
  .option('-v, --verbose', 'Show all files, not just summary')
  .option('-p, --project <path>', 'Project root directory')
  .option('-c, --config-dir <path>', 'Configuration directory name')
  .action(async (options: {
    verbose?: boolean;
    project?: string;
    configDir?: string;
  }) => {
    if (options.verbose) {
      logger.setVerbose(true);
    }

    try {
      const result = await status({
        verbose: options.verbose,
        projectRoot: options.project,
        configDir: options.configDir,
      });

      if (!result.success) {
        process.exit(1);
      }
    } catch (error) {
      const message = error instanceof Error ? error.message : String(error);
      logger.error(`Status failed: ${message}`);
      process.exit(1);
    }
  });
```

### 5.3 Edge Cases to Handle

#### Clean Command
- [ ] No manifest file exists → Return success with message "Nothing to clean"
- [ ] Empty manifest (no files) → Return success with message "No generated files found"
- [ ] File already deleted → Log as "already missing", don't error
- [ ] Permission denied on delete → Log error, continue with other files
- [ ] Modified file without `--force` → Skip with warning, increment skipped count
- [ ] Modified file with `--force` → Delete with warning about losing changes
- [ ] Manifest v1 format (no hashes) → Warn user and require `--force` for all files

#### Status Command
- [ ] No manifest file exists → Return success with "No generated files tracked"
- [ ] Empty manifest → Return success with "No generated files found"
- [ ] File no longer exists → Status = "missing"
- [ ] Hash mismatch → Status = "modified"
- [ ] Hash matches → Status = "unchanged"
- [ ] Manifest v1 format (no hashes) → Report all files as "unknown" (can't verify)

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/cli/clean.test.ts

describe('Clean Command', () => {
  describe('no manifest', () => {
    it('should succeed when no manifest exists', async () => { /* ... */ });
  });

  describe('with v2 manifest', () => {
    describe('unchanged files', () => {
      it('should delete unchanged files', async () => { /* ... */ });
      it('should report deleted files count', async () => { /* ... */ });
    });

    describe('modified files', () => {
      it('should skip modified files by default', async () => { /* ... */ });
      it('should warn about skipped modified files', async () => { /* ... */ });
      it('should delete modified files with --force', async () => { /* ... */ });
      it('should warn when deleting modified files with --force', async () => { /* ... */ });
    });

    describe('missing files', () => {
      it('should handle already deleted files gracefully', async () => { /* ... */ });
    });

    describe('dry run', () => {
      it('should not delete files in dry run mode', async () => { /* ... */ });
      it('should show what would be deleted', async () => { /* ... */ });
    });
  });

  describe('with v1 manifest (no hashes)', () => {
    it('should require --force when manifest lacks hashes', async () => { /* ... */ });
    it('should warn about inability to detect modifications', async () => { /* ... */ });
  });

  describe('error handling', () => {
    it('should continue on delete errors', async () => { /* ... */ });
    it('should report all errors at end', async () => { /* ... */ });
  });
});
```

```typescript
// tests/unit/cli/status.test.ts

describe('Status Command', () => {
  describe('no manifest', () => {
    it('should succeed when no manifest exists', async () => { /* ... */ });
    it('should report zero files', async () => { /* ... */ });
  });

  describe('with v2 manifest', () => {
    it('should count unchanged files', async () => { /* ... */ });
    it('should count modified files', async () => { /* ... */ });
    it('should count missing files', async () => { /* ... */ });
    it('should return file details in verbose mode', async () => { /* ... */ });
  });

  describe('output formatting', () => {
    it('should show summary by default', async () => { /* ... */ });
    it('should show file list in verbose mode', async () => { /* ... */ });
    it('should highlight modified files', async () => { /* ... */ });
  });
});
```

### 6.2 Required Test Cases

```typescript
// Clean command - basic flow
it('should delete unchanged files and skip modified ones', async () => {
  // Create manifest with files
  const manifest: ManifestV2 = {
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    files: [
      { path: '.cursor/rules/test.mdc', hash: 'sha256:abc123...' },
      { path: 'CLAUDE.md', hash: 'sha256:def456...' },
    ],
    directories: ['.cursor/rules/'],
  };
  await writeManifest(testDir, manifest);
  
  // Create files with matching and non-matching hashes
  await writeFileWithHash(testDir, '.cursor/rules/test.mdc', 'content', 'sha256:abc123...');
  await writeFile(path.join(testDir, 'CLAUDE.md'), 'modified content'); // Different hash
  
  const result = await clean({ projectRoot: testDir });
  
  expect(result.success).toBe(true);
  expect(result.deleted).toContain('.cursor/rules/test.mdc');
  expect(result.skipped).toContain('CLAUDE.md');
  expect(await fileExists(path.join(testDir, '.cursor/rules/test.mdc'))).toBe(false);
  expect(await fileExists(path.join(testDir, 'CLAUDE.md'))).toBe(true);
});

// Status command - summary
it('should report correct counts', async () => {
  const manifest: ManifestV2 = {
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    files: [
      { path: 'unchanged.md', hash: 'sha256:aaa...' },
      { path: 'modified.md', hash: 'sha256:bbb...' },
      { path: 'missing.md', hash: 'sha256:ccc...' },
    ],
    directories: [],
  };
  await writeManifest(testDir, manifest);
  
  // Create only unchanged and modified files
  await writeFileWithMatchingHash(testDir, 'unchanged.md', 'content');
  await writeFile(path.join(testDir, 'modified.md'), 'different content');
  // missing.md intentionally not created
  
  const result = await status({ projectRoot: testDir });
  
  expect(result.success).toBe(true);
  expect(result.unchangedFiles).toBe(1);
  expect(result.modifiedFiles).toBe(1);
  expect(result.missingFiles).toBe(1);
  expect(result.totalFiles).toBe(3);
});
```

## 7. Integration Points

- **Imports from**:
  - `src/utils/manifest.ts` - `readManifest`, `ManifestV2`, `computeFileHash`, `isFileModified`
  - `src/utils/fs.ts` - `fileExists`, `deleteFile`
  - `src/cli/output.ts` - output formatting functions
  - `src/utils/logger.ts` - debug logging
- **Exports to**:
  - CLI users via `ai-sync clean` and `ai-sync status` commands
  - Programmatic usage via exported functions
- **Config**: Uses `projectRoot` and `configDir` options, no schema changes

## 8. Acceptance Criteria

- [ ] `ai-sync status` shows summary of generated files (unchanged/modified/missing counts)
- [ ] `ai-sync status --verbose` shows per-file status
- [ ] `ai-sync clean` removes unchanged files, skips modified files
- [ ] `ai-sync clean --force` removes all files including modified (with warnings)
- [ ] `ai-sync clean --dry-run` shows what would be deleted without deleting
- [ ] Manifest without hashes (v1) requires `--force` for clean
- [ ] All tests pass (`npm test -- clean.test.ts status.test.ts`)
- [ ] No lint errors (`npm run lint`)
- [ ] Types are strict (no `any`)
- [ ] Commands registered in CLI index
- [ ] Types exported from CLI index
- [ ] plan.md is updated with completion status

## 9. Out of Scope

- Manifest v2 schema implementation (handled in T221)
- Hash computation utilities (handled in T221)
- Migration from v1 to v2 manifest (handled in T221)
- Per-run manifest history/snapshots (handled in T220)
- Cleaning directories (only files are tracked with hashes)
- Interactive prompts for modified files (use `--force` flag instead)

## 10. Output Examples

### Status Command

```
━━━ AI Tool Sync Status ━━━

Generated files: 12 total
  ✓ 8 unchanged
  ⚠ 3 modified
  ✗ 1 missing

Modified files:
  ⚠ .cursor/rules/custom.mdc
  ⚠ CLAUDE.md
  ⚠ .factory/droids/implementer.md

Missing files:
  ✗ .claude/commands/old-cmd.md

──────────────────────────────────────────────────
✓ Status complete
  Completed in 45ms
```

### Clean Command (default)

```
━━━ AI Tool Sync Clean ━━━

Removing generated files...
  - .cursor/rules/core.mdc
  - .cursor/rules/database.mdc
  - .cursor/commands/roles/implementer.md
  ⚠ Skipping modified: CLAUDE.md
  ⚠ Skipping modified: .factory/droids/implementer.md

──────────────────────────────────────────────────
✓ Cleaned 3 files, skipped 2 modified files
  Completed in 67ms
```

### Clean Command (--force)

```
━━━ AI Tool Sync Clean ━━━

⚠ Force mode - will delete modified files

Removing generated files...
  - .cursor/rules/core.mdc
  - .cursor/rules/database.mdc
  ⚠ Removing modified: CLAUDE.md (user changes will be lost)
  ⚠ Removing modified: .factory/droids/implementer.md (user changes will be lost)

──────────────────────────────────────────────────
⚠ Cleaned 4 files (2 had user modifications)
  Completed in 89ms
```

### Clean Command (--dry-run)

```
━━━ AI Tool Sync Clean ━━━

Dry run - no files will be deleted

Would delete:
  - .cursor/rules/core.mdc
  - .cursor/rules/database.mdc
  - .cursor/commands/roles/implementer.md

Would skip (modified):
  ⚠ CLAUDE.md
  ⚠ .factory/droids/implementer.md

──────────────────────────────────────────────────
Dry run complete - 3 files would be deleted, 2 skipped
```

## 11. Implementation Checklist

1. [ ] Verify T221 is complete (manifest v2 with hashes)
2. [x] Create `src/cli/commands/status.ts` with `status()` function
3. [x] Create `src/cli/commands/clean.ts` with `clean()` function
4. [x] Register both commands in `src/cli/index.ts`
5. [x] Export types from `src/cli/index.ts`
6. [x] Create `tests/unit/cli/status.test.ts`
7. [x] Create `tests/unit/cli/clean.test.ts`
8. [x] Run `npm test -- status.test.ts clean.test.ts`
9. [x] Run `npm run lint`
10. [x] Run `npm run typecheck`
11. [ ] Update plan.md with T222 completion status

