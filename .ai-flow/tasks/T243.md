# T243: Prepare npm package for publishing

> **Priority**: P0 | **Wave**: 1 | **Track**: B (npm Publishing)  
> **Depends on**: T240  
> **Estimated complexity**: Medium

## 1. Objective
Ensure the npm package manifest and published artifacts are production-ready so `npm publish` works without manual fixes. Verify metadata, allowlisted files, and CLI entry points so consumers get a minimal, correct install with working bin, documentation links, and funding information.

## 2. Prior Art (IMPORTANT)
- `package.json` - Current metadata, exports, scripts, `files` allowlist to audit/update
- `tsup.config.ts` - Build outputs (dist targets, dual ESM/CJS) that `main/module/types/exports` must align with
- `bin/ai-sync.js` - CLI shim that imports `dist/cli/index.js`; must remain valid after pack
- `.github/workflows/test.yml` - CI build/test expectations to mirror for prepublish validation

## 3. File Structure
```
.
├── package.json         # Update metadata, funding, publishConfig, files allowlist
├── bin/
│   └── ai-sync.js       # CLI entry (must stay executable after pack)
├── tsup.config.ts       # Build outputs referenced by exports/main/module/types
└── dist/                # Built artifacts produced by tsup (not checked in; included via files)
```

## 4. Interfaces & Types
```typescript
interface PackageMetadata {
  name: string;                 // Final npm name (scoped or unscoped)
  version: string;              // Semver aligned with release plan
  description: string;          // Short package summary
  repository: { type: 'git'; url: string };  // Canonical GitHub URL
  bugs: { url: string };        // Issue tracker URL
  homepage: string;             // Landing page (README anchor)
  license: string;              // SPDX identifier
  keywords: string[];           // Discoverability
  engines: { node: string };    // Node support; must match build target
  files: string[];              // Allowlisted publish artifacts
  bin: Record<string, string>;  // CLI entry points
  funding?: string | { type: string; url: string }; // Optional funding link
  publishConfig?: { access?: 'public' | 'restricted'; registry?: string }; // npm publish settings
}
```

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)
- [ ] Keep `exports`/`main`/`module`/`types` aligned with `tsup.config.ts` outputs (ESM + CJS + dts) to avoid runtime resolution errors.
- [ ] Use the `files` allowlist (not `.npmignore`) and ensure it includes `dist`, `bin`, `defaults`, `targets`, and any other runtime assets; exclude tests, coverage, fixtures by omission.
- [ ] Preserve `engines.node >=18` to match `tsup` target and README badge.
- [ ] When adding optional fields (e.g., `funding`, `publishConfig`), omit keys instead of setting `undefined` to satisfy `exactOptionalPropertyTypes` (see learnings T159/T160).
- [ ] Update `repository`, `bugs`, and `homepage` to the canonical GitHub repo and README anchor so npm links are correct.
- [ ] Leave CLI entry (`bin/ai-sync.js`) pointing at built output; do not introduce TS/tsx-only dependencies into runtime paths.

### 5.2 Critical Logic (Pitfall Prevention)
```json
// ❌ WRONG - relies on .npmignore and forgets CLI/bin
{
  "files": ["dist", "defaults"]
}

// ✅ CORRECT - allowlist runtime assets and CLI
{
  "files": ["dist", "bin", "defaults", "targets"]
}
```

```json
// ❌ WRONG - publish uses private registry defaults
{
  "publishConfig": { "access": "restricted" }
}

// ✅ CORRECT - explicit public publish to npmjs
{
  "publishConfig": { "access": "public", "registry": "https://registry.npmjs.org" }
}
```

```javascript
// ❌ WRONG - bin references TS sources (fails post-install)
"bin": { "ai-sync": "./src/cli/index.ts" }

// ✅ CORRECT - bin points to compiled JS
"bin": { "ai-sync": "./bin/ai-sync.js" }
```

### 5.3 Edge Cases to Handle
- [ ] `npm pack --dry-run` should NOT include `coverage/`, `tests/`, `src/`, `.ai-flow/`, `.github/`, or vitest snapshots/fixtures.
- [ ] Tarball install (`npm install ./ai-tool-sync-*.tgz`) must run `ai-sync --help` without devDependencies or TypeScript available.
- [ ] `license` and `README.md` should be included by default; ensure nothing in `files` or future `.npmignore` would exclude them.
- [ ] Version bump workflow should keep `prepublishOnly` reproducible (build + tests) and not depend on local paths.

## 6. Test Requirements

### 6.1 Test File Structure
```typescript
describe('npm package readiness', () => {
  describe('pack contents', () => { /* dry-run file list assertions */ });
  describe('cli entrypoint', () => { /* ai-sync --version/help from packed tarball */ });
  describe('metadata links', () => { /* repository/bugs/homepage correctness */ });
});
```

### 6.2 Required Test Cases
- [ ] `npm run build` produces `dist/` with both ESM and CJS + dts.
- [ ] `npm test` still passes after metadata changes.
- [ ] `npm pack --dry-run` lists only expected files (`dist`, `bin`, `defaults`, `targets`, `LICENSE`, `README`, `package.json`).
- [ ] Install from packed tarball in a clean temp dir and run `npx ai-sync --version` (or `ai-sync --help`) to confirm bin works.
- [ ] Spot-check metadata links from `npm view <package> repository.url bugs.url homepage` (or local package.json) for correctness.

## 7. Integration Points
- **Build**: `tsup.config.ts` outputs must match `exports` map and `bin` target.
- **CLI**: `bin/ai-sync.js` dynamically imports `dist/cli/index.js`; packaging must ship that path.
- **Release Automation**: T244 release workflow will rely on accurate `publishConfig` and metadata.
- **Docs/Badges**: README updates from T240 should match `engines`/version fields to avoid mismatched badges.

## 8. Acceptance Criteria
- [ ] `package.json` metadata is accurate (name, description, keywords, repository, bugs, homepage, license, engines) and includes `funding` if applicable.
- [ ] `files` allowlist includes all runtime assets (dist, bin, defaults, targets) and excludes tests/coverage/fixtures by omission.
- [ ] `publishConfig` explicitly set for public npm publish with correct registry (unless already correct).
- [ ] `npm pack --dry-run` output matches expected file list; tarball install runs `ai-sync --help` successfully.
- [ ] No lint/typecheck regressions from metadata/script changes.
- [ ] plan.md updated to reflect T243 completion status when done.

## 9. Out of Scope
- Actual publishing to npm (handled in T245)
- Release workflow automation (T244)
- Homebrew/Docker/npx wrappers (T246-T249)
- Windows test script fix (T255)
- Version bumping strategy beyond setting correct metadata

## 10. Guidelines for Writing Specs

DO Include:
- Explicit field names to touch in `package.json`, expected `files` contents, and registry/access settings.
- References to source files for patterns (`package.json`, `tsup.config.ts`, `bin/ai-sync.js`).
- Clear dry-run/pack validation steps and bin smoke test expectations.
- Edge-case exclusions (tests/coverage/fixtures) so a junior dev doesn't guess.

DO NOT Include:
- Full publish workflow steps (T244/T245 handle automation and execution).
- Unimplemented platform work (Homebrew, Docker, template variables).
- Generic TypeScript primers or unrelated code patterns.
- Changing CLI behavior beyond ensuring the bin resolves compiled output.

