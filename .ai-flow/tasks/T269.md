# T269: Refactor Loader Configuration - Per-Loader `use` and Remove `ai-tool-sync` Type

> **Priority**: P1 | **Wave**: 1 | **Track**: A (Core Infrastructure)
> **Depends on**: None
> **Estimated complexity**: Medium

## 1. Objective

Refactor the loader system to move the `use` filter from global config into each loader's configuration, enabling per-source content selection. Remove the `ai-tool-sync` loader type since defaults should be loaded via standard loaders (npm/local/git). Support `*` wildcard to select all items of a type.

## 2. Prior Art

- `src/config/types.ts:58-64` - Current LoaderConfig interface
- `src/config/types.ts:105-112` - Current UseConfig interface
- `src/config/defaults.ts:40-42` - DEFAULT_LOADERS with ai-tool-sync
- `src/cli/commands/sync.ts:336-357` - Loader processing in loadContent
- `src/cli/commands/sync.ts:367-386` - filterByUseConfig function

## 3. File Structure

!!!
src/
├── config/
│   ├── types.ts          # Update LoaderConfig, remove global UseConfig
│   ├── defaults.ts       # Update DEFAULT_LOADERS (empty or local only)
│   └── validator.ts      # Update schema validation
├── cli/commands/
│   └── sync.ts           # Update loadContent to use per-loader filtering
└── loaders/
    └── base.ts           # Add use filtering to LoadResult processing
!!!

## 4. Interfaces & Types

!!!typescript
// Updated LoaderConfig with per-loader use
export interface LoaderConfig {
  type: 'local' | 'npm' | 'pip' | 'git' | 'url' | 'claude-plugin';
  source?: string;
  package?: string;
  version?: string;
  use?: LoaderUseConfig;
}

// Per-loader use configuration (supports '*' wildcard)
export interface LoaderUseConfig {
  rules?: string[] | '*';
  personas?: string[] | '*';
  commands?: string[] | '*';
  hooks?: string[] | '*';
}
!!!

## 5. Implementation Requirements

### 5.1 Remove `ai-tool-sync` Loader Type

- Remove `'ai-tool-sync'` from LoaderConfig.type union
- Remove handling in sync.ts loadContent function (lines 338-346)
- Update DEFAULT_LOADERS to empty array `[]`
- Update docs/LOADERS.md to remove ai-tool-sync section

### 5.2 Move `use` Into LoaderConfig

- Add optional `use?: LoaderUseConfig` to LoaderConfig interface
- Remove global `UseConfig` from Config interface
- Update schema validation for new structure

### 5.3 Implement Wildcard Support

- `'*'` means include all items of that type from the loader
- Explicit array `['name1', 'name2']` filters to only those items
- Omitted key means include all (same as `'*'`)

### 5.4 Update Content Filtering

Move filtering from global `filterByUseConfig` to per-loader in `loadContent`:

!!!typescript
// After loading from each source, apply its use filter
const result = await loader.load(source, options);
const filtered = applyLoaderUseFilter(result, loaderConfig.use);
results.push(filtered);
!!!

### 5.5 Config Migration Path

Old format (deprecated):
!!!yaml
loaders:
  - type: ai-tool-sync
use:
  personas: [architect]
!!!

New format:
!!!yaml
loaders:
  - type: npm
    package: "@ai-tool-sync/defaults"
    use:
      personas: [architect, implementer]
      commands: '*'
!!!

## 6. Test Requirements

### 6.1 Required Test Cases

- [ ] Loader without `use` includes all content
- [ ] Loader with `use.personas: ['x']` filters to only persona x
- [ ] Loader with `use.rules: '*'` includes all rules
- [ ] Multiple loaders with different `use` configs work independently
- [ ] Empty `use: {}` includes all content
- [ ] Invalid loader type rejected by schema

### 6.2 Test File

Update `tests/config/loader.test.ts` and `tests/cli/sync.test.ts`

## 7. Acceptance Criteria

- [ ] `ai-tool-sync` loader type removed from codebase
- [ ] `use` field available on each loader config
- [ ] `*` wildcard supported for each content type
- [ ] Global `use` config removed from Config type
- [ ] Schema validation updated
- [ ] docs/LOADERS.md updated
- [ ] Existing tests updated/passing
- [ ] Format check pass

## 8. Future Consideration

Defaults content should be extracted to separate npm package (`@ai-tool-sync/defaults`) loaded via npm loader. This enables:
- Independent versioning of prompts vs sync tool
- Community contributions to prompts
- Multiple official prompt packs per stack
