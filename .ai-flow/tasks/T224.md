# T224: Simplify Root Gitignore for Distributed Mode

> **Priority**: P2 | **Wave**: 5 | **Track**: A (Per-Tool Gitignores)
> **Depends on**: T223 ✅ (per-tool-folder gitignores)
> **Estimated complexity**: Low

## 1. Objective

Simplify the root `.gitignore` to only contain non-tool-folder files (`CLAUDE.md`, `AGENTS.md`, `mcp.json`, `.ai-tool-sync-generated`). Tool-folder paths (`.cursor/`, `.claude/`, `.factory/`) are excluded from root gitignore since they're already managed by per-folder gitignores created in T223. This provides cleaner separation of concerns and makes it easier to understand what's generated at each level. No configuration option needed—this is the new default behavior.

## 2. Prior Art (IMPORTANT)

Reference existing implementations to copy patterns from:
- `src/utils/gitignore.ts` - **Lines 168-179**: `getDefaultGitignorePaths()` to simplify
- `src/utils/manifest.ts` - **Lines 188-208**: `getGitignorePaths()` to simplify (remove directories)
- `src/utils/manifest.ts` - **Lines 50-64**: `DEFAULT_GENERATED_*` constants pattern
- `tests/unit/utils/gitignore.test.ts` - **Lines 220-233**: Existing test for `getDefaultGitignorePaths()`
- `.ai-flow/tasks/T223.md` - Related task for per-tool gitignores

## 3. File Structure

```
src/
├── utils/
│   ├── gitignore.ts          # Update getDefaultGitignorePaths() to root-only
│   └── manifest.ts           # Update getGitignorePaths() to root-only
tests/
└── unit/
    └── utils/
        ├── gitignore.test.ts # Update tests for new behavior
        └── manifest.test.ts  # Update tests for new behavior
```

## 4. Interfaces & Types

No new interfaces needed. The existing `UpdateGitignoreOptions` remains unchanged. We're simply changing the default behavior of `updateGitignore()` and related functions.

## 5. Implementation Requirements

### 5.1 Must Follow (Project Patterns)

- [x] Use `Result<T, E>` for errors (see `src/utils/result.ts`)
- [x] Reuse existing `updateGitignoreContent()`, `createManagedSection()` utilities
- [x] Export from `src/utils/index.ts` if adding new public functions
- [x] No `any` types
- [x] Run `npm run lint --fix` after implementation
- [x] Run `npm run typecheck` after implementation

### 5.2 Critical Logic (Pitfall Prevention)

#### 5.2.1 Update getDefaultGitignorePaths()

```typescript
// ✅ CORRECT - Change default paths to root-only
// In src/utils/gitignore.ts

/**
 * Get default paths for gitignore when no manifest exists
 * Only includes root-level files (tool folders manage their own gitignores via T223)
 */
export function getDefaultGitignorePaths(): string[] {
  return [
    'CLAUDE.md',
    'AGENTS.md',
    'mcp.json',
    MANIFEST_FILENAME,
  ];
}
```

#### 5.2.2 Update getGitignorePaths() in manifest.ts

```typescript
// ✅ CORRECT - Only return root-level files from manifest
// In src/utils/manifest.ts

/**
 * Root-level files that may be generated (not in tool folders)
 */
export const DEFAULT_GENERATED_ROOT_FILES: readonly string[] = [
  'CLAUDE.md',
  'AGENTS.md',
  'mcp.json',
] as const;

/**
 * Get all paths that should be in root .gitignore
 * Only includes root-level files, not tool folder paths
 */
export function getGitignorePaths(manifest: ManifestV2): string[] {
  const paths: string[] = [];

  // Only include root-level files from manifest
  for (const file of manifest.files) {
    if (DEFAULT_GENERATED_ROOT_FILES.includes(file.path)) {
      paths.push(file.path);
    }
  }

  // Always include manifest file
  paths.push(MANIFEST_FILENAME);

  return [...new Set(paths)].sort();
}
```

#### 5.2.3 Remove DEFAULT_GENERATED_DIRECTORIES from gitignore paths

```typescript
// ❌ WRONG - Including tool folders in root gitignore (old behavior)
export function getGitignorePaths(manifest: ManifestV2): string[] {
  for (const dir of manifest.directories) {
    if (DEFAULT_GENERATED_DIRECTORIES.includes(dir)) {
      paths.push(dir);  // Don't do this anymore
    }
  }
}

// ✅ CORRECT - Skip directories entirely, they're handled by per-folder gitignores
export function getGitignorePaths(manifest: ManifestV2): string[] {
  // Only process manifest.files, not manifest.directories
  for (const file of manifest.files) {
    if (DEFAULT_GENERATED_ROOT_FILES.includes(file.path)) {
      paths.push(file.path);
    }
  }
}
```

### 5.3 Edge Cases to Handle

- [x] Root gitignore only contains `CLAUDE.md`, `AGENTS.md`, `mcp.json`, manifest (new default)
- [x] No root files generated → Root gitignore only has manifest file
- [x] Manifest is null → Use default root-only paths
- [x] Existing managed section in root gitignore → Replace with new (smaller) content
- [x] `mcp.json` not generated (no MCP config) → Don't include in paths
- [x] Only some root files generated → Only include those present in manifest

## 6. Test Requirements

### 6.1 Test File Structure

```typescript
// tests/unit/utils/gitignore.test.ts - UPDATE existing tests

describe('getDefaultGitignorePaths', () => {
  it('should return only root-level files', () => { /* ... */ });
  it('should always include manifest file', () => { /* ... */ });
  it('should NOT include tool folder paths', () => { /* ... */ });
});

// tests/unit/utils/manifest.test.ts - UPDATE existing tests

describe('getGitignorePaths', () => {
  it('should return only root-level files from manifest', () => { /* ... */ });
  it('should exclude tool folder paths and directories', () => { /* ... */ });
  it('should always include manifest file', () => { /* ... */ });
});
```

### 6.2 Required Test Cases

```typescript
// Test: getDefaultGitignorePaths returns only root files
it('should return only root-level files', () => {
  const paths = getDefaultGitignorePaths();

  expect(paths).toContain('CLAUDE.md');
  expect(paths).toContain('AGENTS.md');
  expect(paths).toContain('mcp.json');
  expect(paths).toContain('.ai-tool-sync-generated');
  
  // Should NOT include tool folders
  expect(paths).not.toContain('.cursor/rules/');
  expect(paths).not.toContain('.cursor/commands/');
  expect(paths).not.toContain('.claude/');
  expect(paths).not.toContain('.factory/');
  
  expect(paths.length).toBe(4);
});

// Test: getGitignorePaths excludes tool folders from manifest
it('should exclude tool folder paths from manifest', () => {
  const manifest: ManifestV2 = {
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    files: [
      { path: 'CLAUDE.md', hash: VALID_HASH },
      { path: 'mcp.json', hash: VALID_HASH },
      { path: '.cursor/rules/core.mdc', hash: VALID_HASH },
    ],
    directories: ['.cursor/rules/'],
  };

  const paths = getGitignorePaths(manifest);

  expect(paths).toContain('CLAUDE.md');
  expect(paths).toContain('mcp.json');
  expect(paths).toContain('.ai-tool-sync-generated');
  
  // Should NOT include tool folder paths
  expect(paths).not.toContain('.cursor/rules/');
  expect(paths).not.toContain('.cursor/rules/core.mdc');
});

// Test: updateGitignore creates with root-only paths
it('should create gitignore with only root-level paths', async () => {
  const manifest: ManifestV2 = {
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    files: [
      { path: 'CLAUDE.md', hash: VALID_HASH },
      { path: 'AGENTS.md', hash: VALID_HASH },
      { path: '.cursor/rules/core.mdc', hash: VALID_HASH },
      { path: '.claude/skills/test/SKILL.md', hash: VALID_HASH },
    ],
    directories: ['.cursor/rules/', '.claude/skills/'],
  };

  await updateGitignore(testDir, manifest, { createIfMissing: true });

  const content = await readFile(path.join(testDir, '.gitignore'));
  expect(content.ok).toBe(true);
  if (content.ok) {
    // Root files present
    expect(content.value).toContain('CLAUDE.md');
    expect(content.value).toContain('AGENTS.md');
    expect(content.value).toContain('.ai-tool-sync-generated');
    
    // Tool folders NOT present
    expect(content.value).not.toContain('.cursor/');
    expect(content.value).not.toContain('.claude/');
    expect(content.value).not.toContain('.factory/');
  }
});

// Test: Only includes files present in manifest
it('should only include root files present in manifest', () => {
  const manifest: ManifestV2 = {
    version: '2.0.0',
    timestamp: new Date().toISOString(),
    files: [
      { path: 'CLAUDE.md', hash: VALID_HASH },
      // No AGENTS.md or mcp.json
    ],
    directories: [],
  };

  const paths = getGitignorePaths(manifest);

  expect(paths).toContain('CLAUDE.md');
  expect(paths).toContain('.ai-tool-sync-generated');
  expect(paths).not.toContain('AGENTS.md');
  expect(paths).not.toContain('mcp.json');
});
```

## 7. Integration Points

- **Modifies**:
  - `src/utils/gitignore.ts` - `getDefaultGitignorePaths()` returns root-only paths
  - `src/utils/manifest.ts` - `getGitignorePaths()` excludes tool folder paths

- **No changes needed**:
  - `src/cli/commands/sync.ts` - Already calls the modified functions
  - `src/config/types.ts` - No config option needed
  - `src/schemas/config.schema.json` - No schema changes

## 8. Acceptance Criteria

- [x] `getDefaultGitignorePaths()` returns only root-level files (no tool folders)
- [x] `getGitignorePaths()` returns only root-level files from manifest (no tool folders/directories)
- [x] Root `.gitignore` only contains: `CLAUDE.md`, `AGENTS.md`, `mcp.json`, `.ai-tool-sync-generated`
- [x] Tool folder paths are NOT in root gitignore (managed by T223 per-folder gitignores)
- [x] All tests pass (`npm test -- gitignore.test.ts manifest.test.ts`)
- [x] No lint errors (`npm run lint`)
- [x] Types are strict (no `any`)
- [x] plan.md is updated with completion status

## 9. Out of Scope

- Per-tool gitignore behavior (handled by T223)
- Subfolder context gitignores (potential future task)
- Migration tool for existing projects (managed section auto-updates)

## 10. Implementation Checklist

1. [x] Update `getDefaultGitignorePaths()` in `src/utils/gitignore.ts` to return only root-level files
2. [x] Add `DEFAULT_GENERATED_ROOT_FILES` constant in `src/utils/manifest.ts`
3. [x] Update `getGitignorePaths()` in `src/utils/manifest.ts` to use root-only files
4. [x] Update tests in `tests/unit/utils/gitignore.test.ts` for new behavior
5. [x] Update tests in `tests/unit/utils/manifest.test.ts` for new behavior
6. [x] Run `npm test -- gitignore.test.ts manifest.test.ts`
7. [x] Run `npm run lint --fix`
8. [x] Run `npm run typecheck`
9. [x] Update plan.md with T224 completion status

## 11. Example Output

After implementation, the file structure looks like:

```
project/
├── .gitignore                    # Only contains root-level generated files
├── .ai-tool-sync-generated       # Manifest
├── CLAUDE.md                     # Root entry point
├── AGENTS.md                     # Root entry point
├── mcp.json                      # MCP config
├── .cursor/
│   ├── .gitignore                # From T223: rules/, commands/, hooks.json
│   ├── rules/
│   └── commands/
├── .claude/
│   ├── .gitignore                # From T223: skills/, agents/, commands/, settings.json
│   ├── skills/
│   └── agents/
└── .factory/
    ├── .gitignore                # From T223: skills/, droids/, commands/, mcp.json
    ├── skills/
    └── droids/
```

Root `.gitignore` (simplified, only root-level files):

```gitignore
# User additions (preserved)
node_modules/
dist/

# >>> AI Tool Sync Generated (auto-managed) >>>
.ai-tool-sync-generated
AGENTS.md
CLAUDE.md
mcp.json
# <<< AI Tool Sync Generated <<<
```

Tool folder gitignores (from T223) handle their own paths:
- `.cursor/.gitignore` → `rules/`, `commands/`, `hooks.json`
- `.claude/.gitignore` → `skills/`, `agents/`, `commands/`, `settings.json`
- `.factory/.gitignore` → `skills/`, `droids/`, `commands/`, `mcp.json`
